# Стандартизация Технологического Стека Микросервисов

## 1. Введение

Данный документ определяет стандартизированный технологический стек для всех микросервисов российского аналога платформы Steam. Цель стандартизации — обеспечить согласованность, упростить разработку, тестирование и поддержку, а также повысить эффективность команды разработки.

Стандарты разработаны с учетом использования Go в качестве основного языка программирования для бэкенда, PostgreSQL в качестве основной базы данных и Flutter для фронтенда.

## 2. Основной Технологический Стек

### 2.1. Языки программирования
*   **Бэкенд**: Go (версия 1.21+)
*   **Фронтенд**: Dart (версия 3.0+), Flutter (версия 3.10+)
*   **Скрипты**: Python (версия 3.10+), Bash

### 2.2. Базы данных
*   **Основная СУБД**: PostgreSQL (версия 15+)
*   **Кэширование**: Redis (версия 7.0+)
*   **Поиск**: Elasticsearch (версия 8.0+) или российский аналог
*   **Очереди сообщений**: Kafka (версия 3.0+) или NATS (версия 2.9+)

### 2.3. Инфраструктура
*   **Контейнеризация**: Docker
*   **Оркестрация**: Kubernetes (версия 1.25+)
*   **CI/CD**: GitLab CI/CD или Jenkins
*   **Мониторинг**: Prometheus + Grafana
*   **Логирование**: Fluent Bit + Elasticsearch/ClickHouse + Kibana/Grafana
*   **Трассировка**: OpenTelemetry + Jaeger

## 3. Стандарты Разработки на Go

### 3.1. Версия Go
*   Использовать Go версии 1.21 или выше.
*   Обновлять версию Go не реже одного раза в год.
*   Использовать одну версию Go для всех микросервисов.

### 3.2. Структура проекта
*   Следовать стандартной структуре Go-проекта (см. документ по инфраструктурным файлам).
*   Использовать модули Go (`go.mod`).
*   Разделять код на пакеты по функциональности.

### 3.3. Стиль кода
*   Официальный стиль Go (`gofmt`).
*   Линтеры (`golangci-lint`) с единой конфигурацией.
*   Принципы чистого кода и идиоматического Go.

### 3.4. Обработка ошибок
*   Явная обработка ошибок. Пакет `errors` (например, `github.com/pkg/errors`).
*   Типизированные ошибки для бизнес-логики.
*   Логирование ошибок на верхнем уровне.

### 3.5. Конкурентность
*   Горутины и каналы. Пакет `context`. Пакет `sync`.
*   Избегать глобальных переменных для состояния.

### 3.6. Производительность
*   Пулы ресурсов. Буферизация I/O. Профилирование.

## 4. Стандарты Работы с PostgreSQL

### 4.1. Подключение
*   Пул соединений (например, `pgxpool`). Контекст для таймаутов.

### 4.2. ORM и SQL
*   Основной ORM: GORM (`github.com/go-gorm/gorm`).
*   SQL Builder для сложных запросов (например, `github.com/Masterminds/squirrel`).
*   Прямые запросы: `github.com/jackc/pgx/v5`.
*   Параметризованные запросы.

### 4.3. Миграции
*   `golang-migrate/migrate`. Хранение в репозитории. Автоматическое применение при деплое.

### 4.4. Транзакции
*   Для атомарных операций. Паттерн Unit of Work. Обработка ошибок и откат.

### 4.5. Индексы и оптимизация
*   Индексы для часто используемых полей. `EXPLAIN` для анализа. Частичные индексы. `VACUUM` и `ANALYZE`.

## 5. Стандарты Разработки на Flutter

### 5.1. Версия Flutter и Dart
*   Flutter 3.10+, Dart 3.0+. Обновление не реже раза в полгода.

### 5.2. Архитектура приложения
*   Чистая архитектура (Presentation, Domain, Data). DI (`get_it` или `provider`). Паттерн Repository.

### 5.3. Управление состоянием
*   Основной подход: BLoC (`flutter_bloc`).
*   Альтернативы: Riverpod, Provider, GetX (для прототипов).
*   Предпочтение локальному состоянию. Иммутабельные модели.

### 5.4. Структура проекта (Пример)
```
flutter_app/
├── android/
├── ios/
├── lib/
│   ├── app/         # Настройки, маршруты, темы
│   ├── core/        # Общие компоненты, утилиты
│   ├── data/        # Источники данных, модели, репозитории (реализация)
│   ├── domain/      # Бизнес-логика, сущности, интерфейсы репозиториев, use cases
│   ├── presentation/ # UI (BLoC, страницы, виджеты)
│   ├── di/          # Внедрение зависимостей
│   └── main.dart    # Точка входа
├── test/
└── pubspec.yaml
```

### 5.5. Стиль кода
*   Официальный стиль Dart (`dartfmt`). Линтеры (`dart_code_metrics`, `flutter_lints`). `analysis_options.yaml`.

### 5.6. Работа с API
*   `dio` или `http`. Interceptors. Модели для сериализации/десериализации (`json_serializable` или `freezed`).

### 5.7. Кэширование и локальное хранение
*   `shared_preferences` (простые настройки). `hive` или `sqflite` (данные). `flutter_secure_storage` (чувствительные данные). Стратегия кэширования для оффлайн-режима.

### 5.8. Локализация
*   `flutter_localizations` и `intl`. ARB-файлы. Генерация кода. Поддержка ru, en.

### 5.9. Навигация
*   `go_router` или `auto_route`. Именованные маршруты. Вложенная навигация. Deep links.

### 5.10. Оптимизация производительности
*   `const` конструкторы. `ListView.builder`, `GridView.builder`. `cached_network_image`. `compute` для тяжелых вычислений. Профилирование.

### 5.11. Особенности десктопной разработки
*   Адаптивный дизайн. Десктоп-специфичные виджеты. Оптимизация для мыши/клавиатуры. `flutter_acrylic`. Drag and drop.

## 6. Библиотеки и Фреймворки

### 6.1. HTTP-сервер (Go)
*   **Основной:** Echo (`github.com/labstack/echo/v4`).
*   Альтернативы: Gin, Chi, Fiber.

### 6.2. gRPC (Go)
*   **Основной:** `google.golang.org/grpc`.
*   Генерация: `protoc-gen-go-grpc`. Валидация: `protoc-gen-validate`. Документация: `protoc-gen-doc`.

### 6.3. Работа с базами данных (Go)
*   **PostgreSQL:** ORM GORM, драйвер pgx, миграции golang-migrate.
*   **Redis:** Клиент `go-redis/redis`, кэширование `go-redis/cache`.
*   **Kafka:** Клиент `segmentio/kafka-go`, обработка `ThreeDotsLabs/watermill-kafka`.
*   **NATS:** Клиент `nats-io/nats.go`.

### 6.4. Конфигурация (Go)
*   **Основной:** Viper (`github.com/spf13/viper`).
*   Переменные окружения: `godotenv`. Флаги: `cobra`.

### 6.5. Логирование (Go)
*   **Основной:** Zap (`github.com/uber-go/zap`). JSON-формат.

### 6.6. Трассировка и метрики (Go)
*   OpenTelemetry, Prometheus client, `otelgorm`.

### 6.7. Валидация (Go)
*   `go-playground/validator/v10`.

### 6.8. Авторизация и аутентификация (Go)
*   JWT: `golang-jwt/jwt/v5`. OAuth2: `golang.org/x/oauth2`. RBAC: `casbin/casbin/v2`.

### 6.9. Основные библиотеки Flutter
*   **Состояние:** `flutter_bloc`, `provider`, `riverpod`, `get_it`.
*   **Сеть:** `dio`, `retrofit`, `grpc`, `web_socket_channel`.
*   **Хранение:** `hive`, `sqflite`, `shared_preferences`, `flutter_secure_storage`.
*   **Навигация:** `go_router`, `auto_route`.
*   **UI:** `flutter_screenutil`, `cached_network_image`, `flutter_svg`, `shimmer`.
*   **Аналитика/Мониторинг:** `firebase_crashlytics`, `sentry_flutter`, `flutter_fimber`.
*   **Тестирование:** `mockito`, `bloc_test`, `integration_test`.

### 6.10. Тестирование (Go)
*   `testing`, `testify/mock`, `testify/assert`, `net/http/httptest`, `testcontainers-go`.

## 7. Управление Зависимостями

### 7.1. Версионирование
*   SemVer. Фиксация версий в `go.mod` / `pubspec.yaml`. Регулярное обновление.

### 7.2. Внутренние библиотеки
*   Отдельные репозитории, версионирование.

### 7.3. Управление вендорами (Go)
*   `go mod vendor` (при необходимости). `GOPROXY`.

### 7.4. Управление пакетами (Flutter)
*   `pub get`, `pub upgrade`, `pub outdated`. Стабильные версии.

## 8. Тестирование

### 8.1. Модульные тесты (Go)
*   Для всех публичных функций/методов. Табличные тесты. Моки. Покрытие > 80%.

### 8.2. Интеграционные тесты (Go)
*   `testcontainers`. Взаимодействие с реальными системами. Изоляция.

### 8.3. Нагрузочные тесты (Go)
*   k6. Определение SLO. Включение в CI/CD.

### 8.4. Тестирование Flutter
*   Модульные, виджет-тесты, интеграционные, скриншот-тесты, тестирование производительности.

### 8.5. Тестирование в CI/CD
*   Запуск всех тестов. Блокировка мержа при падении. Отчеты о покрытии. Матрицы тестирования.

## 9. Документация

### 9.1. Документация кода (Go)
*   godoc. Примеры использования. Генерация `go doc` / `godoc`.

### 9.2. Документация кода (Flutter)
*   dartdoc. Примеры. Генерация `dart doc`.

### 9.3. API-документация
*   OpenAPI (Swagger) для REST. `protoc-gen-doc` для gRPC. Хранение в репозитории. Автогенерация.

### 9.4. Документация для разработчиков
*   README.md (установка, запуск). Архитектура, компоненты. Процессы разработки.

## 10. Заключение

Стандартизация технологического стека важна для согласованности, упрощения разработки и поддержки. Выбор Go для бэкенда, PostgreSQL для БД и Flutter для фронтенда обеспечивает производительность и кроссплатформенность. Следование данным стандартам обеспечит высокое качество и масштабируемость платформы. Стандарты должны регулярно пересматриваться.

# Стандарты Безопасности

## 1. Введение

Данный документ определяет единые стандарты безопасности для российского аналога платформы Steam. Цель документа — обеспечить согласованный подход к обеспечению безопасности всех микросервисов платформы.

## 2. Стандарты Безопасности

### 2.1. Аутентификация и Авторизация

#### 2.1.1. Аутентификация пользователей
*   **Протокол**: OAuth 2.0 с OpenID Connect.
*   **Токены**: JWT (JSON Web Tokens).
*   **Хранение токенов**:
    *   Access token: в памяти клиента (не в localStorage/cookies).
    *   Refresh token: в HttpOnly, Secure, SameSite=Strict cookie.
*   **Срок действия токенов**:
    *   Access token: 15 минут.
    *   Refresh token: 7 дней.
*   **Ротация refresh токенов**: при каждом использовании.
*   **Библиотека для Go**: `github.com/golang-jwt/jwt/v5`.

#### 2.1.2. Авторизация
*   **Модель**: RBAC (Role-Based Access Control).
*   **Проверка прав**: на уровне API Gateway и внутри каждого микросервиса.
*   **Формат передачи информации о ролях**:
    *   В JWT-токене: поле `roles` с массивом строк.
    *   В заголовках между сервисами: `X-User-Roles`.
*   **Библиотека для Go**: `github.com/casbin/casbin/v2`.

#### 2.1.3. Межсервисная аутентификация
*   **Протокол**: mTLS (mutual TLS).
*   **Сертификаты**: выдаются внутренним CA (Certificate Authority).
*   **Срок действия сертификатов**: 90 дней с автоматическим обновлением.
*   **Библиотека для Go**: стандартная библиотека `crypto/tls`.

#### 2.1.4. Защита API
*   **Rate limiting**: на уровне API Gateway.
    *   Глобальный лимит: 1000 запросов в минуту на IP.
    *   Лимит для аутентифицированных пользователей: 100 запросов в минуту на пользователя.
    *   Лимит для критичных эндпоинтов (аутентификация, платежи): 10 запросов в минуту.
*   **Защита от CSRF**: для всех модифицирующих операций (POST, PUT, DELETE).
    *   Double Submit Cookie pattern.
    *   Библиотека для Go: `github.com/gorilla/csrf`.
*   **Защита от XSS**:
    *   Content-Security-Policy (CSP) заголовки.
    *   Экранирование всех пользовательских данных при выводе.
*   **Защита от SQL-инъекций**:
    *   Использование параметризованных запросов.
    *   ORM: `github.com/go-gorm/gorm`.
*   **Защита от DDOS**:
    *   WAF (Web Application Firewall) на уровне инфраструктуры.
    *   Cloudflare или российский аналог.

### 2.2. Шифрование Данных

#### 2.2.1. Данные в движении (Data in Transit)
*   **Протокол**: TLS 1.3.
*   **Минимальный уровень шифрования**: `TLS_AES_128_GCM_SHA256`.
*   **Настройка HTTPS**: HSTS, secure cookies, правильные cipher suites.

#### 2.2.2. Данные в покое (Data at Rest)
*   **Шифрование базы данных**: на уровне файловой системы (LUKS).
*   **Шифрование чувствительных данных в БД**:
    *   Пароли: bcrypt с фактором стоимости 12.
    *   Платежная информация: AES-256-GCM.
    *   Библиотека для Go: `golang.org/x/crypto/bcrypt` (для паролей пользователей), Argon2id (предпочтительно для новых реализаций хеширования паролей, как указано в Auth Service).
*   **Шифрование файлов**: AES-256-GCM для хранимых файлов игр (Download Service), игровых сохранений (Library Service), и других чувствительных файлов.
*   **Фискальные данные:** Особое внимание к защите данных, передаваемых в ОФД, и ключей для фискализации (Payment Service).

#### 2.2.3. Управление секретами
*   **Хранение секретов**: HashiCorp Vault или Kubernetes Secrets (зашифрованные).
*   **Доступ к секретам**: Через API Vault с аутентификацией (например, Kubernetes Service Account JWT) или через смонтированные Kubernetes Secrets.
*   **Ротация секретов**: Регулярная, автоматизированная где возможно (например, для ключей API внешних сервисов). Период ротации зависит от типа секрета (например, ключи API платежных систем - раз в год или по требованию провайдера; внутренние ключи шифрования - раз в 1-2 года).
*   **Библиотека для Go**: `github.com/hashicorp/vault/api` (для Vault), стандартные средства Kubernetes для Secrets.

### 2.3. Безопасность Кода и Инфраструктуры

#### 2.3.1. Статический анализ кода
*   **Инструменты для Go**:
    *   `gosec` для анализа безопасности.
    *   `golangci-lint` для общего анализа кода.
*   **Интеграция**: в CI/CD pipeline, блокирование сборки при критических уязвимостях.

#### 2.3.2. Сканирование зависимостей
*   **Инструменты**:
    *   `nancy` для Go-зависимостей.
    *   `trivy` для образов Docker.
*   **Интеграция**: в CI/CD pipeline, блокирование сборки при критических уязвимостях.

#### 2.3.3. Безопасность контейнеров
*   **Базовые образы**: минимальные образы (scratch, alpine).
*   **Пользователь**: запуск от непривилегированного пользователя.
*   **Сканирование**: перед деплоем в любое окружение.
*   **Иммутабельность**: запрет на изменение запущенных контейнеров.

#### 2.3.4. Безопасность Kubernetes
*   **RBAC**: строгое разграничение прав.
*   **Network Policies**: изоляция сетевого трафика между подами.
*   **Pod Security Policies**: запрет на привилегированные контейнеры.
*   **Secrets**: шифрование секретов в etcd.

### 2.4. Аудит Безопасности

#### 2.4.1. Логирование событий безопасности
*   **События для логирования**:
    *   Все попытки аутентификации (успешные и неуспешные).
    *   Изменения прав доступа.
    *   Доступ к чувствительным данным.
    *   Изменения в конфигурации системы.
*   **Формат логов**: JSON с обязательными полями (см. Стандарты Логирования).

#### 2.4.2. Мониторинг безопасности
*   **Инструменты**:
    *   SIEM-система (Security Information and Event Management).
    *   IDS/IPS (Intrusion Detection/Prevention System).
*   **Метрики**:
    *   Количество неудачных попыток аутентификации.
    *   Аномальная активность пользователей.
    *   Подозрительные запросы к API.

#### 2.4.3. Регулярные проверки
*   **Penetration testing**: каждые 6 месяцев.
*   **Vulnerability assessment**: каждые 3 месяца.
*   **Compliance check**: каждый месяц.

---
*Раздел "Стандарты безопасности" извлечен из документа "(Дополнительный фаил) Стандарты безопасности, мониторинга, логирования и трассировки.txt".*
*Этот документ должен регулярно обновляться и дополняться по мере развития платформы и изменения ландшафта угроз.*

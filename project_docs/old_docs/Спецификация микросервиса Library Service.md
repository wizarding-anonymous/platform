# Обновленная Спецификация микросервиса Library Service

**Версия:** 1.1
**Дата последнего обновления:** 2025-05-22

**История изменений:**
- 1.0 (Дата): Первоначальная версия
- 1.1 (2025-05-22): Полное обновление в соответствии с едиными стандартами, глоссарием, аудитом интеграций и требованиями к Flutter-клиенту.

## Содержание

1. [Глоссарий](#1-глоссарий)
2. [Требования и цели](#2-требования-и-цели)
3. [Архитектура](#3-архитектура)
4. [Бизнес-логика и сценарии использования](#4-бизнес-логика-и-сценарии-использования)
5. [Структура данных и API](#5-структура-данных-и-api)
6. [Интеграции с другими микросервисами и внешними системами](#6-интеграции-с-другими-микросервисами-и-внешними-системами)
7. [Требования к безопасности, масштабируемости и отказоустойчивости](#7-требования-к-безопасности-масштабируемости-и-отказоустойчивости)
8. [Мониторинг, логирование и трассировка](#8-мониторинг-логирование-и-трассировка)
9. [Рекомендации по реализации и развертыванию](#9-рекомендации-по-реализации-и-развертыванию)
10. [Роли и права доступа](#10-роли-и-права-доступа)
11. [Обработка событий](#11-обработка-событий)
12. [Документация](#12-документация)
13. [Особенности взаимодействия с Flutter-клиентом](#13-особенности-взаимодействия-с-flutter-клиентом)
14. [Ссылки на связанные документы](#14-ссылки-на-связанные-документы)

## 1. Глоссарий

| Термин | Определение |
|---|---|
| Библиотека (Library) | Коллекция игр и продуктов, приобретенных конкретным пользователем. |
| Игра (Game) | Программный продукт, распространяемый через платформу. Имеет уникальный идентификатор (game_id). |
| Приложение (Application) | Программный продукт, не являющийся игрой, но распространяемый через платформу. |
| DLC (Downloadable Content) | Дополнительный контент к игре, распространяемый отдельно или в составе комплектов. |
| Игровое время (Playtime) | Время, проведенное пользователем в игре, измеряемое в секундах. |
| Достижение (Achievement) | Награда за выполнение определенных действий или достижение целей в игре. |
| Список желаемого (Wishlist) | Список игр, которые пользователь хотел бы приобрести. |
| Сохранение (Savegame) | Файл или набор файлов, содержащий информацию о прогрессе пользователя в игре. |
| Семейный доступ (Family Sharing) | Функция, позволяющая делиться играми с ограниченным числом пользователей. |
| Сессия (Session) | Период активности пользователя в игре между запуском и завершением. |
| Категория (Category) | Пользовательская группировка игр в библиотеке. |
| Коллекция (Collection) | Набор игр, объединенных по определенному признаку (может быть как пользовательским, так и системным). |
| Пользователь (User) | Зарегистрированный участник платформы. |
| Имя пользователя (Username) | Уникальный идентификатор пользователя для входа в систему. |
| Отображаемое имя (Display Name) | Имя пользователя, видимое другим участникам платформы. |
| Токен доступа (Access Token) | Временный криптографический ключ (JWT) для доступа к API. |
| Событие (Event) | Уведомление о произошедшем изменении состояния в системе, передаваемое через Kafka. |
| API Gateway | Единая точка входа для клиентских приложений, маршрутизирующая запросы к микросервисам. |
| Flutter-клиент | Клиентское приложение, разработанное на Flutter, для доступа к платформе с различных устройств. |
| Облачное хранилище | S3-совместимое хранилище для файлов сохранений (например, Yandex Object Storage, VK Cloud). |

## 2. Требования и цели

### 2.1 Назначение сервиса

Library Service предназначен для управления личными библиотеками пользователей в рамках российского аналога Steam. Сервис является центральным компонентом платформы, обеспечивающим доступ пользователей к приобретенным играм и приложениям, отслеживание игрового времени, управление достижениями и синхронизацию сохранений.

### 2.2 Основные цели

1. Обеспечение надежного и эффективного управления библиотеками игр и приложений пользователей.
2. Точное отслеживание игрового времени и активности пользователей.
3. Управление системой достижений и прогресса в играх.
4. Обеспечение синхронизации сохранений между устройствами пользователя через облачное хранилище.
5. Предоставление пользователям информации о статусе и доступности их игр и приложений.
6. Интеграция с другими сервисами для обеспечения целостного пользовательского опыта.
7. Предоставление API для взаимодействия с Flutter-клиентом и другими микросервисами.

### 2.3 Функциональные требования

#### 2.3.1 Управление библиотекой пользователя

- Добавление игр/приложений в библиотеку пользователя после покупки или получения иным способом (подарок, подписка).
- Отображение списка игр/приложений, доступных пользователю.
- Фильтрация и сортировка игр/приложений в библиотеке (по названию, дате добавления, игровому времени, статусу установки и т.д.).
- Управление пользовательскими категориями и коллекциями игр/приложений.
- Отслеживание статуса установки игр/приложений (не установлено, устанавливается, установлено, обновляется).
- Управление скрытыми играми/приложениями.
- Поддержка семейного доступа к играм.

#### 2.3.2 Отслеживание игрового времени

- Регистрация начала и окончания игровых сессий.
- Подсчет общего игрового времени для каждой игры (в секундах).
- Сбор статистики по игровым сессиям (частота, продолжительность).
- Формирование отчетов об игровой активности.
- Отслеживание последней активности в игре.
- Синхронизация игрового времени между устройствами.
- Обнаружение неактивных сессий (AFK).

#### 2.3.3 Управление достижениями

- Регистрация достижений, полученных пользователем.
- Хранение прогресса по достижениям.
- Отображение списка доступных и полученных достижений.
- Расчет общего процента выполнения достижений.
- Уведомление других сервисов (Social, Notification) о получении достижений.
- Синхронизация достижений между устройствами.
- Валидация полученных достижений для предотвращения мошенничества.

#### 2.3.4 Управление списком желаемого

- Добавление игр/приложений в список желаемого.
- Удаление игр/приложений из списка желаемого.
- Приоритизация элементов в списке.
- Уведомление пользователя о скидках на игры/приложения из списка (через Notification Service).
- Автоматическое удаление игр/приложений из списка после покупки.

#### 2.3.5 Синхронизация сохранений

- Загрузка сохранений в облачное хранилище (S3-совместимое).
- Скачивание сохранений из облачного хранилища.
- Разрешение конфликтов при синхронизации (стратегия должна быть настраиваемой).
- Управление версиями сохранений (хранение нескольких последних версий).
- Автоматическая синхронизация при запуске и завершении игры.
- Ручное управление синхронизацией.
- Управление квотами на облачное хранилище для сохранений.

#### 2.3.6 Настройки игр

- Хранение пользовательских настроек для каждой игры (например, настройки графики, управления).
- Синхронизация настроек между устройствами.
- Управление параметрами запуска игр.
- Настройка контроллеров и устройств ввода для игр (если применимо).

### 2.4 Нефункциональные требования

#### 2.4.1 Производительность

- Время отклика REST API: P95 < 100 мс, P99 < 200 мс (для основных запросов).
- Время отклика gRPC API: P95 < 50 мс, P99 < 100 мс.
- Пропускная способность: не менее 5000 запросов в секунду (суммарно REST и gRPC).
- Минимальная задержка при регистрации игрового времени и достижений (< 1 сек).
- Эффективное использование ресурсов при синхронизации сохранений (минимизация трафика и нагрузки на CPU/память).

#### 2.4.2 Масштабируемость

- Горизонтальное масштабирование для обработки пиковых нагрузок (поддержка Kubernetes HPA).
- Поддержка не менее 10 миллионов активных пользователей.
- Возможность обработки не менее 100 миллионов игровых сессий в день.
- Адаптация к различным объемам данных сохранений (до петабайтов).

#### 2.4.3 Надежность

- Доступность: 99.99% (не более 4.38 минут простоя в месяц).
- Устойчивость к сбоям сети и отказам компонентов (других микросервисов, баз данных, хранилища).
- Автоматическое восстановление после ошибок.
- Резервное копирование данных библиотеки, достижений, игрового времени и метаданных сохранений (PostgreSQL).
- Резервное копирование файлов сохранений в облачном хранилище.
- Время восстановления после сбоя (RTO): < 15 минут.
- Допустимая точка восстановления (RPO): < 5 минут.

#### 2.4.4 Безопасность

- Защита от несанкционированного доступа к библиотеке, достижениям, игровому времени и сохранениям пользователя.
- Проверка прав доступа пользователя к играм и операциям API (согласно разделу "Роли и права доступа").
- Защита данных сохранений от повреждения и несанкционированного доступа.
- Шифрование передаваемых данных (TLS 1.2+).
- Шифрование чувствительных данных при хранении (если применимо).
- Защита от подделки достижений и игрового времени (механизмы валидации).
- Аутентификация и авторизация всех запросов (JWT).
- Соответствие стандартам безопасности платформы.

## 3. Архитектура

### 3.1 Общая архитектура

Library Service построен на основе многослойной архитектуры, соответствующей стандартам платформы и использующей принципы чистой архитектуры (Clean Architecture). Архитектура обеспечивает четкое разделение ответственности, масштабируемость, тестируемость и поддержку высоких нагрузок.

#### 3.1.1 Архитектурные слои

1.  **Транспортный слой (Transport Layer)**
    *   REST API (Echo) для взаимодействия с API Gateway (и далее с Flutter-клиентом).
    *   gRPC API для синхронного взаимодействия с другими микросервисами.
    *   Обработчики событий Kafka для асинхронного взаимодействия.
    *   WebSocket (через API Gateway) для уведомлений клиента в реальном времени.

2.  **Сервисный слой (Use Case/Application Layer)**
    *   Реализация бизнес-логики и сценариев использования.
    *   Оркестрация взаимодействия между компонентами домена и репозиториями.
    *   Обработка бизнес-правил и валидация входных данных.

3.  **Доменный слой (Domain Layer)**
    *   Определение основных бизнес-сущностей (агрегатов), их состояний и поведения.
    *   Бизнес-правила, не зависящие от внешних систем.

4.  **Инфраструктурный слой (Infrastructure Layer)**
    *   **Репозиторный слой (Repository Layer)**:
        *   Реализация интерфейсов репозиториев для доступа к данным (PostgreSQL, Redis).
        *   Абстракция доступа к данным.
    *   **Клиенты внешних сервисов**:
        *   Клиенты для взаимодействия с другими микросервисами (gRPC).
        *   Клиенты для взаимодействия с облачным хранилищем (S3 SDK).
        *   Клиенты для работы с Kafka (продюсеры/консьюмеры).
    *   **Вспомогательные компоненты**:
        *   Логирование (zap).
        *   Мониторинг и метрики (Prometheus).
        *   Трассировка (Jaeger).
        *   Конфигурация.

#### 3.1.2 Структура проекта (Go)

```
library-service/
├── api/                      # API контракты
│   ├── gen/                  # Сгенерированный код
│   │   └── v1/               # Версия API v1
│   │       ├── library_grpc.pb.go
│   │       └── library.pb.go
│   ├── proto/                # Protobuf определения
│   │   └── v1/
│   │       └── library.proto
│   └── openapi/              # OpenAPI спецификации
│       └── v1/
│           └── library.yaml
├── cmd/                      # Точки входа
│   └── app/                  # Основное приложение
│       └── main.go
├── configs/                  # Конфигурационные файлы (примеры)
│   └── config.yaml
├── deployments/              # Файлы для развертывания
│   ├── Dockerfile
│   └── kubernetes/
│       ├── deployment.yaml
│       ├── service.yaml
│       └── ...
├── internal/                 # Внутренний код приложения
│   ├── app/                  # Инициализация и запуск приложения
│   ├── config/               # Работа с конфигурацией
│   ├── domain/               # Доменные сущности и логика
│   │   ├── achievement/
│   │   ├── library/
│   │   ├── playtime/
│   │   ├── savegame/
│   │   └── wishlist/
│   ├── infrastructure/       # Инфраструктурный слой
│   │   ├── cache/            # Реализация кэша (Redis)
│   │   ├── clients/          # Клиенты внешних сервисов (gRPC)
│   │   ├── eventbus/         # Работа с Kafka
│   │   ├── persistence/      # Реализация репозиториев (PostgreSQL)
│   │   ├── storage/          # Работа с облачным хранилищем (S3)
│   │   └── ...
│   ├── interfaces/           # Интерфейсы слоев (репозитории, сервисы)
│   ├── usecase/              # Сервисный слой (сценарии использования)
│   │   ├── achievement/
│   │   ├── library/
│   │   ├── playtime/
│   │   ├── savegame/
│   │   └── wishlist/
│   └── transport/            # Транспортный слой
│       ├── grpc/             # gRPC обработчики
│       ├── kafka/            # Kafka консьюмеры
│       └── rest/             # REST обработчики (Echo)
├── migrations/               # Миграции базы данных (golang-migrate)
├── pkg/                      # Общие пакеты (утилиты, ошибки и т.д.)
├── test/                     # Тесты
│   ├── integration/
│   └── unit/
├── go.mod
├── go.sum
└── README.md
```

### 3.2 Компоненты системы

(Основные компоненты остаются те же, но описание должно быть приведено в соответствие с новой структурой и терминологией)

#### 3.2.1 Компонент управления библиотекой (Library Manager)

**Назначение**: Управление библиотекой игр и приложений пользователя.
**Ключевые функции**: Добавление/скрытие игр, управление доступом, категоризация, отслеживание статуса установки, семейный доступ.
**Взаимодействие**: Payment Service (события покупок), Catalog Service (метаданные), Download Service (статус установки), Account Service (данные пользователя).

#### 3.2.2 Компонент отслеживания игрового времени (Playtime Tracker)

**Назначение**: Отслеживание и управление игровым временем пользователей.
**Ключевые функции**: Регистрация сессий, подсчет времени, статистика, синхронизация.
**Взаимодействие**: Клиентское приложение (данные сессий), Social Service (статистика), Analytics Service (аналитика).

#### 3.2.3 Компонент управления достижениями (Achievement Manager)

**Назначение**: Управление системой достижений пользователей.
**Ключевые функции**: Регистрация достижений, отслеживание прогресса, статистика, валидация.
**Взаимодействие**: Клиентское приложение (получение достижений), Catalog Service (метаданные достижений), Social Service (уведомления), Analytics Service (статистика).

#### 3.2.4 Компонент управления списком желаемого (Wishlist Manager)

**Назначение**: Управление списком желаемых игр и приложений пользователя.
**Ключевые функции**: Добавление/удаление, приоритизация, отслеживание скидок, автоматическое обновление.
**Взаимодействие**: Catalog Service (метаданные, скидки), Payment Service (обновление после покупки), Notification Service (уведомления).

#### 3.2.5 Компонент управления сохранениями (Savegame Manager)

**Назначение**: Управление облачными сохранениями игр.
**Ключевые функции**: Загрузка/скачивание, разрешение конфликтов, версионирование.
**Взаимодействие**: Клиентское приложение (передача файлов), Облачное хранилище (хранение), Catalog Service (метаданные игр).

### 3.3 Хранилища данных

#### 3.3.1 PostgreSQL (Версия 15+)

**Назначение**: Основное реляционное хранилище для структурированных данных.
**Хранимые данные**: Библиотеки пользователей, достижения, статистика игрового времени, списки желаемого, метаданные сохранений, настройки игр, пользовательские категории, информация о семейном доступе.
**Основные таблицы** (названия и структура согласно стандартам):
- `user_libraries`
- `user_achievements`
- `playtime_sessions`
- `playtime_stats`
- `wishlists`
- `savegame_metadata`
- `game_settings`
- `user_game_categories`
- `family_sharing_links`

#### 3.3.2 Redis (Версия 7+)

**Назначение**: Кэширование часто запрашиваемых данных и хранение временных/оперативных данных.
**Хранимые данные**: Кэш библиотек пользователей, текущие игровые сессии (для быстрого доступа), временные токены доступа к облачному хранилищу, счетчики игрового времени (промежуточные), статусы синхронизации сохранений.
**Структуры данных**: Хеш-таблицы, Списки, Строки, Счетчики.

#### 3.3.3 Облачное хранилище (S3-совместимое)

**Назначение**: Хранение бинарных файлов сохранений игр.
**Хранимые данные**: Файлы сохранений, версии сохранений.
**Организация**: Структура бакетов и префиксов по `user_id` и `game_id`. Использование версионирования объектов. Настройка политик жизненного цикла (lifecycle policies) для удаления старых версий.

### 3.4 Потоки данных

(Потоки данных остаются концептуально схожими, но должны быть обновлены с учетом использования gRPC для синхронных вызовов и Kafka для асинхронных событий, а также новой терминологии и стандартов API/событий)

#### 3.4.1 Поток добавления игры в библиотеку (после покупки)

1. Payment Service публикует событие `payment.purchase.completed` в Kafka.
2. Library Service (Kafka консьюмер) получает событие.
3. Library Service валидирует событие и извлекает `user_id` и `game_id`.
4. Library Service вызывает Catalog Service (gRPC) для получения метаданных игры.
5. Library Service добавляет запись в таблицу `user_libraries` (PostgreSQL).
6. Library Service публикует событие `library.game.added` в Kafka.
7. Library Service опционально отправляет уведомление пользователю через Notification Service (публикуя событие для него или вызывая его API).
8. API Gateway (получив `library.game.added` или через WebSocket) уведомляет Flutter-клиент.

#### 3.4.2 Поток отслеживания игрового времени

1. Flutter-клиент отправляет REST-запрос `/api/v1/library/playtime/start` при начале сессии.
2. Library Service регистрирует начало сессии в Redis и/или PostgreSQL.
3. Flutter-клиент периодически отправляет REST-запросы `/api/v1/library/playtime/heartbeat`.
4. Flutter-клиент отправляет REST-запрос `/api/v1/library/playtime/end` при завершении сессии.
5. Library Service рассчитывает продолжительность, обновляет статистику в PostgreSQL (`playtime_stats`).
6. Library Service публикует событие `library.playtime.updated` в Kafka.
7. Analytics Service и Social Service (консьюмеры Kafka) получают событие и обновляют свои данные.

#### 3.4.3 Поток регистрации достижения

1. Flutter-клиент (получив сигнал от игры через SDK) отправляет REST-запрос `/api/v1/library/achievements/unlock`.
2. Library Service валидирует запрос (проверка прав, существования достижения из Catalog Service, предотвращение дублирования).
3. Library Service регистрирует достижение в PostgreSQL (`user_achievements`).
4. Library Service обновляет статистику достижений.
5. Library Service публикует событие `library.achievement.unlocked` в Kafka.
6. Social Service и Notification Service (консьюмеры Kafka) получают событие для обновления ленты и отправки уведомлений.
7. API Gateway уведомляет Flutter-клиент через WebSocket.

#### 3.4.4 Поток синхронизации сохранений (загрузка)

1. Flutter-клиент отправляет REST-запрос `/api/v1/library/savegames/upload-url` для получения URL для загрузки.
2. Library Service проверяет квоту, генерирует pre-signed URL для S3-хранилища с коротким временем жизни.
3. Library Service возвращает URL клиенту.
4. Flutter-клиент загружает файл сохранения напрямую в облачное хранилище по полученному URL.
5. Flutter-клиент отправляет REST-запрос `/api/v1/library/savegames/confirm-upload` с метаданными загруженного файла.
6. Library Service обновляет метаданные сохранения в PostgreSQL (`savegame_metadata`), обрабатывает версионирование и конфликты.
7. Library Service публикует событие `library.savegame.synchronized` в Kafka.

## 4. Бизнес-логика и сценарии использования

(Раздел сохраняет свою структуру, но требует обновления терминологии и деталей в соответствии со стандартами и новыми функциональными требованиями)

### 4.1 Основные бизнес-процессы

#### 4.1.1 Управление библиотекой игр

**Описание**: Процесс управления играми и приложениями, доступными пользователю.
**Бизнес-правила**: Добавление после покупки/получения, организация по категориям, скрытие (не удаление), правила семейного доступа (один активный пользователь на игру).
**Метрики**: Количество игр/приложений, частота использования, использование категорий, использование семейного доступа.

#### 4.1.2 Отслеживание игрового времени

**Описание**: Процесс регистрации и анализа времени, проведенного пользователем в играх.
**Бизнес-правила**: Регистрация только активных сессий, обнаружение AFK, синхронизация между устройствами, обработка потери соединения, время в секундах.
**Метрики**: Общее время, средняя/макс продолжительность сессии, частота сессий, распределение по играм.

#### 4.1.3 Управление достижениями

**Описание**: Процесс регистрации и отслеживания достижений пользователя в играх.
**Бизнес-правила**: Регистрация при выполнении условий, валидация (предотвращение мошенничества), синхронизация, сохранение прогресса, скрытые достижения.
**Метрики**: % выполнения, скорость получения, редкость, популярность.

#### 4.1.4 Управление списком желаемого

**Описание**: Процесс управления списком игр/приложений, которые пользователь хочет приобрести.
**Бизнес-правила**: Безлимитное добавление, автоудаление после покупки, приоритеты, уведомления о скидках, приватность списка.
**Метрики**: Размер списка, конверсия в покупки, время в списке, эффективность уведомлений.

#### 4.1.5 Синхронизация сохранений

**Описание**: Процесс синхронизации файлов сохранений игр между устройствами через облако.
**Бизнес-правила**: Автосинхронизация (опционально), разрешение конфликтов (стратегии), версионирование, управление квотами.
**Метрики**: Объем данных, частота синхронизаций, кол-во конфликтов, использование квоты.

### 4.2 Пользовательские сценарии

(Сценарии остаются прежними, но должны быть обновлены с учетом новых API эндпоинтов, использования gRPC/Kafka, Flutter-клиента и терминологии)

#### 4.2.1 Просмотр библиотеки игр

**Участники**: Пользователь, Flutter-клиент, API Gateway, Library Service, Catalog Service.
**Основной поток**: Клиент -> API Gateway (REST GET `/api/v1/library`) -> Library Service -> Catalog Service (gRPC) -> Library Service (формирует ответ) -> API Gateway -> Клиент.

#### 4.2.2 Запуск игры и отслеживание игрового времени

**Участники**: Пользователь, Flutter-клиент, API Gateway, Library Service, Download Service.
**Основной поток**: Клиент -> API Gateway (REST POST `/api/v1/library/playtime/start`) -> Library Service. ... Игра ... Клиент -> API Gateway (REST POST `/api/v1/library/playtime/end`) -> Library Service -> Публикация события `library.playtime.updated`.

#### 4.2.3 Получение достижения

**Участники**: Пользователь, Игра (SDK), Flutter-клиент, API Gateway, Library Service, Social Service, Notification Service.
**Основной поток**: Клиент -> API Gateway (REST POST `/api/v1/library/achievements/unlock`) -> Library Service -> Валидация -> Запись в БД -> Публикация события `library.achievement.unlocked` -> Уведомление клиента через WebSocket.

#### 4.2.4 Синхронизация сохранений (загрузка)

**Участники**: Пользователь, Flutter-клиент, API Gateway, Library Service, Облачное хранилище.
**Основной поток**: Клиент -> API Gateway (REST POST `/api/v1/library/savegames/upload-url`) -> Library Service (генерирует pre-signed URL) -> Клиент -> Клиент загружает в Облачное хранилище -> Клиент -> API Gateway (REST POST `/api/v1/library/savegames/confirm-upload`) -> Library Service -> Публикация события `library.savegame.synchronized`.

#### 4.2.5 Управление списком желаемого

**Участники**: Пользователь, Flutter-клиент, API Gateway, Library Service, Catalog Service.
**Основной поток**: Клиент -> API Gateway (REST POST `/api/v1/library/wishlist`) -> Library Service -> Запись в БД -> Публикация события `library.wishlist.updated`.

## 5. Структура данных и API

### 5.1 Модели данных (Основные сущности)

(Модели должны быть приведены в соответствие со стандартами: UUID v4, ISO 8601, время в секундах, единые названия полей)

#### 5.1.1 UserLibraryItem

```json
{
  "id": "uuid", // ID записи в библиотеке
  "user_id": "uuid",
  "game_id": "uuid",
  "acquisition_date": "string($date-time)", // ISO 8601
  "acquisition_type": "string", // enum: purchase, gift, subscription, free
  "is_hidden": "boolean",
  "is_favorite": "boolean",
  "last_played_at": "string($date-time)", // ISO 8601
  "total_playtime_seconds": "integer",
  "installation_status": "string", // enum: not_installed, installing, installed, updating, failed
  "platform": "string", // enum: windows, macos, linux, android, ios
  "categories": ["string"], // Пользовательские категории
  "notes": "string",
  "created_at": "string($date-time)", // ISO 8601
  "updated_at": "string($date-time)" // ISO 8601
}
```

#### 5.1.2 PlaytimeSession

```json
{
  "id": "uuid",
  "user_id": "uuid",
  "game_id": "uuid",
  "start_time": "string($date-time)", // ISO 8601
  "end_time": "string($date-time)", // ISO 8601, null для активных
  "duration_seconds": "integer", // null для активных
  "device_id": "string",
  "platform": "string", // enum: windows, macos, linux, android, ios
  "is_active": "boolean",
  "created_at": "string($date-time)", // ISO 8601
  "updated_at": "string($date-time)" // ISO 8601
}
```

#### 5.1.3 UserAchievement

```json
{
  "id": "uuid",
  "user_id": "uuid",
  "achievement_id": "uuid", // Ссылка на достижение в Catalog Service
  "game_id": "uuid",
  "unlocked_at": "string($date-time)", // ISO 8601
  "progress": "integer", // Для достижений с прогрессом
  "is_unlocked": "boolean",
  "created_at": "string($date-time)", // ISO 8601
  "updated_at": "string($date-time)" // ISO 8601
}
```

#### 5.1.4 WishlistItem

```json
{
  "id": "uuid",
  "user_id": "uuid",
  "game_id": "uuid",
  "added_at": "string($date-time)", // ISO 8601
  "priority": "integer",
  "notes": "string",
  "created_at": "string($date-time)", // ISO 8601
  "updated_at": "string($date-time)" // ISO 8601
}
```

#### 5.1.5 SavegameMetadata

```json
{
  "id": "uuid",
  "user_id": "uuid",
  "game_id": "uuid",
  "save_name": "string", // Имя слота сохранения
  "timestamp": "string($date-time)", // Время создания сохранения
  "version": "integer", // Версия сохранения
  "file_key": "string", // Ключ файла в S3
  "file_size_bytes": "integer",
  "device_id": "string",
  "platform": "string",
  "is_latest": "boolean",
  "created_at": "string($date-time)", // ISO 8601
  "updated_at": "string($date-time)" // ISO 8601
}
```

### 5.2 REST API (v1)

**Базовый URL**: `/api/v1/library`
**Аутентификация**: JWT Bearer Token
**Формат ответа**: Стандартный JSON (`status`, `data`, `error`)
**Спецификация**: `/api/openapi/v1/library.yaml` (OpenAPI 3.0)

**Основные эндпоинты**:

*   **Библиотека**
    *   `GET /` - Получить библиотеку текущего пользователя (с фильтрацией, сортировкой, пагинацией)
    *   `GET /{game_id}` - Получить информацию о конкретной игре в библиотеке
    *   `PATCH /{game_id}` - Обновить метаданные игры в библиотеке (скрыть, добавить в избранное, категории)
*   **Игровое время**
    *   `POST /playtime/start` - Начать игровую сессию
    *   `POST /playtime/heartbeat` - Отправить пульсацию активной сессии
    *   `POST /playtime/end` - Завершить игровую сессию
    *   `GET /playtime/stats` - Получить статистику игрового времени (общую и по играм)
*   **Достижения**
    *   `GET /achievements` - Получить достижения пользователя (с фильтрацией по игре)
    *   `POST /achievements/unlock` - Зарегистрировать получение достижения (вызывается клиентом)
*   **Список желаемого**
    *   `GET /wishlist` - Получить список желаемого
    *   `POST /wishlist` - Добавить игру в список желаемого
    *   `DELETE /wishlist/{game_id}` - Удалить игру из списка желаемого
    *   `PATCH /wishlist/{game_id}` - Обновить элемент списка (приоритет, заметки)
*   **Сохранения**
    *   `GET /savegames` - Получить метаданные сохранений (с фильтрацией по игре)
    *   `POST /savegames/upload-url` - Получить URL для загрузки сохранения
    *   `POST /savegames/confirm-upload` - Подтвердить загрузку сохранения
    *   `POST /savegames/download-url` - Получить URL для скачивания сохранения
    *   `DELETE /savegames/{save_id}` - Удалить сохранение
*   **Настройки игр**
    *   `GET /settings/{game_id}` - Получить настройки для игры
    *   `PUT /settings/{game_id}` - Сохранить настройки для игры

*(Полное описание эндпоинтов, параметров, запросов, ответов и кодов ошибок должно быть в OpenAPI спецификации)*

### 5.3 gRPC API (v1)

**Назначение**: Для синхронного межсервисного взаимодействия.
**Спецификация**: `/api/proto/v1/library.proto`

**Сервисы и методы**:

*   **LibraryQueryService**
    *   `GetLibrary(GetUserLibraryRequest) returns (GetUserLibraryResponse)` - Получить библиотеку пользователя (для внутренних нужд, например, Download Service)
    *   `CheckGameAccess(CheckGameAccessRequest) returns (CheckGameAccessResponse)` - Проверить, есть ли у пользователя доступ к игре
    *   `GetPlaytimeStats(GetUserPlaytimeRequest) returns (GetUserPlaytimeResponse)` - Получить статистику игрового времени
    *   `GetUserAchievements(GetUserAchievementsRequest) returns (GetUserAchievementsResponse)` - Получить достижения пользователя
*   **LibraryCommandService** (Может не понадобиться, если все изменения инициируются через REST или события)

*(Полное описание сообщений и методов должно быть в proto-файле)*

### 5.4 WebSocket API

**Назначение**: Уведомление Flutter-клиента об изменениях в реальном времени (через API Gateway).
**Формат сообщений**: Стандартный JSON (`event_type`, `payload`).

**Типы событий для клиента**:

*   `library.updated` - Обновление библиотеки (добавлена/скрыта игра, изменены категории)
*   `playtime.updated` - Обновление статистики игрового времени
*   `achievement.unlocked` - Получено новое достижение
*   `wishlist.updated` - Обновление списка желаемого
*   `savegame.sync.status` - Статус синхронизации сохранений (начало, успех, ошибка)
*   `notification.new` - Общее событие о новом уведомлении (детали через REST)

## 6. Интеграции с другими микросервисами и внешними системами

### 6.1 Внутренние интеграции (Микросервисы)

| Сервис | Направление | Тип | Протокол/Механизм | Описание |
|---|---|---|---|---|
| Account Service | Library -> Account | Синхронное | gRPC | Получение данных пользователя (ID, статус) для проверок. |
| Catalog Service | Library -> Catalog | Синхронное | gRPC | Получение метаданных игр, приложений, DLC, достижений. |
| Payment Service | Payment -> Library | Асинхронное | Kafka (Событие: `payment.purchase.completed`) | Получение уведомления о покупке для добавления игры в библиотеку. |
| Download Service | Library -> Download | Синхронное | gRPC | Предоставление информации о правах доступа к игре (`CheckGameAccess`). |
| Download Service | Download -> Library | Асинхронное | Kafka (События: `download.game.installed`, `download.game.uninstalled`) | Получение информации о статусе установки игры. |
| Social Service | Library -> Social | Асинхронное | Kafka (События: `library.achievement.unlocked`, `library.playtime.updated`) | Уведомление об игровых событиях для ленты активности. |
| Analytics Service | Library -> Analytics | Асинхронное | Kafka (События: `library.game.added`, `library.playtime.updated`, `library.achievement.unlocked`, и др.) | Отправка данных для анализа использования платформы. |
| Notification Service | Library -> Notification | Асинхронное | Kafka (События: `library.achievement.unlocked`, `library.wishlist.discount`, и др.) | Отправка событий для генерации уведомлений пользователю. |
| API Gateway | Client -> Gateway -> Library | Синхронное | REST | Обработка запросов от Flutter-клиента. |
| API Gateway | Library -> Gateway -> Client | Асинхронное | WebSocket (через Kafka) | Отправка уведомлений клиенту в реальном времени. |

### 6.2 Внешние интеграции

| Система | Направление | Тип | Протокол/Механизм | Описание |
|---|---|---|---|---|
| Облачное хранилище (S3) | Library <-> S3 | Синхронное | AWS S3 SDK (Go) | Хранение и получение файлов сохранений. Генерация pre-signed URLs. |

### 6.3 Обработка ошибок интеграции

- **Синхронные вызовы (gRPC)**: Использование таймаутов, механизма повторных попыток (retry) с экспоненциальной задержкой, Circuit Breaker для предотвращения каскадных сбоев.
- **Асинхронные вызовы (Kafka)**: Гарантия доставки сообщений (at-least-once), обработка дубликатов (идемпотентность консьюмеров), использование Dead Letter Queue (DLQ) для невалидных или необрабатываемых сообщений.
- **Кэширование**: Кэширование ответов от других сервисов (например, метаданных из Catalog Service) для снижения нагрузки и повышения отказоустойчивости.

## 7. Требования к безопасности, масштабируемости и отказоустойчивости

### 7.1 Безопасность

- **Аутентификация**: Все запросы к API (REST, gRPC, WebSocket) должны быть аутентифицированы с использованием JWT-токенов, валидируемых через Auth Service или локально (с использованием публичного ключа).
- **Авторизация**: Проверка прав доступа на основе ролей пользователя (см. раздел 10) для каждой операции API. Доступ к данным одного пользователя не должен позволять получить данные другого (кроме случаев с семейным доступом или ролями поддержки/администратора).
- **Защита данных**: TLS 1.2+ для всех внешних и внутренних коммуникаций. Шифрование чувствительных данных в конфигурации (секреты Kubernetes). Рассмотреть шифрование данных сохранений в S3 (SSE-S3 или SSE-KMS).
- **Защита от атак**: Валидация входных данных для предотвращения инъекций. Ограничение частоты запросов (Rate Limiting) на уровне API Gateway и сервиса. Защита от подделки достижений и игрового времени (серверная валидация, анализ аномалий).
- **Управление секретами**: Использование Kubernetes Secrets или HashiCorp Vault для хранения ключей API, паролей к базам данных и других секретов.
- **Аудит безопасности**: Логирование всех важных операций с указанием пользователя и IP-адреса (см. раздел 8).

### 7.2 Масштабируемость

- **Горизонтальное масштабирование**: Сервис должен быть stateless, чтобы позволить запуск нескольких экземпляров за балансировщиком нагрузки. Использование Kubernetes Horizontal Pod Autoscaler (HPA) на основе CPU/Memory utilization.
- **Масштабирование баз данных**: Использование PostgreSQL с возможностью репликации чтения (read replicas). Оптимизация запросов и индексов. Использование Redis Cluster для масштабирования кэша.
- **Масштабирование Kafka**: Настройка топиков с достаточным количеством партиций.
- **Масштабирование S3**: S3 обеспечивает автоматическую масштабируемость.

### 7.3 Отказоустойчивость

- **Резервирование компонентов**: Запуск нескольких реплик сервиса, Redis, PostgreSQL (с репликацией). Использование Kubernetes PodDisruptionBudget.
- **Обработка сбоев**: Механизмы retry, timeout, circuit breaker для межсервисных вызовов. Идемпотентность обработчиков событий Kafka.
- **Резервное копирование**: Регулярное резервное копирование PostgreSQL (например, с помощью pg_dump или инструментов облачного провайдера). Версионирование и резервное копирование данных в S3.
- **Восстановление**: Наличие процедур восстановления из резервных копий. Автоматическое переключение на реплики БД при сбое мастера.

## 8. Мониторинг, логирование и трассировка

### 8.1 Мониторинг

- **Инструменты**: Prometheus для сбора метрик, Grafana для визуализации.
- **Ключевые метрики**: 
    - **Запросы**: Количество запросов (по эндпоинтам, методам, статусам), задержка (latency - P50, P90, P95, P99), частота ошибок (error rate).
    - **Ресурсы**: CPU utilization, Memory utilization, Network I/O, Disk I/O.
    - **Go runtime**: Количество горутин, использование сборщика мусора (GC pauses).
    - **Базы данных**: Количество соединений, задержка запросов, частота ошибок, использование ресурсов БД.
    - **Kafka**: Задержка консьюмеров (consumer lag), количество сообщений в топиках.
    - **Бизнес-метрики**: Количество активных игровых сессий, частота синхронизации сохранений, количество добавленных игр/достижений.
- **Алертинг**: Настройка алертов в Alertmanager на основе пороговых значений метрик (высокая задержка, высокая частота ошибок, высокий consumer lag, использование ресурсов > 80%).
- **Дашборды**: Стандартные дашборды Grafana для Go-приложений, Kubernetes, PostgreSQL, Redis, Kafka. Кастомные дашборды для бизнес-метрик Library Service.

### 8.2 Логирование

- **Инструменты**: Библиотека `zap` в Go, сбор логов с помощью Fluentd/Fluent Bit, централизованное хранение и анализ в ELK Stack (Elasticsearch, Logstash, Kibana) или Loki.
- **Формат логов**: Структурированный JSON. Каждая запись должна содержать:
    - `timestamp` (ISO 8601)
    - `level` (debug, info, warn, error, fatal)
    - `service_name` ("library-service")
    - `message`
    - `trace_id`, `span_id` (для корреляции с трассировкой)
    - `user_id` (если применимо)
    - Контекстная информация (например, `game_id`, `request_id`)
- **Уровни логирования**: 
    - `DEBUG`: Детальная информация для отладки.
    - `INFO`: Основные события жизненного цикла запроса, бизнес-операции.
    - `WARN`: Неожиданные, но не критичные ситуации.
    - `ERROR`: Ошибки, требующие внимания, но не останавливающие работу сервиса.
    - `FATAL`: Критические ошибки, приводящие к остановке сервиса.
- **Ключевые события для логирования**: Старт/стоп сервиса, входящие запросы, исходящие вызовы, ошибки, важные бизнес-операции (добавление игры, разблокировка достижения, старт/стоп сессии), операции с БД, события Kafka.
- **Аудит**: Логирование всех операций, изменяющих состояние системы (POST, PUT, PATCH, DELETE запросы), с указанием `user_id`, `ip_address`, параметров запроса и результата операции. Уровень `INFO` или отдельный лог аудита.

### 8.3 Трассировка

- **Инструменты**: OpenTelemetry SDK (или OpenTracing) в Go, Jaeger для сбора и визуализации трасс.
- **Механизм**: Генерация `trace_id` на входе в систему (API Gateway или первый сервис). Проброс `trace_id` и `span_id` между сервисами через заголовки HTTP/gRPC и метаданные Kafka.
- **Ключевые точки трассировки (Spans)**: 
    - Обработка входящего запроса (REST/gRPC).
    - Вызовы других микросервисов (gRPC).
    - Запросы к базам данных (PostgreSQL, Redis).
    - Взаимодействие с S3.
    - Публикация/обработка сообщений Kafka.
    - Важные этапы бизнес-логики.
- **Интеграция**: Трассировка должна быть сквозной (end-to-end), охватывая весь путь запроса от API Gateway до баз данных и обратно.

## 9. Рекомендации по реализации и развертыванию

### 9.1 Технологический стек

- **Backend**: Go 1.21+
    - Веб-фреймворк: Echo
    - gRPC: google.golang.org/grpc
    - ORM/DB: GORM (или sqlx/pgx для большего контроля)
    - Миграции: golang-migrate
    - Валидация: validator
    - Логирование: zap
    - Метрики: client_golang (Prometheus)
    - Трассировка: opentelemetry-go (или opentracing-go)
    - Kafka: kafka-go (или sarama)
    - Тестирование: testify, gomock, go-sqlmock
- **Базы данных**: PostgreSQL 15+, Redis 7+
- **Инфраструктура**: Docker, Kubernetes, Helm, Prometheus, Grafana, ELK/Loki, Jaeger, Kafka, S3-совместимое хранилище.

### 9.2 Инфраструктурные файлы

- **Dockerfile**: Многоэтапная сборка (multi-stage build) на основе `golang:1.21-alpine`. Копирование только бинарного файла и конфигурации в финальный образ `alpine`. Запуск от non-root пользователя.
- **Kubernetes манифесты** (управляются через Helm):
    - `Deployment`: Описание подов приложения.
    - `Service`: Доступ к подам внутри кластера.
    - `ConfigMap`: Хранение нечувствительной конфигурации.
    - `Secret`: Хранение чувствительной конфигурации (пароли, ключи API).
    - `HorizontalPodAutoscaler`: Автоматическое масштабирование.
    - `PodDisruptionBudget`: Гарантии доступности при обновлениях/обслуживании узлов.
    - `NetworkPolicy`: Ограничение сетевого доступа к подам.
- **Конфигурационные файлы**: Формат YAML. Чтение из файла и переопределение через переменные окружения. Пример `configs/config.yaml`.

### 9.3 CI/CD

- **Инструменты**: GitLab CI/CD, Jenkins, GitHub Actions и т.п.
- **Пайплайн**: 
    1. Сборка и статический анализ (linting, vet).
    2. Модульные тесты (unit tests).
    3. Сборка Docker-образа.
    4. Интеграционные тесты (с использованием Docker Compose или тестового Kubernetes кластера).
    5. Публикация Docker-образа в registry.
    6. Развертывание в тестовое/staging окружение (Helm).
    7. Автоматические E2E тесты (опционально).
    8. Ручное тестирование/приемка.
    9. Развертывание в production окружение (Helm, возможно, с canary/blue-green стратегией).

### 9.4 Миграции базы данных

- **Инструмент**: `golang-migrate`.
- **Процесс**: Миграции применяются автоматически при старте приложения или через отдельное задание в CI/CD перед развертыванием новой версии.
- **Написание миграций**: Использовать чистый SQL. Каждая миграция должна иметь скрипты `up` и `down`.

### 9.5 Резервное копирование и восстановление

- **PostgreSQL**: Настройка Point-in-Time Recovery (PITR) с использованием WAL-архивирования. Регулярные полные бэкапы (pg_dump) + инкрементальные бэкапы/WAL.
- **Redis**: Использование снапшотов (RDB) и/или AOF. Репликация для отказоустойчивости.
- **S3**: Включение версионирования объектов. Настройка репликации между регионами (Cross-Region Replication) для повышения надежности.
- **Процедуры восстановления**: Документированные и протестированные процедуры восстановления для каждого хранилища данных.

## 10. Роли и права доступа

### 10.1 Роли пользователей

Сервис должен учитывать следующие роли пользователей, определенные в едином реестре:

- `anonymous`: Неаутентифицированный пользователь.
- `user`: Стандартный аутентифицированный пользователь платформы.
- `developer`: Пользователь с правами разработчика игр.
- `publisher`: Пользователь с правами издателя игр.
- `moderator`: Пользователь с правами модерации контента.
- `support`: Сотрудник службы поддержки.
- `admin`: Администратор платформы.
- `system`: Внутренний системный аккаунт для межсервисного взаимодействия.

### 10.2 Матрица доступа к ресурсам Library Service

| Ресурс/Операция | anonymous | user | developer | publisher | moderator | support | admin | system |
|---|---|---|---|---|---|---|---|---|
| **Библиотека (Своя)** | | | | | | | | |
| `GET /` (Список) | - | R | R | R | R | R | R | - |
| `GET /{game_id}` (Детали) | - | R | R | R | R | R | R | - |
| `PATCH /{game_id}` (Обновить) | - | U | U | U | U | U | U | - |
| **Библиотека (Чужая)** | | | | | | | | |
| `GET /users/{user_id}/library` | - | - | - | - | - | R | R | R (gRPC) |
| **Игровое время (Свое)** | | | | | | | | |
| `POST /playtime/start` | - | C | C | C | C | C | C | - |
| `POST /playtime/heartbeat` | - | C | C | C | C | C | C | - |
| `POST /playtime/end` | - | C | C | C | C | C | C | - |
| `GET /playtime/stats` | - | R | R | R | R | R | R | - |
| **Игровое время (Чужое)** | | | | | | | | |
| `GET /users/{user_id}/playtime/stats` | - | - | - | - | - | R | R | R (gRPC) |
| **Достижения (Свои)** | | | | | | | | |
| `GET /achievements` | - | R | R | R | R | R | R | - |
| `POST /achievements/unlock` | - | C | C | C | C | C | C | - |
| **Достижения (Чужие)** | | | | | | | | |
| `GET /users/{user_id}/achievements` | - | - | - | - | - | R | R | R (gRPC) |
| **Список желаемого (Свой)** | | | | | | | | |
| `GET /wishlist` | - | R | R | R | R | R | R | - |
| `POST /wishlist` | - | C | C | C | C | C | C | - |
| `DELETE /wishlist/{game_id}` | - | D | D | D | D | D | D | - |
| `PATCH /wishlist/{game_id}` | - | U | U | U | U | U | U | - |
| **Сохранения (Свои)** | | | | | | | | |
| `GET /savegames` | - | R | R | R | R | R | R | - |
| `POST /savegames/upload-url` | - | C | C | C | C | C | C | - |
| `POST /savegames/confirm-upload` | - | C | C | C | C | C | C | - |
| `POST /savegames/download-url` | - | R | R | R | R | R | R | - |
| `DELETE /savegames/{save_id}` | - | D | D | D | D | D | D | - |
| **Настройки игр (Свои)** | | | | | | | | |
| `GET /settings/{game_id}` | - | R | R | R | R | R | R | - |
| `PUT /settings/{game_id}` | - | U | U | U | U | U | U | - |
| **Проверка доступа (gRPC)** | | | | | | | | |
| `CheckGameAccess` | - | - | - | - | - | - | - | R |

*Легенда: C - Create, R - Read, U - Update, D - Delete, - - Нет доступа.* 
*Роли developer, publisher, moderator наследуют права user.* 
*Роль support наследует права user + получает доступ на чтение чужих данных.* 
*Роль admin имеет полный доступ.* 
*Роль system используется для внутренних вызовов.* 

### 10.3 Механизм проверки прав

- Права доступа проверяются на уровне обработчиков API (REST/gRPC).
- Информация о роли пользователя извлекается из JWT-токена.
- Для доступа к чужим данным всегда проверяется наличие соответствующей роли (`support`, `admin`).
- Для доступа к своим данным проверяется совпадение `user_id` из токена с `user_id` запрашиваемого ресурса.

## 11. Обработка событий

### 11.1 Используемая система сообщений

- Apache Kafka

### 11.2 Формат событий

Стандартный формат CloudEvents (или упрощенный JSON): 
```json
{
  "event_id": "uuid", // Уникальный ID события
  "event_type": "string", // Тип события (например, library.game.added)
  "source": "library-service", // Источник события
  "subject": "string", // ID сущности (например, user_id или game_id)
  "timestamp": "string($date-time)", // Время генерации события (ISO 8601)
  "data_content_type": "application/json",
  "data": { ... } // Полезная нагрузка события
}
```

### 11.3 Публикуемые события

| Тип события (`event_type`) | Топик Kafka | Описание | Полезная нагрузка (`data`) |
|---|---|---|---|
| `library.game.added` | `library-events` | Игра добавлена в библиотеку | `{ "user_id": "uuid", "game_id": "uuid", "acquisition_type": "string" }` |
| `library.game.hidden` | `library-events` | Игра скрыта/показана в библиотеке | `{ "user_id": "uuid", "game_id": "uuid", "is_hidden": "boolean" }` |
| `library.achievement.unlocked` | `achievement-events` | Достижение разблокировано | `{ "user_id": "uuid", "achievement_id": "uuid", "game_id": "uuid", "unlocked_at": "timestamp" }` |
| `library.playtime.updated` | `playtime-events` | Обновлено общее игровое время | `{ "user_id": "uuid", "game_id": "uuid", "total_playtime_seconds": "integer", "last_played_at": "timestamp" }` |
| `library.wishlist.item.added` | `wishlist-events` | Игра добавлена в список желаемого | `{ "user_id": "uuid", "game_id": "uuid" }` |
| `library.wishlist.item.removed` | `wishlist-events` | Игра удалена из списка желаемого | `{ "user_id": "uuid", "game_id": "uuid" }` |
| `library.savegame.synchronized` | `savegame-events` | Сохранение синхронизировано | `{ "user_id": "uuid", "game_id": "uuid", "save_id": "uuid", "timestamp": "timestamp" }` |

### 11.4 Потребляемые события

| Тип события (`event_type`) | Топик Kafka | Источник | Описание | Действие в Library Service |
|---|---|---|---|---|
| `payment.purchase.completed` | `payment-events` | Payment Service | Завершена покупка игры/DLC | Добавить игру/DLC в библиотеку пользователя. |
| `catalog.game.updated` | `catalog-events` | Catalog Service | Обновлены метаданные игры | Обновить кэш метаданных (если используется). |
| `catalog.achievement.updated` | `catalog-events` | Catalog Service | Обновлены метаданные достижения | Обновить кэш метаданных (если используется). |
| `download.game.installed` | `download-events` | Download Service | Игра установлена | Обновить `installation_status` в библиотеке. |
| `download.game.uninstalled` | `download-events` | Download Service | Игра удалена | Обновить `installation_status` в библиотеке. |
| `account.user.deleted` | `account-events` | Account Service | Пользователь удален | Анонимизировать/удалить данные пользователя (согласно GDPR/политикам). |

### 11.5 Гарантии и обработка ошибок

- **Продюсеры**: Гарантия доставки `at-least-once`.
- **Консьюмеры**: Обработка сообщений должна быть идемпотентной. Использование механизма `consumer groups`. Обработка ошибок с повторными попытками. Использование DLQ для критических ошибок обработки.

## 12. Документация

### 12.1 Документация кода

- **Стандарт**: Следовать стандартам `godoc`.
- **Требования**: Документировать все публичные функции, методы, типы и константы. Включать примеры использования (`Example_...`) для ключевых API.
- **Генерация**: Документация должна генерироваться автоматически с помощью стандартных инструментов Go.

### 12.2 Документация API

- **REST API**: Спецификация OpenAPI 3.0 (`library.yaml`). Должна быть актуальной и храниться в репозитории (`/api/openapi/v1/`). Генерируется автоматически из кода или аннотаций (например, с помощью `swaggo` или аналогов).
- **gRPC API**: Файлы `.proto` (`/api/proto/v1/`) являются основной документацией. Дополнительно можно генерировать HTML-документацию с помощью `protoc-gen-doc`.
- **События Kafka**: Описание формата событий и полезной нагрузки в данном документе и/или в отдельном реестре событий.

### 12.3 README.md

Файл `README.md` в корне репозитория должен содержать:
- Краткое описание сервиса.
- Инструкции по сборке и запуску локально (для разработки).
- Инструкции по запуску тестов.
- Описание структуры проекта.
- Ссылки на основную документацию (спецификацию, API).
- Информация о зависимостях.

## 13. Особенности взаимодействия с Flutter-клиентом

### 13.1 Оптимизации API для мобильных клиентов

- **Пагинация**: Все списочные эндпоинты (библиотека, достижения, сохранения, список желаемого) должны поддерживать пагинацию (`limit`, `offset` или `page`, `size`).
- **Частичные ответы**: Возможность запроса только необходимых полей (если требуется, через параметр `fields`).
- **Сжатие**: Поддержка сжатия ответов (gzip) на уровне API Gateway.
- **Кэширование**: Использование HTTP-заголовков кэширования (`ETag`, `Last-Modified`) для данных, которые не изменяются часто (например, метаданные игр, полученные через Library Service).

### 13.2 Синхронизация сохранений

- Механизм должен быть оптимизирован для мобильных сетей (обработка прерываний, фоновая синхронизация).
- Предоставление четкого статуса синхронизации клиенту (через WebSocket или REST API).
- Возможность для пользователя управлять автоматической синхронизацией (включить/выключить, только по Wi-Fi).

### 13.3 Офлайн-режим

- Клиент должен кэшировать основные данные библиотеки, достижений, игрового времени для отображения в офлайн-режиме.
- Операции, выполненные в офлайн-режиме (например, попытка разблокировать достижение), должны ставиться в очередь и отправляться на сервер при восстановлении соединения.

### 13.4 WebSocket

- Эффективное использование WebSocket для минимизации трафика и расхода батареи.
- Механизм `heartbeat` для поддержания соединения и обнаружения разрывов.
- Автоматическое переподключение при потере соединения.

## 14. Ссылки на связанные документы

- [Единый глоссарий терминов и определений](путь/к/глоссарию.md)
- [Стандарты API, форматов данных, событий и конфигурационных файлов](путь/к/стандартам_api.md)
- [Стандарты безопасности, мониторинга, логирования и трассировки](путь/к/стандартам_безопасности.md)
- [Стандарты инфраструктурных файлов для продакшен-развертывания](путь/к/стандартам_инфраструктуры.md)
- [Стандартизация технологического стека микросервисов](путь/к/стандартам_стека.md)
- [Единый реестр ролей пользователей и матрица доступа](путь/к/реестру_ролей.md)
- [Аудит интеграций между микросервисами](путь/к/аудиту_интеграций.md)
- [OpenAPI спецификация Library Service v1](/api/openapi/v1/library.yaml)
- [Protobuf спецификация Library Service v1](/api/proto/v1/library.proto)

# Детальные примеры API Library Service

## REST API

### 1. Получение библиотеки пользователя

#### Запрос
```http
GET /api/v1/library
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json
```

#### Параметры запроса
```
?limit=20&offset=0&sort=name&order=asc&filter=installed
```

#### Успешный ответ (200 OK)
```json
{
  "items": [
    {
      "game_id": "12345",
      "name": "Космические рейнджеры",
      "type": "game",
      "installed": true,
      "size_installed": 2500000000,
      "last_played": "2025-05-15T18:30:45Z",
      "total_playtime": 345600,
      "achievements": {
        "total": 50,
        "unlocked": 23,
        "percentage": 46
      },
      "categories": ["RPG", "Избранное"],
      "cloud_saves": {
        "enabled": true,
        "last_sync": "2025-05-15T20:15:30Z",
        "status": "synced"
      },
      "dlc": [
        {
          "dlc_id": "12345-dlc1",
          "name": "Новые миры",
          "installed": true
        },
        {
          "dlc_id": "12345-dlc2",
          "name": "Пираты глубокого космоса",
          "installed": false
        }
      ],
      "family_shared": false,
      "hidden": false
    },
    {
      "game_id": "67890",
      "name": "Тайны Кремля",
      "type": "game",
      "installed": false,
      "size_installed": 0,
      "last_played": "2025-04-20T14:22:10Z",
      "total_playtime": 28800,
      "achievements": {
        "total": 30,
        "unlocked": 12,
        "percentage": 40
      },
      "categories": ["Приключения"],
      "cloud_saves": {
        "enabled": true,
        "last_sync": "2025-04-20T16:05:12Z",
        "status": "synced"
      },
      "dlc": [],
      "family_shared": false,
      "hidden": false
    }
  ],
  "total": 42,
  "limit": 20,
  "offset": 0
}
```

#### Ответ с ошибкой (401 Unauthorized)
```json
{
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Недействительный или истекший токен авторизации",
    "details": null
  }
}
```

### 2. Получение детальной информации об игре в библиотеке

#### Запрос
```http
GET /api/v1/library/games/12345
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json
```

#### Успешный ответ (200 OK)
```json
{
  "game_id": "12345",
  "name": "Космические рейнджеры",
  "type": "game",
  "installed": true,
  "install_path": "C:/Games/SpaceRangers",
  "size_installed": 2500000000,
  "size_required": 3000000000,
  "version": "2.1.5",
  "last_played": "2025-05-15T18:30:45Z",
  "total_playtime": 345600,
  "playtime_sessions": [
    {
      "start_time": "2025-05-15T16:30:45Z",
      "end_time": "2025-05-15T18:30:45Z",
      "duration": 7200
    },
    {
      "start_time": "2025-05-14T19:15:30Z",
      "end_time": "2025-05-14T21:45:10Z",
      "duration": 8980
    }
  ],
  "achievements": {
    "total": 50,
    "unlocked": 23,
    "percentage": 46,
    "recent": [
      {
        "achievement_id": "ACH_12345_005",
        "name": "Первый миллион",
        "description": "Заработать 1,000,000 кредитов",
        "unlock_time": "2025-05-15T17:45:22Z",
        "icon_url": "https://cdn.example.com/achievements/ACH_12345_005.png",
        "rarity": "common"
      }
    ]
  },
  "categories": ["RPG", "Избранное"],
  "cloud_saves": {
    "enabled": true,
    "last_sync": "2025-05-15T20:15:30Z",
    "status": "synced",
    "saves": [
      {
        "id": "save_12345_001",
        "name": "Сохранение 1",
        "timestamp": "2025-05-15T18:30:40Z",
        "size": 1500000,
        "cloud_path": "users/user123/games/12345/saves/save_001.sav"
      },
      {
        "id": "save_12345_002",
        "name": "Сохранение 2",
        "timestamp": "2025-05-14T21:45:05Z",
        "size": 1520000,
        "cloud_path": "users/user123/games/12345/saves/save_002.sav"
      }
    ],
    "quota": {
      "used": 3020000,
      "total": 10000000000
    }
  },
  "dlc": [
    {
      "dlc_id": "12345-dlc1",
      "name": "Новые миры",
      "installed": true,
      "size_installed": 500000000
    },
    {
      "dlc_id": "12345-dlc2",
      "name": "Пираты глубокого космоса",
      "installed": false,
      "size_required": 600000000
    }
  ],
  "launch_options": [
    {
      "id": "default",
      "name": "Стандартный запуск",
      "command": "",
      "is_default": true
    },
    {
      "id": "safe_mode",
      "name": "Безопасный режим",
      "command": "-safe -nointro",
      "is_default": false
    }
  ],
  "family_shared": false,
  "hidden": false,
  "notes": "Мои заметки по игре",
  "screenshots": [
    {
      "id": "scr_12345_001",
      "timestamp": "2025-05-15T17:30:22Z",
      "url": "https://cdn.example.com/screenshots/user123/12345/scr_001.jpg",
      "thumbnail_url": "https://cdn.example.com/screenshots/user123/12345/scr_001_thumb.jpg"
    }
  ]
}
```

#### Ответ с ошибкой (404 Not Found)
```json
{
  "error": {
    "code": "GAME_NOT_FOUND",
    "message": "Игра с указанным ID не найдена в библиотеке пользователя",
    "details": {
      "game_id": "12345"
    }
  }
}
```

### 3. Добавление игры в категорию

#### Запрос
```http
POST /api/v1/library/games/12345/categories
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "category_name": "Стратегии"
}
```

#### Успешный ответ (200 OK)
```json
{
  "game_id": "12345",
  "categories": ["RPG", "Избранное", "Стратегии"]
}
```

#### Ответ с ошибкой (400 Bad Request)
```json
{
  "error": {
    "code": "INVALID_CATEGORY",
    "message": "Недопустимое название категории",
    "details": {
      "reason": "Категория не может быть пустой или содержать специальные символы"
    }
  }
}
```

### 4. Обновление статуса игровой сессии

#### Запрос (начало сессии)
```http
POST /api/v1/library/games/12345/session/start
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "client_timestamp": "2025-05-22T08:30:00Z",
  "client_id": "desktop_client_001",
  "game_version": "2.1.5"
}
```

#### Успешный ответ (200 OK)
```json
{
  "session_id": "sess_12345_20250522083000",
  "game_id": "12345",
  "start_time": "2025-05-22T08:30:00Z",
  "status": "active"
}
```

#### Запрос (завершение сессии)
```http
POST /api/v1/library/games/12345/session/end
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "session_id": "sess_12345_20250522083000",
  "client_timestamp": "2025-05-22T10:45:30Z",
  "client_id": "desktop_client_001"
}
```

#### Успешный ответ (200 OK)
```json
{
  "session_id": "sess_12345_20250522083000",
  "game_id": "12345",
  "start_time": "2025-05-22T08:30:00Z",
  "end_time": "2025-05-22T10:45:30Z",
  "duration": 8130,
  "status": "completed",
  "total_playtime": 353730
}
```

### 5. Управление облачными сохранениями

#### Запрос (получение URL для загрузки сохранения)
```http
POST /api/v1/library/games/12345/saves/upload
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "save_name": "Сохранение 3",
  "file_size": 1550000,
  "client_timestamp": "2025-05-22T10:45:25Z",
  "metadata": {
    "level": 42,
    "location": "Система Альфа",
    "character_name": "Капитан Шепард"
  }
}
```

#### Успешный ответ (200 OK)
```json
{
  "save_id": "save_12345_003",
  "upload_url": "https://storage.example.com/upload?token=abc123...",
  "expires_at": "2025-05-22T11:45:25Z",
  "headers": {
    "Content-Type": "application/octet-stream",
    "x-amz-meta-save-id": "save_12345_003"
  }
}
```

#### Запрос (получение URL для скачивания сохранения)
```http
GET /api/v1/library/games/12345/saves/save_12345_002/download
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### Успешный ответ (200 OK)
```json
{
  "save_id": "save_12345_002",
  "download_url": "https://storage.example.com/download?token=xyz789...",
  "expires_at": "2025-05-22T11:45:25Z",
  "metadata": {
    "level": 38,
    "location": "Система Бета",
    "character_name": "Капитан Шепард"
  }
}
```

### 6. Управление достижениями

#### Запрос (регистрация достижения)
```http
POST /api/v1/library/games/12345/achievements
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "achievement_id": "ACH_12345_006",
  "unlock_time": "2025-05-22T10:30:15Z",
  "client_id": "desktop_client_001",
  "session_id": "sess_12345_20250522083000"
}
```

#### Успешный ответ (200 OK)
```json
{
  "achievement_id": "ACH_12345_006",
  "name": "Межгалактический герой",
  "description": "Спасти галактику от древней угрозы",
  "unlock_time": "2025-05-22T10:30:15Z",
  "icon_url": "https://cdn.example.com/achievements/ACH_12345_006.png",
  "rarity": "legendary",
  "progress": {
    "total": 50,
    "unlocked": 24,
    "percentage": 48
  }
}
```

#### Ответ с ошибкой (400 Bad Request)
```json
{
  "error": {
    "code": "INVALID_ACHIEVEMENT",
    "message": "Недопустимый идентификатор достижения",
    "details": {
      "achievement_id": "ACH_12345_006",
      "reason": "Достижение не существует для данной игры"
    }
  }
}
```

### 7. Управление списком желаемого

#### Запрос (добавление игры в список желаемого)
```http
POST /api/v1/wishlist
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "game_id": "98765",
  "priority": 2,
  "notify_on_sale": true,
  "max_price": 1500
}
```

#### Успешный ответ (201 Created)
```json
{
  "game_id": "98765",
  "name": "Подземелья Кремля 2",
  "added_at": "2025-05-22T08:35:10Z",
  "priority": 2,
  "notify_on_sale": true,
  "max_price": 1500,
  "current_price": 2000,
  "discount": null
}
```

#### Запрос (получение списка желаемого)
```http
GET /api/v1/wishlist
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### Успешный ответ (200 OK)
```json
{
  "items": [
    {
      "game_id": "54321",
      "name": "Звездные войны: Республика",
      "added_at": "2025-05-10T14:22:30Z",
      "priority": 1,
      "notify_on_sale": true,
      "max_price": 2000,
      "current_price": 3000,
      "discount": null
    },
    {
      "game_id": "98765",
      "name": "Подземелья Кремля 2",
      "added_at": "2025-05-22T08:35:10Z",
      "priority": 2,
      "notify_on_sale": true,
      "max_price": 1500,
      "current_price": 2000,
      "discount": null
    }
  ],
  "total": 2
}
```

## gRPC API

### 1. Получение библиотеки пользователя

#### Запрос
```protobuf
// Метод: LibraryService.GetUserLibrary
message GetUserLibraryRequest {
  string user_id = 1;
  int32 limit = 2;
  int32 offset = 3;
  string sort_by = 4;
  string sort_order = 5;
  string filter = 6;
}
```

#### Пример значений
```
user_id: "user123"
limit: 20
offset: 0
sort_by: "name"
sort_order: "asc"
filter: "installed"
```

#### Ответ
```protobuf
message GetUserLibraryResponse {
  repeated LibraryItem items = 1;
  int32 total = 2;
  int32 limit = 3;
  int32 offset = 4;
}

message LibraryItem {
  string game_id = 1;
  string name = 2;
  string type = 3;
  bool installed = 4;
  int64 size_installed = 5;
  google.protobuf.Timestamp last_played = 6;
  int64 total_playtime = 7;
  AchievementSummary achievements = 8;
  repeated string categories = 9;
  CloudSaveInfo cloud_saves = 10;
  repeated DlcInfo dlc = 11;
  bool family_shared = 12;
  bool hidden = 13;
}

message AchievementSummary {
  int32 total = 1;
  int32 unlocked = 2;
  int32 percentage = 3;
}

message CloudSaveInfo {
  bool enabled = 1;
  google.protobuf.Timestamp last_sync = 2;
  string status = 3;
}

message DlcInfo {
  string dlc_id = 1;
  string name = 2;
  bool installed = 3;
}
```

### 2. Обновление статуса игровой сессии

#### Запрос (начало сессии)
```protobuf
// Метод: LibraryService.StartGameSession
message StartGameSessionRequest {
  string user_id = 1;
  string game_id = 2;
  google.protobuf.Timestamp client_timestamp = 3;
  string client_id = 4;
  string game_version = 5;
}
```

#### Пример значений
```
user_id: "user123"
game_id: "12345"
client_timestamp: "2025-05-22T08:30:00Z"
client_id: "desktop_client_001"
game_version: "2.1.5"
```

#### Ответ
```protobuf
message StartGameSessionResponse {
  string session_id = 1;
  string game_id = 2;
  google.protobuf.Timestamp start_time = 3;
  string status = 4;
}
```

#### Запрос (завершение сессии)
```protobuf
// Метод: LibraryService.EndGameSession
message EndGameSessionRequest {
  string user_id = 1;
  string session_id = 2;
  google.protobuf.Timestamp client_timestamp = 3;
  string client_id = 4;
}
```

#### Пример значений
```
user_id: "user123"
session_id: "sess_12345_20250522083000"
client_timestamp: "2025-05-22T10:45:30Z"
client_id: "desktop_client_001"
```

#### Ответ
```protobuf
message EndGameSessionResponse {
  string session_id = 1;
  string game_id = 2;
  google.protobuf.Timestamp start_time = 3;
  google.protobuf.Timestamp end_time = 4;
  int64 duration = 5;
  string status = 6;
  int64 total_playtime = 7;
}
```

### 3. Проверка наличия игры в библиотеке пользователя

#### Запрос
```protobuf
// Метод: LibraryService.CheckGameOwnership
message CheckGameOwnershipRequest {
  string user_id = 1;
  string game_id = 2;
}
```

#### Пример значений
```
user_id: "user123"
game_id: "12345"
```

#### Ответ
```protobuf
message CheckGameOwnershipResponse {
  bool owned = 1;
  string ownership_type = 2; // "purchased", "family_shared", "subscription", etc.
  google.protobuf.Timestamp purchase_date = 3;
  repeated string dlc_owned = 4;
}
```

### 4. Получение статистики игрового времени

#### Запрос
```protobuf
// Метод: LibraryService.GetPlaytimeStatistics
message GetPlaytimeStatisticsRequest {
  string user_id = 1;
  string game_id = 2; // Опционально, если не указано - для всех игр
  google.protobuf.Timestamp start_date = 3;
  google.protobuf.Timestamp end_date = 4;
  string aggregation = 5; // "daily", "weekly", "monthly"
}
```

#### Пример значений
```
user_id: "user123"
game_id: "12345"
start_date: "2025-04-01T00:00:00Z"
end_date: "2025-05-22T23:59:59Z"
aggregation: "daily"
```

#### Ответ
```protobuf
message GetPlaytimeStatisticsResponse {
  repeated PlaytimeAggregation aggregations = 1;
  int64 total_playtime = 2;
  int32 total_sessions = 3;
  double average_session_duration = 4;
}

message PlaytimeAggregation {
  string period = 1; // "2025-04-01", "2025-W14", "2025-04"
  int64 playtime = 2;
  int32 sessions = 3;
  repeated string games_played = 4;
}
```

## Kafka События

### 1. Событие добавления игры в библиотеку

```json
{
  "event_id": "evt_lib_add_20250522083510",
  "event_type": "library.game.added",
  "version": "1.0",
  "timestamp": "2025-05-22T08:35:10Z",
  "producer": "payment-service",
  "data": {
    "user_id": "user123",
    "game_id": "98765",
    "game_name": "Подземелья Кремля 2",
    "transaction_id": "txn_20250522083510",
    "purchase_type": "direct",
    "price": {
      "amount": 2000,
      "currency": "RUB"
    },
    "dlc": []
  }
}
```

### 2. Событие завершения игровой сессии

```json
{
  "event_id": "evt_session_end_20250522104530",
  "event_type": "library.session.ended",
  "version": "1.0",
  "timestamp": "2025-05-22T10:45:30Z",
  "producer": "library-service",
  "data": {
    "user_id": "user123",
    "game_id": "12345",
    "game_name": "Космические рейнджеры",
    "session_id": "sess_12345_20250522083000",
    "start_time": "2025-05-22T08:30:00Z",
    "end_time": "2025-05-22T10:45:30Z",
    "duration": 8130,
    "total_playtime": 353730,
    "client_id": "desktop_client_001",
    "game_version": "2.1.5"
  }
}
```

### 3. Событие разблокировки достижения

```json
{
  "event_id": "evt_achievement_20250522103015",
  "event_type": "library.achievement.unlocked",
  "version": "1.0",
  "timestamp": "2025-05-22T10:30:15Z",
  "producer": "library-service",
  "data": {
    "user_id": "user123",
    "game_id": "12345",
    "game_name": "Космические рейнджеры",
    "achievement_id": "ACH_12345_006",
    "achievement_name": "Межгалактический герой",
    "achievement_description": "Спасти галактику от древней угрозы",
    "unlock_time": "2025-05-22T10:30:15Z",
    "rarity": "legendary",
    "progress": {
      "total": 50,
      "unlocked": 24,
      "percentage": 48
    },
    "session_id": "sess_12345_20250522083000"
  }
}
```

### 4. Событие синхронизации сохранения

```json
{
  "event_id": "evt_save_sync_20250522104525",
  "event_type": "library.save.synchronized",
  "version": "1.0",
  "timestamp": "2025-05-22T10:45:25Z",
  "producer": "library-service",
  "data": {
    "user_id": "user123",
    "game_id": "12345",
    "game_name": "Космические рейнджеры",
    "save_id": "save_12345_003",
    "save_name": "Сохранение 3",
    "operation": "upload",
    "timestamp": "2025-05-22T10:45:25Z",
    "size": 1550000,
    "cloud_path": "users/user123/games/12345/saves/save_003.sav",
    "metadata": {
      "level": 42,
      "location": "Система Альфа",
      "character_name": "Капитан Шепард"
    },
    "session_id": "sess_12345_20250522083000"
  }
}
```

### 5. Событие изменения статуса установки игры

```json
{
  "event_id": "evt_install_status_20250522110500",
  "event_type": "library.game.install_status_changed",
  "version": "1.0",
  "timestamp": "2025-05-22T11:05:00Z",
  "producer": "download-service",
  "data": {
    "user_id": "user123",
    "game_id": "67890",
    "game_name": "Тайны Кремля",
    "previous_status": "not_installed",
    "current_status": "installing",
    "progress": 15,
    "estimated_completion": "2025-05-22T11:35:00Z",
    "install_path": "C:/Games/KremlinMysteries",
    "size_total": 15000000000,
    "size_downloaded": 2250000000,
    "download_speed": 25000000
  }
}
```

## WebSocket API

### 1. Подписка на обновления библиотеки

#### Запрос на подключение
```
GET /ws/library
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### Сообщение подписки
```json
{
  "action": "subscribe",
  "channels": ["library_updates", "game_sessions", "achievements", "cloud_saves"]
}
```

#### Сообщение об обновлении статуса установки
```json
{
  "channel": "library_updates",
  "event": "install_status_changed",
  "timestamp": "2025-05-22T11:05:00Z",
  "data": {
    "game_id": "67890",
    "game_name": "Тайны Кремля",
    "previous_status": "not_installed",
    "current_status": "installing",
    "progress": 15,
    "estimated_completion": "2025-05-22T11:35:00Z",
    "size_total": 15000000000,
    "size_downloaded": 2250000000,
    "download_speed": 25000000
  }
}
```

#### Сообщение о разблокировке достижения
```json
{
  "channel": "achievements",
  "event": "achievement_unlocked",
  "timestamp": "2025-05-22T10:30:15Z",
  "data": {
    "game_id": "12345",
    "game_name": "Космические рейнджеры",
    "achievement_id": "ACH_12345_006",
    "achievement_name": "Межгалактический герой",
    "achievement_description": "Спасти галактику от древней угрозы",
    "icon_url": "https://cdn.example.com/achievements/ACH_12345_006.png",
    "rarity": "legendary",
    "progress": {
      "total": 50,
      "unlocked": 24,
      "percentage": 48
    }
  }
}
```

#### Сообщение о синхронизации сохранения
```json
{
  "channel": "cloud_saves",
  "event": "save_synchronized",
  "timestamp": "2025-05-22T10:45:25Z",
  "data": {
    "game_id": "12345",
    "game_name": "Космические рейнджеры",
    "save_id": "save_12345_003",
    "save_name": "Сохранение 3",
    "operation": "upload",
    "size": 1550000,
    "metadata": {
      "level": 42,
      "location": "Система Альфа",
      "character_name": "Капитан Шепард"
    }
  }
}
```

#### Сообщение о статусе игровой сессии
```json
{
  "channel": "game_sessions",
  "event": "session_ended",
  "timestamp": "2025-05-22T10:45:30Z",
  "data": {
    "game_id": "12345",
    "game_name": "Космические рейнджеры",
    "session_id": "sess_12345_20250522083000",
    "start_time": "2025-05-22T08:30:00Z",
    "end_time": "2025-05-22T10:45:30Z",
    "duration": 8130,
    "total_playtime": 353730
  }
}
```
# Полная структура проекта Library Service

## Общая структура проекта (Go)

```
library-service/
├── api/                      # API контракты
│   ├── gen/                  # Сгенерированный код
│   │   └── v1/               # Версия API v1
│   │       ├── library_grpc.pb.go
│   │       ├── library.pb.go
│   │       ├── playtime_grpc.pb.go
│   │       ├── playtime.pb.go
│   │       ├── achievement_grpc.pb.go
│   │       ├── achievement.pb.go
│   │       ├── savegame_grpc.pb.go
│   │       ├── savegame.pb.go
│   │       └── wishlist_grpc.pb.go
│   ├── proto/                # Protobuf определения
│   │   └── v1/
│   │       ├── library.proto
│   │       ├── playtime.proto
│   │       ├── achievement.proto
│   │       ├── savegame.proto
│   │       └── wishlist.proto
│   └── openapi/              # OpenAPI спецификации
│       └── v1/
│           ├── library.yaml
│           ├── playtime.yaml
│           ├── achievement.yaml
│           ├── savegame.yaml
│           └── wishlist.yaml
├── cmd/                      # Точки входа
│   └── app/                  # Основное приложение
│       └── main.go
├── configs/                  # Конфигурационные файлы (примеры)
│   ├── config.yaml
│   ├── config.dev.yaml
│   ├── config.test.yaml
│   └── config.prod.yaml
├── deployments/              # Файлы для развертывания
│   ├── Dockerfile
│   ├── docker-compose.yaml
│   └── kubernetes/
│       ├── deployment.yaml
│       ├── service.yaml
│       ├── configmap.yaml
│       ├── secret.yaml
│       ├── hpa.yaml
│       ├── ingress.yaml
│       └── pdb.yaml
├── docs/                     # Документация
│   ├── architecture/
│   │   ├── component-diagram.md
│   │   ├── data-flow.md
│   │   └── sequence-diagrams.md
│   ├── api/
│   │   ├── rest-api.md
│   │   └── grpc-api.md
│   ├── database/
│   │   ├── schema.md
│   │   └── migrations.md
│   └── development/
│       ├── setup.md
│       ├── testing.md
│       └── contribution.md
├── internal/                 # Внутренний код приложения
│   ├── app/                  # Инициализация и запуск приложения
│   │   ├── app.go
│   │   ├── server.go
│   │   └── dependencies.go
│   ├── config/               # Работа с конфигурацией
│   │   ├── config.go
│   │   └── validator.go
│   ├── domain/               # Доменные сущности и логика
│   │   ├── achievement/
│   │   │   ├── entity.go
│   │   │   ├── repository.go
│   │   │   └── service.go
│   │   ├── library/
│   │   │   ├── entity.go
│   │   │   ├── repository.go
│   │   │   └── service.go
│   │   ├── playtime/
│   │   │   ├── entity.go
│   │   │   ├── repository.go
│   │   │   └── service.go
│   │   ├── savegame/
│   │   │   ├── entity.go
│   │   │   ├── repository.go
│   │   │   └── service.go
│   │   └── wishlist/
│   │       ├── entity.go
│   │       ├── repository.go
│   │       └── service.go
│   ├── infrastructure/       # Инфраструктурный слой
│   │   ├── cache/            # Реализация кэша (Redis)
│   │   │   ├── client.go
│   │   │   ├── library_cache.go
│   │   │   ├── playtime_cache.go
│   │   │   └── achievement_cache.go
│   │   ├── clients/          # Клиенты внешних сервисов (gRPC)
│   │   │   ├── account/
│   │   │   │   └── client.go
│   │   │   ├── catalog/
│   │   │   │   └── client.go
│   │   │   ├── payment/
│   │   │   │   └── client.go
│   │   │   ├── download/
│   │   │   │   └── client.go
│   │   │   └── social/
│   │   │       └── client.go
│   │   ├── eventbus/         # Работа с Kafka
│   │   │   ├── consumer.go
│   │   │   ├── producer.go
│   │   │   ├── library_events.go
│   │   │   ├── playtime_events.go
│   │   │   ├── achievement_events.go
│   │   │   └── savegame_events.go
│   │   ├── persistence/      # Реализация репозиториев (PostgreSQL)
│   │   │   ├── db.go
│   │   │   ├── library_repository.go
│   │   │   ├── playtime_repository.go
│   │   │   ├── achievement_repository.go
│   │   │   ├── savegame_repository.go
│   │   │   └── wishlist_repository.go
│   │   ├── storage/          # Работа с облачным хранилищем (S3)
│   │   │   ├── client.go
│   │   │   ├── savegame_storage.go
│   │   │   └── token_generator.go
│   │   ├── metrics/          # Метрики Prometheus
│   │   │   ├── metrics.go
│   │   │   ├── library_metrics.go
│   │   │   ├── playtime_metrics.go
│   │   │   └── achievement_metrics.go
│   │   ├── tracing/          # Трассировка Jaeger
│   │   │   └── tracer.go
│   │   └── logging/          # Логирование (zap)
│   │       └── logger.go
│   ├── interfaces/           # Интерфейсы слоев (репозитории, сервисы)
│   │   ├── cache.go
│   │   ├── repository.go
│   │   ├── storage.go
│   │   └── eventbus.go
│   ├── usecase/              # Сервисный слой (сценарии использования)
│   │   ├── achievement/
│   │   │   ├── unlock.go
│   │   │   ├── progress.go
│   │   │   ├── validate.go
│   │   │   └── stats.go
│   │   ├── library/
│   │   │   ├── add_game.go
│   │   │   ├── get_games.go
│   │   │   ├── update_game.go
│   │   │   ├── categories.go
│   │   │   └── family_sharing.go
│   │   ├── playtime/
│   │   │   ├── start_session.go
│   │   │   ├── update_session.go
│   │   │   ├── end_session.go
│   │   │   └── stats.go
│   │   ├── savegame/
│   │   │   ├── upload.go
│   │   │   ├── download.go
│   │   │   ├── sync.go
│   │   │   └── manage.go
│   │   └── wishlist/
│   │       ├── add_item.go
│   │       ├── remove_item.go
│   │       ├── update_item.go
│   │       └── get_items.go
│   └── transport/            # Транспортный слой
│       ├── grpc/             # gRPC обработчики
│       │   ├── server.go
│       │   ├── library_handler.go
│       │   ├── playtime_handler.go
│       │   ├── achievement_handler.go
│       │   ├── savegame_handler.go
│       │   └── wishlist_handler.go
│       ├── kafka/            # Kafka консьюмеры
│       │   ├── consumer.go
│       │   ├── payment_handler.go
│       │   ├── catalog_handler.go
│       │   └── account_handler.go
│       └── rest/             # REST обработчики (Echo)
│           ├── server.go
│           ├── middleware/
│           │   ├── auth.go
│           │   ├── logging.go
│           │   ├── metrics.go
│           │   └── tracing.go
│           ├── handlers/
│           │   ├── library_handler.go
│           │   ├── playtime_handler.go
│           │   ├── achievement_handler.go
│           │   ├── savegame_handler.go
│           │   └── wishlist_handler.go
│           └── dto/
│               ├── library.go
│               ├── playtime.go
│               ├── achievement.go
│               ├── savegame.go
│               └── wishlist.go
├── migrations/               # Миграции базы данных (golang-migrate)
│   ├── 000001_create_library_tables.up.sql
│   ├── 000001_create_library_tables.down.sql
│   ├── 000002_create_playtime_tables.up.sql
│   ├── 000002_create_playtime_tables.down.sql
│   ├── 000003_create_achievement_tables.up.sql
│   ├── 000003_create_achievement_tables.down.sql
│   ├── 000004_create_savegame_tables.up.sql
│   ├── 000004_create_savegame_tables.down.sql
│   ├── 000005_create_wishlist_tables.up.sql
│   └── 000005_create_wishlist_tables.down.sql
├── pkg/                      # Общие пакеты (утилиты, ошибки и т.д.)
│   ├── errors/
│   │   ├── errors.go
│   │   └── codes.go
│   ├── validator/
│   │   └── validator.go
│   ├── pagination/
│   │   └── pagination.go
│   ├── auth/
│   │   └── jwt.go
│   └── utils/
│       ├── time.go
│       ├── hash.go
│       └── uuid.go
├── test/                     # Тесты
│   ├── integration/
│   │   ├── library_test.go
│   │   ├── playtime_test.go
│   │   ├── achievement_test.go
│   │   ├── savegame_test.go
│   │   └── wishlist_test.go
│   ├── unit/
│   │   ├── domain/
│   │   ├── usecase/
│   │   └── infrastructure/
│   └── mocks/
│       ├── repository_mocks.go
│       ├── service_mocks.go
│       └── client_mocks.go
├── tools/                    # Инструменты для разработки
│   ├── protoc/
│   │   └── generate.sh
│   ├── migration/
│   │   └── migrate.sh
│   └── swagger/
│       └── generate.sh
├── .gitignore
├── .golangci.yml
├── go.mod
├── go.sum
├── Makefile
└── README.md
```

## Описание ключевых директорий и файлов

### 1. API (api/)

Содержит все определения API, включая Protobuf для gRPC и OpenAPI для REST.

- **proto/**: Исходные .proto файлы для определения gRPC сервисов
  - **library.proto**: Определения для управления библиотекой
  - **playtime.proto**: Определения для отслеживания игрового времени
  - **achievement.proto**: Определения для управления достижениями
  - **savegame.proto**: Определения для управления сохранениями
  - **wishlist.proto**: Определения для управления списком желаемого

- **gen/**: Автоматически сгенерированный код из .proto файлов
  - **library_grpc.pb.go**: Сгенерированный код gRPC сервера/клиента для библиотеки
  - **library.pb.go**: Сгенерированные структуры данных для библиотеки

- **openapi/**: OpenAPI (Swagger) спецификации для REST API
  - **library.yaml**: Спецификация REST API для управления библиотекой
  - **playtime.yaml**: Спецификация REST API для отслеживания игрового времени

### 2. Точки входа (cmd/)

Содержит точки входа в приложение.

- **app/main.go**: Основная точка входа, инициализирует и запускает сервис

### 3. Конфигурация (configs/)

Содержит файлы конфигурации для различных окружений.

- **config.yaml**: Базовая конфигурация
- **config.dev.yaml**: Конфигурация для разработки
- **config.test.yaml**: Конфигурация для тестирования
- **config.prod.yaml**: Конфигурация для продакшена

### 4. Развертывание (deployments/)

Содержит файлы для развертывания сервиса.

- **Dockerfile**: Инструкции для сборки Docker-образа
- **docker-compose.yaml**: Конфигурация для локального запуска с зависимостями
- **kubernetes/**: Манифесты Kubernetes
  - **deployment.yaml**: Определение Deployment
  - **service.yaml**: Определение Service
  - **configmap.yaml**: Конфигурационные данные
  - **secret.yaml**: Секретные данные (зашифрованные)
  - **hpa.yaml**: Horizontal Pod Autoscaler для автоматического масштабирования
  - **ingress.yaml**: Ingress для маршрутизации внешнего трафика
  - **pdb.yaml**: Pod Disruption Budget для обеспечения доступности

### 5. Документация (docs/)

Содержит документацию по проекту.

- **architecture/**: Документация по архитектуре
  - **component-diagram.md**: Диаграмма компонентов
  - **data-flow.md**: Диаграммы потоков данных
  - **sequence-diagrams.md**: Диаграммы последовательности для ключевых процессов

- **api/**: Документация по API
  - **rest-api.md**: Описание REST API
  - **grpc-api.md**: Описание gRPC API

- **database/**: Документация по базе данных
  - **schema.md**: Схема базы данных
  - **migrations.md**: Информация о миграциях

- **development/**: Руководства для разработчиков
  - **setup.md**: Настройка окружения разработки
  - **testing.md**: Руководство по тестированию
  - **contribution.md**: Правила контрибьюции

### 6. Внутренний код (internal/)

Содержит основной код приложения, недоступный для импорта извне.

- **app/**: Инициализация и запуск приложения
  - **app.go**: Основной класс приложения
  - **server.go**: Настройка и запуск серверов
  - **dependencies.go**: Инициализация зависимостей (DI)

- **config/**: Работа с конфигурацией
  - **config.go**: Структуры конфигурации и загрузка
  - **validator.go**: Валидация конфигурации

- **domain/**: Доменные сущности и логика (ядро приложения)
  - **library/**: Домен библиотеки игр
    - **entity.go**: Определение сущностей (UserLibrary, GameCategory)
    - **repository.go**: Интерфейсы репозиториев
    - **service.go**: Доменные сервисы и бизнес-логика

  - **playtime/**: Домен игрового времени
    - **entity.go**: Определение сущностей (PlaytimeSession, PlaytimeStats)
    - **repository.go**: Интерфейсы репозиториев
    - **service.go**: Доменные сервисы и бизнес-логика

  - **achievement/**: Домен достижений
    - **entity.go**: Определение сущностей (UserAchievement)
    - **repository.go**: Интерфейсы репозиториев
    - **service.go**: Доменные сервисы и бизнес-логика

  - **savegame/**: Домен сохранений
    - **entity.go**: Определение сущностей (SavegameMetadata)
    - **repository.go**: Интерфейсы репозиториев
    - **service.go**: Доменные сервисы и бизнес-логика

  - **wishlist/**: Домен списка желаемого
    - **entity.go**: Определение сущностей (WishlistItem)
    - **repository.go**: Интерфейсы репозиториев
    - **service.go**: Доменные сервисы и бизнес-логика

- **infrastructure/**: Инфраструктурный слой (реализация интерфейсов)
  - **cache/**: Реализация кэша (Redis)
    - **client.go**: Клиент Redis
    - **library_cache.go**: Кэширование данных библиотеки
    - **playtime_cache.go**: Кэширование данных игрового времени
    - **achievement_cache.go**: Кэширование данных достижений

  - **clients/**: Клиенты внешних сервисов (gRPC)
    - **account/client.go**: Клиент Account Service
    - **catalog/client.go**: Клиент Catalog Service
    - **payment/client.go**: Клиент Payment Service
    - **download/client.go**: Клиент Download Service
    - **social/client.go**: Клиент Social Service

  - **eventbus/**: Работа с Kafka
    - **consumer.go**: Базовый консьюмер Kafka
    - **producer.go**: Базовый продюсер Kafka
    - **library_events.go**: События, связанные с библиотекой
    - **playtime_events.go**: События, связанные с игровым временем
    - **achievement_events.go**: События, связанные с достижениями
    - **savegame_events.go**: События, связанные с сохранениями

  - **persistence/**: Реализация репозиториев (PostgreSQL)
    - **db.go**: Инициализация и управление соединением с БД
    - **library_repository.go**: Репозиторий для библиотеки
    - **playtime_repository.go**: Репозиторий для игрового времени
    - **achievement_repository.go**: Репозиторий для достижений
    - **savegame_repository.go**: Репозиторий для сохранений
    - **wishlist_repository.go**: Репозиторий для списка желаемого

  - **storage/**: Работа с облачным хранилищем (S3)
    - **client.go**: Клиент S3
    - **savegame_storage.go**: Хранение файлов сохранений
    - **token_generator.go**: Генерация временных токенов доступа

  - **metrics/**: Метрики Prometheus
    - **metrics.go**: Базовая настройка метрик
    - **library_metrics.go**: Метрики для библиотеки
    - **playtime_metrics.go**: Метрики для игрового времени
    - **achievement_metrics.go**: Метрики для достижений

  - **tracing/**: Трассировка Jaeger
    - **tracer.go**: Настройка и инициализация трассировки

  - **logging/**: Логирование (zap)
    - **logger.go**: Настройка и инициализация логгера

- **interfaces/**: Интерфейсы слоев
  - **cache.go**: Интерфейсы для кэширования
  - **repository.go**: Базовые интерфейсы репозиториев
  - **storage.go**: Интерфейсы для хранилища
  - **eventbus.go**: Интерфейсы для работы с событиями

- **usecase/**: Сервисный слой (сценарии использования)
  - **library/**: Сценарии для библиотеки
    - **add_game.go**: Добавление игры в библиотеку
    - **get_games.go**: Получение списка игр
    - **update_game.go**: Обновление информации об игре
    - **categories.go**: Управление категориями
    - **family_sharing.go**: Управление семейным доступом

  - **playtime/**: Сценарии для игрового времени
    - **start_session.go**: Начало игровой сессии
    - **update_session.go**: Обновление статуса сессии
    - **end_session.go**: Завершение сессии
    - **stats.go**: Статистика игрового времени

  - **achievement/**: Сценарии для достижений
    - **unlock.go**: Разблокировка достижения
    - **progress.go**: Обновление прогресса
    - **validate.go**: Валидация достижений
    - **stats.go**: Статистика достижений

  - **savegame/**: Сценарии для сохранений
    - **upload.go**: Загрузка сохранения
    - **download.go**: Скачивание сохранения
    - **sync.go**: Синхронизация сохранений
    - **manage.go**: Управление сохранениями

  - **wishlist/**: Сценарии для списка желаемого
    - **add_item.go**: Добавление игры в список
    - **remove_item.go**: Удаление игры из списка
    - **update_item.go**: Обновление параметров
    - **get_items.go**: Получение списка желаемого

- **transport/**: Транспортный слой
  - **grpc/**: gRPC обработчики
    - **server.go**: Настройка gRPC сервера
    - **library_handler.go**: Обработчик запросов библиотеки
    - **playtime_handler.go**: Обработчик запросов игрового времени
    - **achievement_handler.go**: Обработчик запросов достижений
    - **savegame_handler.go**: Обработчик запросов сохранений
    - **wishlist_handler.go**: Обработчик запросов списка желаемого

  - **kafka/**: Kafka консьюмеры
    - **consumer.go**: Базовая настройка консьюмера
    - **payment_handler.go**: Обработчик событий платежей
    - **catalog_handler.go**: Обработчик событий каталога
    - **account_handler.go**: Обработчик событий аккаунтов

  - **rest/**: REST обработчики (Echo)
    - **server.go**: Настройка REST сервера
    - **middleware/**: Промежуточные обработчики
      - **auth.go**: Аутентификация и авторизация
      - **logging.go**: Логирование запросов
      - **metrics.go**: Сбор метрик
      - **tracing.go**: Трассировка запросов
    - **handlers/**: Обработчики HTTP запросов
      - **library_handler.go**: Обработчик запросов библиотеки
      - **playtime_handler.go**: Обработчик запросов игрового времени
      - **achievement_handler.go**: Обработчик запросов достижений
      - **savegame_handler.go**: Обработчик запросов сохранений
      - **wishlist_handler.go**: Обработчик запросов списка желаемого
    - **dto/**: Объекты передачи данных
      - **library.go**: DTO для библиотеки
      - **playtime.go**: DTO для игрового времени
      - **achievement.go**: DTO для достижений
      - **savegame.go**: DTO для сохранений
      - **wishlist.go**: DTO для списка желаемого

### 7. Миграции (migrations/)

Содержит SQL-скрипты для миграций базы данных.

- **000001_create_library_tables.up.sql**: Создание таблиц для библиотеки
- **000001_create_library_tables.down.sql**: Откат создания таблиц для библиотеки
- **000002_create_playtime_tables.up.sql**: Создание таблиц для игрового времени
- **000002_create_playtime_tables.down.sql**: Откат создания таблиц для игрового времени

### 8. Общие пакеты (pkg/)

Содержит общие пакеты, которые могут быть использованы другими сервисами.

- **errors/**: Обработка ошибок
  - **errors.go**: Определение типов ошибок
  - **codes.go**: Коды ошибок

- **validator/**: Валидация данных
  - **validator.go**: Функции валидации

- **pagination/**: Пагинация
  - **pagination.go**: Утилиты для пагинации

- **auth/**: Аутентификация
  - **jwt.go**: Работа с JWT токенами

- **utils/**: Утилиты
  - **time.go**: Работа со временем
  - **hash.go**: Хеширование
  - **uuid.go**: Генерация и валидация UUID

### 9. Тесты (test/)

Содержит тесты для проекта.

- **integration/**: Интеграционные тесты
  - **library_test.go**: Тесты для библиотеки
  - **playtime_test.go**: Тесты для игрового времени
  - **achievement_test.go**: Тесты для достижений
  - **savegame_test.go**: Тесты для сохранений
  - **wishlist_test.go**: Тесты для списка желаемого

- **unit/**: Модульные тесты
  - **domain/**: Тесты для доменного слоя
  - **usecase/**: Тесты для сервисного слоя
  - **infrastructure/**: Тесты для инфраструктурного слоя

- **mocks/**: Моки для тестирования
  - **repository_mocks.go**: Моки репозиториев
  - **service_mocks.go**: Моки сервисов
  - **client_mocks.go**: Моки клиентов

### 10. Инструменты (tools/)

Содержит инструменты для разработки.

- **protoc/**: Инструменты для работы с Protobuf
  - **generate.sh**: Скрипт для генерации кода из .proto файлов

- **migration/**: Инструменты для миграций
  - **migrate.sh**: Скрипт для применения миграций

- **swagger/**: Инструменты для Swagger
  - **generate.sh**: Скрипт для генерации документации из OpenAPI

### 11. Корневые файлы

- **.gitignore**: Список игнорируемых файлов для Git
- **.golangci.yml**: Конфигурация линтера golangci-lint
- **go.mod**: Определение модуля и зависимостей
- **go.sum**: Контрольные суммы зависимостей
- **Makefile**: Команды для сборки, тестирования и других операций
- **README.md**: Общая информация о проекте
# Схемы таблиц базы данных Library Service

## 1. Таблицы для управления библиотекой

### 1.1. user_libraries

Основная таблица для хранения связей между пользователями и играми в их библиотеках.

```sql
CREATE TABLE user_libraries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL,
    acquisition_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    acquisition_type VARCHAR(20) NOT NULL, -- 'purchase', 'gift', 'subscription'
    is_hidden BOOLEAN NOT NULL DEFAULT FALSE,
    is_favorite BOOLEAN NOT NULL DEFAULT FALSE,
    last_played_at TIMESTAMP WITH TIME ZONE,
    total_playtime BIGINT NOT NULL DEFAULT 0, -- в секундах
    installation_status VARCHAR(20) NOT NULL DEFAULT 'not_installed', -- 'not_installed', 'installing', 'installed', 'updating'
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT user_libraries_user_game_unique UNIQUE (user_id, game_id)
);

CREATE INDEX idx_user_libraries_user_id ON user_libraries(user_id);
CREATE INDEX idx_user_libraries_game_id ON user_libraries(game_id);
CREATE INDEX idx_user_libraries_acquisition_date ON user_libraries(acquisition_date);
CREATE INDEX idx_user_libraries_last_played_at ON user_libraries(last_played_at);
```

### 1.2. user_game_categories

Таблица для хранения пользовательских категорий игр.

```sql
CREATE TABLE user_game_categories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    name VARCHAR(100) NOT NULL,
    color VARCHAR(7), -- HEX-код цвета
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT user_game_categories_user_name_unique UNIQUE (user_id, name)
);

CREATE INDEX idx_user_game_categories_user_id ON user_game_categories(user_id);
```

### 1.3. user_game_category_items

Таблица для связи игр с категориями.

```sql
CREATE TABLE user_game_category_items (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    category_id UUID NOT NULL REFERENCES user_game_categories(id) ON DELETE CASCADE,
    library_item_id UUID NOT NULL REFERENCES user_libraries(id) ON DELETE CASCADE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT user_game_category_items_category_library_unique UNIQUE (category_id, library_item_id)
);

CREATE INDEX idx_user_game_category_items_category_id ON user_game_category_items(category_id);
CREATE INDEX idx_user_game_category_items_library_item_id ON user_game_category_items(library_item_id);
```

### 1.4. family_sharing_links

Таблица для хранения настроек семейного доступа.

```sql
CREATE TABLE family_sharing_links (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    owner_id UUID NOT NULL,
    shared_with_id UUID NOT NULL,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT family_sharing_links_owner_shared_unique UNIQUE (owner_id, shared_with_id)
);

CREATE INDEX idx_family_sharing_links_owner_id ON family_sharing_links(owner_id);
CREATE INDEX idx_family_sharing_links_shared_with_id ON family_sharing_links(shared_with_id);
```

### 1.5. family_sharing_games

Таблица для хранения игр, доступных через семейный доступ.

```sql
CREATE TABLE family_sharing_games (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    family_sharing_id UUID NOT NULL REFERENCES family_sharing_links(id) ON DELETE CASCADE,
    game_id UUID NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT family_sharing_games_sharing_game_unique UNIQUE (family_sharing_id, game_id)
);

CREATE INDEX idx_family_sharing_games_family_sharing_id ON family_sharing_games(family_sharing_id);
CREATE INDEX idx_family_sharing_games_game_id ON family_sharing_games(game_id);
```

## 2. Таблицы для отслеживания игрового времени

### 2.1. playtime_sessions

Таблица для хранения сессий игрового времени.

```sql
CREATE TABLE playtime_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL,
    library_item_id UUID NOT NULL REFERENCES user_libraries(id) ON DELETE CASCADE,
    start_time TIMESTAMP WITH TIME ZONE NOT NULL,
    end_time TIMESTAMP WITH TIME ZONE,
    duration BIGINT, -- в секундах, NULL для активных сессий
    device_id VARCHAR(100) NOT NULL,
    platform VARCHAR(20) NOT NULL, -- 'windows', 'macos', 'linux'
    is_completed BOOLEAN NOT NULL DEFAULT FALSE,
    last_heartbeat_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_playtime_sessions_user_id ON playtime_sessions(user_id);
CREATE INDEX idx_playtime_sessions_game_id ON playtime_sessions(game_id);
CREATE INDEX idx_playtime_sessions_library_item_id ON playtime_sessions(library_item_id);
CREATE INDEX idx_playtime_sessions_start_time ON playtime_sessions(start_time);
CREATE INDEX idx_playtime_sessions_is_completed ON playtime_sessions(is_completed);
CREATE INDEX idx_playtime_sessions_last_heartbeat_at ON playtime_sessions(last_heartbeat_at);
```

### 2.2. playtime_stats_daily

Таблица для хранения агрегированной статистики игрового времени по дням.

```sql
CREATE TABLE playtime_stats_daily (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL,
    library_item_id UUID NOT NULL REFERENCES user_libraries(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    total_playtime BIGINT NOT NULL DEFAULT 0, -- в секундах
    sessions_count INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT playtime_stats_daily_user_game_date_unique UNIQUE (user_id, game_id, date)
);

CREATE INDEX idx_playtime_stats_daily_user_id ON playtime_stats_daily(user_id);
CREATE INDEX idx_playtime_stats_daily_game_id ON playtime_stats_daily(game_id);
CREATE INDEX idx_playtime_stats_daily_library_item_id ON playtime_stats_daily(library_item_id);
CREATE INDEX idx_playtime_stats_daily_date ON playtime_stats_daily(date);
```

### 2.3. playtime_stats_monthly

Таблица для хранения агрегированной статистики игрового времени по месяцам.

```sql
CREATE TABLE playtime_stats_monthly (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL,
    library_item_id UUID NOT NULL REFERENCES user_libraries(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,
    month INTEGER NOT NULL,
    total_playtime BIGINT NOT NULL DEFAULT 0, -- в секундах
    sessions_count INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT playtime_stats_monthly_user_game_year_month_unique UNIQUE (user_id, game_id, year, month)
);

CREATE INDEX idx_playtime_stats_monthly_user_id ON playtime_stats_monthly(user_id);
CREATE INDEX idx_playtime_stats_monthly_game_id ON playtime_stats_monthly(game_id);
CREATE INDEX idx_playtime_stats_monthly_library_item_id ON playtime_stats_monthly(library_item_id);
CREATE INDEX idx_playtime_stats_monthly_year_month ON playtime_stats_monthly(year, month);
```

## 3. Таблицы для управления достижениями

### 3.1. user_achievements

Таблица для хранения достижений пользователей.

```sql
CREATE TABLE user_achievements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL,
    library_item_id UUID NOT NULL REFERENCES user_libraries(id) ON DELETE CASCADE,
    achievement_id VARCHAR(100) NOT NULL,
    unlocked_at TIMESTAMP WITH TIME ZONE NOT NULL,
    progress FLOAT NOT NULL DEFAULT 1.0, -- 0.0 - 1.0
    is_hidden BOOLEAN NOT NULL DEFAULT FALSE,
    platform VARCHAR(20) NOT NULL, -- 'windows', 'macos', 'linux'
    device_id VARCHAR(100) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT user_achievements_user_game_achievement_unique UNIQUE (user_id, game_id, achievement_id)
);

CREATE INDEX idx_user_achievements_user_id ON user_achievements(user_id);
CREATE INDEX idx_user_achievements_game_id ON user_achievements(game_id);
CREATE INDEX idx_user_achievements_library_item_id ON user_achievements(library_item_id);
CREATE INDEX idx_user_achievements_unlocked_at ON user_achievements(unlocked_at);
```

### 3.2. user_achievement_progress

Таблица для хранения прогресса по достижениям, которые еще не разблокированы.

```sql
CREATE TABLE user_achievement_progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL,
    library_item_id UUID NOT NULL REFERENCES user_libraries(id) ON DELETE CASCADE,
    achievement_id VARCHAR(100) NOT NULL,
    progress FLOAT NOT NULL DEFAULT 0.0, -- 0.0 - 1.0
    last_updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    platform VARCHAR(20) NOT NULL, -- 'windows', 'macos', 'linux'
    device_id VARCHAR(100) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT user_achievement_progress_user_game_achievement_unique UNIQUE (user_id, game_id, achievement_id)
);

CREATE INDEX idx_user_achievement_progress_user_id ON user_achievement_progress(user_id);
CREATE INDEX idx_user_achievement_progress_game_id ON user_achievement_progress(game_id);
CREATE INDEX idx_user_achievement_progress_library_item_id ON user_achievement_progress(library_item_id);
```

### 3.3. achievement_stats

Таблица для хранения статистики по достижениям.

```sql
CREATE TABLE achievement_stats (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL,
    library_item_id UUID NOT NULL REFERENCES user_libraries(id) ON DELETE CASCADE,
    total_achievements INTEGER NOT NULL DEFAULT 0,
    unlocked_achievements INTEGER NOT NULL DEFAULT 0,
    completion_percentage FLOAT NOT NULL DEFAULT 0.0, -- 0.0 - 100.0
    last_unlocked_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT achievement_stats_user_game_unique UNIQUE (user_id, game_id)
);

CREATE INDEX idx_achievement_stats_user_id ON achievement_stats(user_id);
CREATE INDEX idx_achievement_stats_game_id ON achievement_stats(game_id);
CREATE INDEX idx_achievement_stats_library_item_id ON achievement_stats(library_item_id);
```

## 4. Таблицы для управления списком желаемого

### 4.1. wishlists

Таблица для хранения элементов списка желаемого.

```sql
CREATE TABLE wishlists (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL,
    added_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    priority INTEGER NOT NULL DEFAULT 3, -- 1-5, где 1 - высший приоритет
    price_at_addition DECIMAL(10, 2),
    current_price DECIMAL(10, 2),
    notify_on_sale BOOLEAN NOT NULL DEFAULT TRUE,
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT wishlists_user_game_unique UNIQUE (user_id, game_id)
);

CREATE INDEX idx_wishlists_user_id ON wishlists(user_id);
CREATE INDEX idx_wishlists_game_id ON wishlists(game_id);
CREATE INDEX idx_wishlists_added_at ON wishlists(added_at);
CREATE INDEX idx_wishlists_priority ON wishlists(priority);
```

### 4.2. wishlist_price_history

Таблица для хранения истории изменения цен на игры в списке желаемого.

```sql
CREATE TABLE wishlist_price_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    wishlist_id UUID NOT NULL REFERENCES wishlists(id) ON DELETE CASCADE,
    price DECIMAL(10, 2) NOT NULL,
    recorded_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_wishlist_price_history_wishlist_id ON wishlist_price_history(wishlist_id);
CREATE INDEX idx_wishlist_price_history_recorded_at ON wishlist_price_history(recorded_at);
```

## 5. Таблицы для управления сохранениями

### 5.1. savegame_metadata

Таблица для хранения метаданных сохранений.

```sql
CREATE TABLE savegame_metadata (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL,
    library_item_id UUID NOT NULL REFERENCES user_libraries(id) ON DELETE CASCADE,
    filename VARCHAR(255) NOT NULL,
    path VARCHAR(1000) NOT NULL, -- путь в облачном хранилище
    size BIGINT NOT NULL, -- в байтах
    hash VARCHAR(64) NOT NULL, -- для проверки целостности
    version INTEGER NOT NULL DEFAULT 1,
    platform VARCHAR(20) NOT NULL, -- 'windows', 'macos', 'linux'
    device_id VARCHAR(100) NOT NULL,
    uploaded_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    last_downloaded_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_savegame_metadata_user_id ON savegame_metadata(user_id);
CREATE INDEX idx_savegame_metadata_game_id ON savegame_metadata(game_id);
CREATE INDEX idx_savegame_metadata_library_item_id ON savegame_metadata(library_item_id);
CREATE INDEX idx_savegame_metadata_uploaded_at ON savegame_metadata(uploaded_at);
CREATE INDEX idx_savegame_metadata_filename ON savegame_metadata(filename);
```

### 5.2. savegame_sync_settings

Таблица для хранения настроек синхронизации сохранений.

```sql
CREATE TABLE savegame_sync_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL,
    library_item_id UUID NOT NULL REFERENCES user_libraries(id) ON DELETE CASCADE,
    is_auto_sync BOOLEAN NOT NULL DEFAULT TRUE,
    conflict_resolution_strategy VARCHAR(20) NOT NULL DEFAULT 'newest', -- 'newest', 'largest', 'manual'
    max_versions INTEGER NOT NULL DEFAULT 3,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT savegame_sync_settings_user_game_unique UNIQUE (user_id, game_id)
);

CREATE INDEX idx_savegame_sync_settings_user_id ON savegame_sync_settings(user_id);
CREATE INDEX idx_savegame_sync_settings_game_id ON savegame_sync_settings(game_id);
CREATE INDEX idx_savegame_sync_settings_library_item_id ON savegame_sync_settings(library_item_id);
```

### 5.3. savegame_versions

Таблица для хранения версий сохранений.

```sql
CREATE TABLE savegame_versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    savegame_id UUID NOT NULL REFERENCES savegame_metadata(id) ON DELETE CASCADE,
    version INTEGER NOT NULL,
    path VARCHAR(1000) NOT NULL, -- путь в облачном хранилище
    size BIGINT NOT NULL, -- в байтах
    hash VARCHAR(64) NOT NULL, -- для проверки целостности
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT savegame_versions_savegame_version_unique UNIQUE (savegame_id, version)
);

CREATE INDEX idx_savegame_versions_savegame_id ON savegame_versions(savegame_id);
CREATE INDEX idx_savegame_versions_version ON savegame_versions(version);
```

## 6. Таблицы для настроек игр

### 6.1. game_settings

Таблица для хранения пользовательских настроек игр.

```sql
CREATE TABLE game_settings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL,
    library_item_id UUID NOT NULL REFERENCES user_libraries(id) ON DELETE CASCADE,
    settings_data JSONB NOT NULL DEFAULT '{}'::jsonb, -- настройки в формате JSON
    launch_options TEXT,
    controller_config JSONB,
    platform VARCHAR(20) NOT NULL, -- 'windows', 'macos', 'linux'
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT game_settings_user_game_platform_unique UNIQUE (user_id, game_id, platform)
);

CREATE INDEX idx_game_settings_user_id ON game_settings(user_id);
CREATE INDEX idx_game_settings_game_id ON game_settings(game_id);
CREATE INDEX idx_game_settings_library_item_id ON game_settings(library_item_id);
CREATE INDEX idx_game_settings_platform ON game_settings(platform);
```

### 6.2. game_settings_history

Таблица для хранения истории изменений настроек игр.

```sql
CREATE TABLE game_settings_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    game_settings_id UUID NOT NULL REFERENCES game_settings(id) ON DELETE CASCADE,
    settings_data JSONB NOT NULL,
    launch_options TEXT,
    controller_config JSONB,
    changed_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_game_settings_history_game_settings_id ON game_settings_history(game_settings_id);
CREATE INDEX idx_game_settings_history_changed_at ON game_settings_history(changed_at);
```

## 7. Таблицы для аудита и логирования

### 7.1. library_audit_log

Таблица для хранения аудита действий с библиотекой.

```sql
CREATE TABLE library_audit_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID,
    action VARCHAR(50) NOT NULL, -- 'add_game', 'remove_game', 'update_game', 'hide_game', etc.
    details JSONB,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_library_audit_log_user_id ON library_audit_log(user_id);
CREATE INDEX idx_library_audit_log_game_id ON library_audit_log(game_id);
CREATE INDEX idx_library_audit_log_action ON library_audit_log(action);
CREATE INDEX idx_library_audit_log_created_at ON library_audit_log(created_at);
```

### 7.2. achievement_audit_log

Таблица для хранения аудита действий с достижениями.

```sql
CREATE TABLE achievement_audit_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL,
    achievement_id VARCHAR(100),
    action VARCHAR(50) NOT NULL, -- 'unlock', 'update_progress', 'validate', etc.
    details JSONB,
    is_valid BOOLEAN,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_achievement_audit_log_user_id ON achievement_audit_log(user_id);
CREATE INDEX idx_achievement_audit_log_game_id ON achievement_audit_log(game_id);
CREATE INDEX idx_achievement_audit_log_achievement_id ON achievement_audit_log(achievement_id);
CREATE INDEX idx_achievement_audit_log_action ON achievement_audit_log(action);
CREATE INDEX idx_achievement_audit_log_is_valid ON achievement_audit_log(is_valid);
CREATE INDEX idx_achievement_audit_log_created_at ON achievement_audit_log(created_at);
```

## 8. Связи между таблицами

### 8.1. Основные связи

1. **user_libraries** - центральная таблица, связывающая пользователей с играми
   - Связана с **user_game_category_items** через library_item_id
   - Связана с **playtime_sessions** через library_item_id
   - Связана с **user_achievements** через library_item_id
   - Связана с **savegame_metadata** через library_item_id
   - Связана с **game_settings** через library_item_id

2. **family_sharing_links** - связи между владельцами и получателями семейного доступа
   - Связана с **family_sharing_games** через family_sharing_id

3. **user_game_categories** - пользовательские категории игр
   - Связана с **user_game_category_items** через category_id

4. **wishlists** - элементы списка желаемого
   - Связана с **wishlist_price_history** через wishlist_id

5. **savegame_metadata** - метаданные сохранений
   - Связана с **savegame_versions** через savegame_id

6. **game_settings** - настройки игр
   - Связана с **game_settings_history** через game_settings_id

### 8.2. Диаграмма связей

```
user_libraries
│
├─── user_game_category_items
│    │
│    └─── user_game_categories
│
├─── playtime_sessions
│
├─── playtime_stats_daily
│
├─── playtime_stats_monthly
│
├─── user_achievements
│
├─── user_achievement_progress
│
├─── achievement_stats
│
├─── savegame_metadata
│    │
│    └─── savegame_versions
│
├─── savegame_sync_settings
│
└─── game_settings
     │
     └─── game_settings_history

family_sharing_links
│
└─── family_sharing_games

wishlists
│
└─── wishlist_price_history

library_audit_log

achievement_audit_log
```

## 9. Индексы и оптимизация

### 9.1. Основные индексы

1. **Индексы по внешним ключам**
   - Все поля, используемые для связей между таблицами (library_item_id, category_id, и т.д.)

2. **Индексы по полям фильтрации**
   - user_id, game_id - для быстрого поиска по пользователю или игре
   - is_completed, is_hidden, is_favorite - для фильтрации по статусу

3. **Индексы по полям сортировки**
   - last_played_at, acquisition_date - для сортировки игр в библиотеке
   - added_at, priority - для сортировки элементов списка желаемого
   - unlocked_at - для сортировки достижений

4. **Составные индексы**
   - (user_id, game_id) - для быстрого поиска конкретной игры в библиотеке пользователя
   - (year, month) - для быстрого поиска статистики за определенный период

### 9.2. Партиционирование

Для таблиц с большим объемом данных рекомендуется использовать партиционирование:

1. **playtime_sessions** - партиционирование по дате (start_time)
   ```sql
   CREATE TABLE playtime_sessions (
       -- columns
   ) PARTITION BY RANGE (start_time);
   
   CREATE TABLE playtime_sessions_y2025m01 PARTITION OF playtime_sessions
       FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
   
   CREATE TABLE playtime_sessions_y2025m02 PARTITION OF playtime_sessions
       FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
   ```

2. **playtime_stats_daily** - партиционирование по дате (date)
   ```sql
   CREATE TABLE playtime_stats_daily (
       -- columns
   ) PARTITION BY RANGE (date);
   
   CREATE TABLE playtime_stats_daily_y2025q1 PARTITION OF playtime_stats_daily
       FOR VALUES FROM ('2025-01-01') TO ('2025-04-01');
   
   CREATE TABLE playtime_stats_daily_y2025q2 PARTITION OF playtime_stats_daily
       FOR VALUES FROM ('2025-04-01') TO ('2025-07-01');
   ```

3. **library_audit_log** и **achievement_audit_log** - партиционирование по дате (created_at)
   ```sql
   CREATE TABLE library_audit_log (
       -- columns
   ) PARTITION BY RANGE (created_at);
   
   CREATE TABLE library_audit_log_y2025m01 PARTITION OF library_audit_log
       FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
   ```

## 10. Миграции

### 10.1. Пример миграции для создания основных таблиц

```sql
-- 000001_create_library_tables.up.sql
BEGIN;

CREATE TABLE user_libraries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL,
    game_id UUID NOT NULL,
    acquisition_date TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    acquisition_type VARCHAR(20) NOT NULL,
    is_hidden BOOLEAN NOT NULL DEFAULT FALSE,
    is_favorite BOOLEAN NOT NULL DEFAULT FALSE,
    last_played_at TIMESTAMP WITH TIME ZONE,
    total_playtime BIGINT NOT NULL DEFAULT 0,
    installation_status VARCHAR(20) NOT NULL DEFAULT 'not_installed',
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    CONSTRAINT user_libraries_user_game_unique UNIQUE (user_id, game_id)
);

CREATE INDEX idx_user_libraries_user_id ON user_libraries(user_id);
CREATE INDEX idx_user_libraries_game_id ON user_libraries(game_id);
CREATE INDEX idx_user_libraries_acquisition_date ON user_libraries(acquisition_date);
CREATE INDEX idx_user_libraries_last_played_at ON user_libraries(last_played_at);

-- Создание остальных таблиц...

COMMIT;
```

### 10.2. Пример миграции для отката

```sql
-- 000001_create_library_tables.down.sql
BEGIN;

DROP TABLE IF EXISTS user_game_category_items;
DROP TABLE IF EXISTS user_game_categories;
DROP TABLE IF EXISTS family_sharing_games;
DROP TABLE IF EXISTS family_sharing_links;
DROP TABLE IF EXISTS user_libraries;

COMMIT;
```

## 11. Триггеры и функции

### 11.1. Триггер для обновления updated_at

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_user_libraries_updated_at
BEFORE UPDATE ON user_libraries
FOR EACH ROW
EXECUTE FUNCTION update_updated_at_column();

-- Аналогичные триггеры для других таблиц...
```

### 11.2. Триггер для обновления статистики достижений

```sql
CREATE OR REPLACE FUNCTION update_achievement_stats()
RETURNS TRIGGER AS $$
BEGIN
    -- Обновление статистики при разблокировке достижения
    INSERT INTO achievement_stats (
        user_id, game_id, library_item_id, 
        total_achievements, unlocked_achievements, 
        completion_percentage, last_unlocked_at
    )
    SELECT 
        NEW.user_id, NEW.game_id, NEW.library_item_id,
        (SELECT COUNT(*) FROM catalog.game_achievements WHERE game_id = NEW.game_id),
        (SELECT COUNT(*) FROM user_achievements WHERE user_id = NEW.user_id AND game_id = NEW.game_id),
        (SELECT COUNT(*) FROM user_achievements WHERE user_id = NEW.user_id AND game_id = NEW.game_id) * 100.0 / 
            (SELECT COUNT(*) FROM catalog.game_achievements WHERE game_id = NEW.game_id),
        NEW.unlocked_at
    ON CONFLICT (user_id, game_id) DO UPDATE SET
        unlocked_achievements = (SELECT COUNT(*) FROM user_achievements WHERE user_id = NEW.user_id AND game_id = NEW.game_id),
        completion_percentage = (SELECT COUNT(*) FROM user_achievements WHERE user_id = NEW.user_id AND game_id = NEW.game_id) * 100.0 / 
            (SELECT COUNT(*) FROM catalog.game_achievements WHERE game_id = NEW.game_id),
        last_unlocked_at = NEW.unlocked_at,
        updated_at = NOW();
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_achievement_stats_on_unlock
AFTER INSERT ON user_achievements
FOR EACH ROW
EXECUTE FUNCTION update_achievement_stats();
```

### 11.3. Функция для обновления игрового времени

```sql
CREATE OR REPLACE FUNCTION update_playtime_on_session_end()
RETURNS TRIGGER AS $$
BEGIN
    -- Обновление общего игрового времени в библиотеке
    UPDATE user_libraries
    SET 
        total_playtime = total_playtime + NEW.duration,
        last_played_at = NEW.end_time,
        updated_at = NOW()
    WHERE 
        id = NEW.library_item_id;
    
    -- Обновление дневной статистики
    INSERT INTO playtime_stats_daily (
        user_id, game_id, library_item_id, date, 
        total_playtime, sessions_count
    )
    VALUES (
        NEW.user_id, NEW.game_id, NEW.library_item_id, 
        DATE(NEW.end_time AT TIME ZONE 'UTC'),
        NEW.duration, 1
    )
    ON CONFLICT (user_id, game_id, date) DO UPDATE SET
        total_playtime = playtime_stats_daily.total_playtime + NEW.duration,
        sessions_count = playtime_stats_daily.sessions_count + 1,
        updated_at = NOW();
    
    -- Обновление месячной статистики
    INSERT INTO playtime_stats_monthly (
        user_id, game_id, library_item_id, 
        year, month, total_playtime, sessions_count
    )
    VALUES (
        NEW.user_id, NEW.game_id, NEW.library_item_id,
        EXTRACT(YEAR FROM NEW.end_time AT TIME ZONE 'UTC')::INTEGER,
        EXTRACT(MONTH FROM NEW.end_time AT TIME ZONE 'UTC')::INTEGER,
        NEW.duration, 1
    )
    ON CONFLICT (user_id, game_id, year, month) DO UPDATE SET
        total_playtime = playtime_stats_monthly.total_playtime + NEW.duration,
        sessions_count = playtime_stats_monthly.sessions_count + 1,
        updated_at = NOW();
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_playtime_on_session_end
AFTER UPDATE OF is_completed ON playtime_sessions
FOR EACH ROW
WHEN (OLD.is_completed = FALSE AND NEW.is_completed = TRUE)
EXECUTE FUNCTION update_playtime_on_session_end();
```
# Пошаговые диаграммы потоков данных для основных процессов Library Service

## 1. Добавление игры в библиотеку пользователя

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │     │                 │
│  Payment        │     │  API Gateway    │     │  Library        │     │  Catalog        │
│  Service        │     │                 │     │  Service        │     │  Service        │
│                 │     │                 │     │                 │     │                 │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │                       │
         │                       │                       │                       │
         │   1. Событие о        │                       │                       │
         │   завершении платежа  │                       │                       │
         │ ─────────────────────>│                       │                       │
         │                       │                       │                       │
         │                       │  2. Запрос на         │                       │
         │                       │  добавление игры      │                       │
         │                       │ ─────────────────────>│                       │
         │                       │                       │                       │
         │                       │                       │  3. Запрос            │
         │                       │                       │  метаданных игры      │
         │                       │                       │ ─────────────────────>│
         │                       │                       │                       │
         │                       │                       │  4. Метаданные игры   │
         │                       │                       │ <───────────────────── 
         │                       │                       │                       │
         │                       │                       │  5. Проверка          │
         │                       │                       │  наличия игры         │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  6. Сохранение        │
         │                       │                       │  в БД                 │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  7. Публикация        │
         │                       │                       │  события              │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │  8. Ответ об успешном │                       │
         │                       │  добавлении игры      │                       │
         │                       │ <───────────────────── │                       │
         │                       │                       │                       │
         │  9. Подтверждение     │                       │                       │
         │  обработки события    │                       │                       │
         │ <───────────────────── │                       │                       │
         │                       │                       │                       │
┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐
│                 │     │                 │     │                 │     │                 │
│  Payment        │     │  API Gateway    │     │  Library        │     │  Catalog        │
│  Service        │     │                 │     │  Service        │     │  Service        │
│                 │     │                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘
```

### Описание процесса:

1. **Payment Service** отправляет событие о завершении платежа через Kafka
2. **API Gateway** получает событие и направляет запрос на добавление игры в **Library Service**
3. **Library Service** запрашивает метаданные игры из **Catalog Service**
4. **Catalog Service** возвращает метаданные игры (название, обложка, разработчик и т.д.)
5. **Library Service** проверяет, есть ли уже эта игра в библиотеке пользователя
6. **Library Service** сохраняет информацию о новой игре в базе данных
7. **Library Service** публикует событие `library.game_added` в Kafka
8. **Library Service** отправляет ответ об успешном добавлении игры
9. **API Gateway** подтверждает **Payment Service** обработку события

## 2. Начало и завершение игровой сессии

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │     │                 │
│  Клиент         │     │  API Gateway    │     │  Library        │     │  Analytics      │
│  (Лаунчер)      │     │                 │     │  Service        │     │  Service        │
│                 │     │                 │     │                 │     │                 │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │                       │
         │                       │                       │                       │
         │  1. Запуск игры       │                       │                       │
         │ ─────────────────────>│                       │                       │
         │                       │                       │                       │
         │                       │  2. Запрос на начало  │                       │
         │                       │  игровой сессии       │                       │
         │                       │ ─────────────────────>│                       │
         │                       │                       │                       │
         │                       │                       │  3. Проверка          │
         │                       │                       │  доступа к игре       │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  4. Создание          │
         │                       │                       │  сессии в БД          │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  5. Публикация        │
         │                       │                       │  события              │
         │                       │                       │ ─────────────────────>│
         │                       │                       │                       │
         │                       │  6. ID сессии         │                       │
         │                       │ <───────────────────── │                       │
         │                       │                       │                       │
         │  7. ID сессии         │                       │                       │
         │ <───────────────────── │                       │                       │
         │                       │                       │                       │
         │  8. Периодические     │                       │                       │
         │  пульсации (heartbeat)│                       │                       │
         │ ─────────────────────>│                       │                       │
         │                       │  9. Обновление        │                       │
         │                       │  статуса сессии       │                       │
         │                       │ ─────────────────────>│                       │
         │                       │                       │                       │
         │                       │                       │  10. Обновление       │
         │                       │                       │  сессии в БД          │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │  11. Подтверждение    │                       │
         │                       │ <───────────────────── │                       │
         │                       │                       │                       │
         │  12. Завершение игры  │                       │                       │
         │ ─────────────────────>│                       │                       │
         │                       │                       │                       │
         │                       │  13. Запрос на        │                       │
         │                       │  завершение сессии    │                       │
         │                       │ ─────────────────────>│                       │
         │                       │                       │                       │
         │                       │                       │  14. Расчет           │
         │                       │                       │  длительности         │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  15. Обновление       │
         │                       │                       │  статистики           │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  16. Публикация       │
         │                       │                       │  события              │
         │                       │                       │ ─────────────────────>│
         │                       │                       │                       │
         │                       │  17. Статистика       │                       │
         │                       │  игрового времени     │                       │
         │                       │ <───────────────────── │                       │
         │                       │                       │                       │
         │  18. Статистика       │                       │                       │
         │  игрового времени     │                       │                       │
         │ <───────────────────── │                       │                       │
         │                       │                       │                       │
┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐
│                 │     │                 │     │                 │     │                 │
│  Клиент         │     │  API Gateway    │     │  Library        │     │  Analytics      │
│  (Лаунчер)      │     │                 │     │  Service        │     │  Service        │
│                 │     │                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘
```

### Описание процесса:

1. **Клиент (Лаунчер)** отправляет запрос на запуск игры
2. **API Gateway** направляет запрос на начало игровой сессии в **Library Service**
3. **Library Service** проверяет, имеет ли пользователь доступ к игре
4. **Library Service** создает запись о новой игровой сессии в базе данных
5. **Library Service** публикует событие `playtime.session_started` в Kafka
6-7. **Library Service** через **API Gateway** возвращает клиенту ID сессии
8. **Клиент** периодически отправляет пульсации (heartbeat) для подтверждения активности
9. **API Gateway** направляет запросы на обновление статуса сессии в **Library Service**
10. **Library Service** обновляет время последней активности сессии в БД
11. **API Gateway** отправляет подтверждение клиенту
12. **Клиент** отправляет запрос на завершение игры
13. **API Gateway** направляет запрос на завершение сессии в **Library Service**
14. **Library Service** рассчитывает длительность сессии
15. **Library Service** обновляет статистику игрового времени в БД
16. **Library Service** публикует событие `playtime.session_ended` в Kafka
17-18. **Library Service** через **API Gateway** возвращает клиенту статистику игрового времени

## 3. Разблокировка достижения

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │     │                 │     │                 │
│  Игра           │     │  API Gateway    │     │  Library        │     │  Catalog        │     │  Social         │
│                 │     │                 │     │  Service        │     │  Service        │     │  Service        │
│                 │     │                 │     │                 │     │                 │     │                 │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │                       │                       │
         │                       │                       │                       │                       │
         │  1. Запрос на         │                       │                       │                       │
         │  разблокировку        │                       │                       │                       │
         │  достижения           │                       │                       │                       │
         │ ─────────────────────>│                       │                       │                       │
         │                       │                       │                       │                       │
         │                       │  2. Запрос на         │                       │                       │
         │                       │  разблокировку        │                       │                       │
         │                       │  достижения           │                       │                       │
         │                       │ ─────────────────────>│                       │                       │
         │                       │                       │                       │                       │
         │                       │                       │  3. Проверка          │                       │
         │                       │                       │  наличия игры         │                       │
         │                       │                       │  в библиотеке         │                       │
         │                       │                       │ ─┐                    │                       │
         │                       │                       │  │                    │                       │
         │                       │                       │ <┘                    │                       │
         │                       │                       │                       │                       │
         │                       │                       │  4. Проверка          │                       │
         │                       │                       │  валидности           │                       │
         │                       │                       │  достижения           │                       │
         │                       │                       │ ─────────────────────>│                       │
         │                       │                       │                       │                       │
         │                       │                       │  5. Результат         │                       │
         │                       │                       │  валидации            │                       │
         │                       │                       │ <───────────────────── │                       │
         │                       │                       │                       │                       │
         │                       │                       │  6. Проверка          │                       │
         │                       │                       │  статуса              │                       │
         │                       │                       │  достижения           │                       │
         │                       │                       │ ─┐                    │                       │
         │                       │                       │  │                    │                       │
         │                       │                       │ <┘                    │                       │
         │                       │                       │                       │                       │
         │                       │                       │  7. Сохранение        │                       │
         │                       │                       │  достижения в БД      │                       │
         │                       │                       │ ─┐                    │                       │
         │                       │                       │  │                    │                       │
         │                       │                       │ <┘                    │                       │
         │                       │                       │                       │                       │
         │                       │                       │  8. Обновление        │                       │
         │                       │                       │  статистики           │                       │
         │                       │                       │  достижений           │                       │
         │                       │                       │ ─┐                    │                       │
         │                       │                       │  │                    │                       │
         │                       │                       │ <┘                    │                       │
         │                       │                       │                       │                       │
         │                       │                       │  9. Публикация        │                       │
         │                       │                       │  события              │                       │
         │                       │                       │ ─────────────────────────────────────────────>│
         │                       │                       │                       │                       │
         │                       │  10. Результат        │                       │                       │
         │                       │  разблокировки        │                       │                       │
         │                       │ <───────────────────── │                       │                       │
         │                       │                       │                       │                       │
         │  11. Подтверждение    │                       │                       │                       │
         │  разблокировки        │                       │                       │                       │
         │ <───────────────────── │                       │                       │                       │
         │                       │                       │                       │                       │
┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐
│                 │     │                 │     │                 │     │                 │     │                 │
│  Игра           │     │  API Gateway    │     │  Library        │     │  Catalog        │     │  Social         │
│                 │     │                 │     │  Service        │     │  Service        │     │  Service        │
│                 │     │                 │     │                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘
```

### Описание процесса:

1. **Игра** отправляет запрос на разблокировку достижения
2. **API Gateway** направляет запрос в **Library Service**
3. **Library Service** проверяет, есть ли игра в библиотеке пользователя
4. **Library Service** отправляет запрос в **Catalog Service** для проверки валидности достижения
5. **Catalog Service** возвращает результат валидации
6. **Library Service** проверяет, не было ли достижение уже разблокировано
7. **Library Service** сохраняет информацию о разблокировке достижения в БД
8. **Library Service** обновляет статистику достижений пользователя
9. **Library Service** публикует событие `achievement.unlocked` в Kafka для **Social Service**
10-11. **Library Service** через **API Gateway** возвращает игре подтверждение разблокировки

## 4. Загрузка и скачивание сохранений

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │     │                 │
│  Клиент         │     │  API Gateway    │     │  Library        │     │  Облачное       │
│  (Лаунчер)      │     │                 │     │  Service        │     │  хранилище (S3) │
│                 │     │                 │     │                 │     │                 │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │                       │
         │                       │                       │                       │
         │  1. Запрос токена     │                       │                       │
         │  для загрузки         │                       │                       │
         │  сохранения           │                       │                       │
         │ ─────────────────────>│                       │                       │
         │                       │                       │                       │
         │                       │  2. Запрос токена     │                       │
         │                       │  для загрузки         │                       │
         │                       │ ─────────────────────>│                       │
         │                       │                       │                       │
         │                       │                       │  3. Проверка          │
         │                       │                       │  наличия игры         │
         │                       │                       │  в библиотеке         │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  4. Проверка          │
         │                       │                       │  квоты хранилища      │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  5. Генерация         │
         │                       │                       │  временного URL       │
         │                       │                       │ ─────────────────────>│
         │                       │                       │                       │
         │                       │                       │  6. Временный URL     │
         │                       │                       │  для загрузки         │
         │                       │                       │ <───────────────────── │
         │                       │                       │                       │
         │                       │                       │  7. Создание          │
         │                       │                       │  записи в БД          │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │  8. Токен и URL       │                       │
         │                       │  для загрузки         │                       │
         │                       │ <───────────────────── │                       │
         │                       │                       │                       │
         │  9. Токен и URL       │                       │                       │
         │  для загрузки         │                       │                       │
         │ <───────────────────── │                       │                       │
         │                       │                       │                       │
         │  10. Загрузка файла   │                       │                       │
         │  напрямую в хранилище │                       │                       │
         │ ───────────────────────────────────────────────────────────────────>│
         │                       │                       │                       │
         │  11. Подтверждение    │                       │                       │
         │  загрузки             │                       │                       │
         │ <─────────────────────────────────────────────────────────────────── │
         │                       │                       │                       │
         │  12. Запрос на        │                       │                       │
         │  подтверждение        │                       │                       │
         │  загрузки             │                       │                       │
         │ ─────────────────────>│                       │                       │
         │                       │                       │                       │
         │                       │  13. Запрос на        │                       │
         │                       │  подтверждение        │                       │
         │                       │  загрузки             │                       │
         │                       │ ─────────────────────>│                       │
         │                       │                       │                       │
         │                       │                       │  14. Проверка         │
         │                       │                       │  наличия файла        │
         │                       │                       │ ─────────────────────>│
         │                       │                       │                       │
         │                       │                       │  15. Подтверждение    │
         │                       │                       │  наличия              │
         │                       │                       │ <───────────────────── │
         │                       │                       │                       │
         │                       │                       │  16. Обновление       │
         │                       │                       │  метаданных           │
         │                       │                       │  сохранения           │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  17. Проверка         │
         │                       │                       │  конфликтов           │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │  18. Результат        │                       │
         │                       │  подтверждения        │                       │
         │                       │ <───────────────────── │                       │
         │                       │                       │                       │
         │  19. Результат        │                       │                       │
         │  подтверждения        │                       │                       │
         │ <───────────────────── │                       │                       │
         │                       │                       │                       │
┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐
│                 │     │                 │     │                 │     │                 │
│  Клиент         │     │  API Gateway    │     │  Library        │     │  Облачное       │
│  (Лаунчер)      │     │                 │     │  Service        │     │  хранилище (S3) │
│                 │     │                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘
```

### Описание процесса загрузки сохранения:

1. **Клиент (Лаунчер)** отправляет запрос на получение токена для загрузки сохранения
2. **API Gateway** направляет запрос в **Library Service**
3. **Library Service** проверяет, есть ли игра в библиотеке пользователя
4. **Library Service** проверяет, не превышена ли квота хранилища
5. **Library Service** запрашивает у **Облачного хранилища (S3)** временный URL для загрузки
6. **Облачное хранилище** возвращает временный URL для загрузки
7. **Library Service** создает запись о сохранении в БД со статусом "pending"
8-9. **Library Service** через **API Gateway** возвращает клиенту токен и URL для загрузки
10. **Клиент** загружает файл сохранения напрямую в **Облачное хранилище**
11. **Облачное хранилище** подтверждает успешную загрузку
12-13. **Клиент** через **API Gateway** отправляет запрос на подтверждение загрузки в **Library Service**
14. **Library Service** проверяет наличие файла в **Облачном хранилище**
15. **Облачное хранилище** подтверждает наличие файла
16. **Library Service** обновляет метаданные сохранения в БД (статус, размер, хеш)
17. **Library Service** проверяет наличие конфликтов с другими сохранениями
18-19. **Library Service** через **API Gateway** возвращает клиенту результат подтверждения

### Процесс скачивания сохранения:

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │     │                 │
│  Клиент         │     │  API Gateway    │     │  Library        │     │  Облачное       │
│  (Лаунчер)      │     │                 │     │  Service        │     │  хранилище (S3) │
│                 │     │                 │     │                 │     │                 │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │                       │
         │                       │                       │                       │
         │  1. Запрос токена     │                       │                       │
         │  для скачивания       │                       │                       │
         │  сохранения           │                       │                       │
         │ ─────────────────────>│                       │                       │
         │                       │                       │                       │
         │                       │  2. Запрос токена     │                       │
         │                       │  для скачивания       │                       │
         │                       │ ─────────────────────>│                       │
         │                       │                       │                       │
         │                       │                       │  3. Проверка          │
         │                       │                       │  наличия сохранения   │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  4. Проверка          │
         │                       │                       │  прав доступа         │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  5. Генерация         │
         │                       │                       │  временного URL       │
         │                       │                       │ ─────────────────────>│
         │                       │                       │                       │
         │                       │                       │  6. Временный URL     │
         │                       │                       │  для скачивания       │
         │                       │                       │ <───────────────────── │
         │                       │                       │                       │
         │                       │                       │  7. Обновление        │
         │                       │                       │  статистики           │
         │                       │                       │  скачиваний           │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │  8. Токен и URL       │                       │
         │                       │  для скачивания       │                       │
         │                       │ <───────────────────── │                       │
         │                       │                       │                       │
         │  9. Токен и URL       │                       │                       │
         │  для скачивания       │                       │                       │
         │ <───────────────────── │                       │                       │
         │                       │                       │                       │
         │  10. Скачивание файла │                       │                       │
         │  напрямую из хранилища│                       │                       │
         │ ───────────────────────────────────────────────────────────────────>│
         │                       │                       │                       │
         │  11. Файл сохранения  │                       │                       │
         │ <─────────────────────────────────────────────────────────────────── │
         │                       │                       │                       │
┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐
│                 │     │                 │     │                 │     │                 │
│  Клиент         │     │  API Gateway    │     │  Library        │     │  Облачное       │
│  (Лаунчер)      │     │                 │     │  Service        │     │  хранилище (S3) │
│                 │     │                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘
```

### Описание процесса скачивания сохранения:

1. **Клиент (Лаунчер)** отправляет запрос на получение токена для скачивания сохранения
2. **API Gateway** направляет запрос в **Library Service**
3. **Library Service** проверяет наличие сохранения в БД
4. **Library Service** проверяет права доступа пользователя к сохранению
5. **Library Service** запрашивает у **Облачного хранилища (S3)** временный URL для скачивания
6. **Облачное хранилище** возвращает временный URL для скачивания
7. **Library Service** обновляет статистику скачиваний в БД
8-9. **Library Service** через **API Gateway** возвращает клиенту токен и URL для скачивания
10. **Клиент** скачивает файл сохранения напрямую из **Облачного хранилища**
11. **Облачное хранилище** отдает файл сохранения клиенту

## 5. Синхронизация сохранений между устройствами

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │     │                 │
│  Клиент 1       │     │  API Gateway    │     │  Library        │     │  Клиент 2       │
│  (Устройство 1) │     │                 │     │  Service        │     │  (Устройство 2) │
│                 │     │                 │     │                 │     │                 │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │                       │
         │                       │                       │                       │
         │  1. Загрузка          │                       │                       │
         │  сохранения           │                       │                       │
         │ ─────────────────────>│                       │                       │
         │                       │                       │                       │
         │                       │  2. Загрузка          │                       │
         │                       │  сохранения           │                       │
         │                       │ ─────────────────────>│                       │
         │                       │                       │                       │
         │                       │                       │  3. Обработка         │
         │                       │                       │  загрузки             │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  4. Проверка          │
         │                       │                       │  настроек             │
         │                       │                       │  автосинхронизации    │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  5. Публикация        │
         │                       │                       │  события              │
         │                       │                       │  savegame.updated     │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │  6. Подтверждение     │                       │
         │                       │  загрузки             │                       │
         │                       │ <───────────────────── │                       │
         │                       │                       │                       │
         │  7. Подтверждение     │                       │                       │
         │  загрузки             │                       │                       │
         │ <───────────────────── │                       │                       │
         │                       │                       │                       │
         │                       │                       │                       │  8. Запрос на
         │                       │                       │                       │  проверку обновлений
         │                       │                       │                       │  (периодический)
         │                       │                       │                       │ ─────────────────────>
         │                       │                       │                       │
         │                       │                       │  9. Проверка          │
         │                       │                       │  обновлений           │
         │                       │                       │ <───────────────────── │
         │                       │                       │                       │
         │                       │                       │  10. Проверка         │
         │                       │                       │  наличия новых        │
         │                       │                       │  сохранений           │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  11. Список           │
         │                       │                       │  новых сохранений     │
         │                       │                       │ ─────────────────────>│
         │                       │                       │                       │
         │                       │                       │                       │  12. Запрос токена
         │                       │                       │                       │  для скачивания
         │                       │                       │                       │ ─────────────────────>
         │                       │                       │                       │
         │                       │                       │  13. Токен для        │
         │                       │                       │  скачивания           │
         │                       │                       │ ─────────────────────>│
         │                       │                       │                       │
         │                       │                       │                       │  14. Скачивание
         │                       │                       │                       │  сохранения
         │                       │                       │                       │ ─────────────────────>
         │                       │                       │                       │
         │                       │                       │                       │  15. Подтверждение
         │                       │                       │                       │  синхронизации
         │                       │                       │                       │ ─────────────────────>
         │                       │                       │                       │
         │                       │                       │  16. Обновление       │
         │                       │                       │  статуса              │
         │                       │                       │  синхронизации        │
         │                       │                       │ <───────────────────── │
         │                       │                       │                       │
┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐
│                 │     │                 │     │                 │     │                 │
│  Клиент 1       │     │  API Gateway    │     │  Library        │     │  Клиент 2       │
│  (Устройство 1) │     │                 │     │  Service        │     │  (Устройство 2) │
│                 │     │                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘
```

### Описание процесса синхронизации сохранений:

1-2. **Клиент 1** через **API Gateway** загружает сохранение в **Library Service**
3. **Library Service** обрабатывает загрузку сохранения
4. **Library Service** проверяет настройки автоматической синхронизации для игры
5. **Library Service** публикует событие `savegame.updated` в Kafka
6-7. **Library Service** через **API Gateway** отправляет подтверждение загрузки **Клиенту 1**
8. **Клиент 2** периодически отправляет запрос на проверку обновлений
9. **Library Service** получает запрос на проверку обновлений
10. **Library Service** проверяет наличие новых сохранений для устройства
11. **Library Service** отправляет список новых сохранений **Клиенту 2**
12. **Клиент 2** запрашивает токен для скачивания сохранения
13. **Library Service** отправляет токен для скачивания **Клиенту 2**
14. **Клиент 2** скачивает сохранение
15. **Клиент 2** отправляет подтверждение успешной синхронизации
16. **Library Service** обновляет статус синхронизации в БД

## 6. Управление списком желаемого и уведомления о скидках

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │     │                 │     │                 │
│  Клиент         │     │  API Gateway    │     │  Library        │     │  Catalog        │     │  Notification   │
│                 │     │                 │     │  Service        │     │  Service        │     │  Service        │
│                 │     │                 │     │                 │     │                 │     │                 │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │                       │                       │
         │                       │                       │                       │                       │
         │  1. Добавление игры   │                       │                       │                       │
         │  в список желаемого   │                       │                       │                       │
         │ ─────────────────────>│                       │                       │                       │
         │                       │                       │                       │                       │
         │                       │  2. Добавление игры   │                       │                       │
         │                       │  в список желаемого   │                       │                       │
         │                       │ ─────────────────────>│                       │                       │
         │                       │                       │                       │                       │
         │                       │                       │  3. Проверка          │                       │
         │                       │                       │  наличия игры         │                       │
         │                       │                       │  в библиотеке         │                       │
         │                       │                       │ ─┐                    │                       │
         │                       │                       │  │                    │                       │
         │                       │                       │ <┘                    │                       │
         │                       │                       │                       │                       │
         │                       │                       │  4. Запрос            │                       │
         │                       │                       │  информации об игре   │                       │
         │                       │                       │ ─────────────────────>│                       │
         │                       │                       │                       │                       │
         │                       │                       │  5. Информация        │                       │
         │                       │                       │  об игре              │                       │
         │                       │                       │ <───────────────────── │                       │
         │                       │                       │                       │                       │
         │                       │                       │  6. Сохранение        │                       │
         │                       │                       │  в список желаемого   │                       │
         │                       │                       │ ─┐                    │                       │
         │                       │                       │  │                    │                       │
         │                       │                       │ <┘                    │                       │
         │                       │                       │                       │                       │
         │                       │  7. Подтверждение     │                       │                       │
         │                       │  добавления           │                       │                       │
         │                       │ <───────────────────── │                       │                       │
         │                       │                       │                       │                       │
         │  8. Подтверждение     │                       │                       │                       │
         │  добавления           │                       │                       │                       │
         │ <───────────────────── │                       │                       │                       │
         │                       │                       │                       │                       │
         │                       │                       │                       │  9. Событие           │
         │                       │                       │                       │  об изменении цены    │
         │                       │                       │                       │ ─────────────────────>│
         │                       │                       │                       │                       │
         │                       │                       │                       │  10. Запрос списка    │
         │                       │                       │                       │  пользователей с      │
         │                       │                       │                       │  игрой в вишлисте     │
         │                       │                       │                       │ ─────────────────────>│
         │                       │                       │                       │                       │
         │                       │                       │  11. Поиск            │                       │
         │                       │                       │  пользователей        │                       │
         │                       │                       │ <───────────────────── │                       │
         │                       │                       │                       │                       │
         │                       │                       │  12. Список           │                       │
         │                       │                       │  пользователей        │                       │
         │                       │                       │ ─────────────────────>│                       │
         │                       │                       │                       │                       │
         │                       │                       │                       │  13. Отправка         │
         │                       │                       │                       │  уведомлений          │
         │                       │                       │                       │  о скидке             │
         │                       │                       │                       │ ─┐                    │
         │                       │                       │                       │  │                    │
         │                       │                       │                       │ <┘                    │
         │                       │                       │                       │                       │
         │  14. Уведомление      │                       │                       │                       │
         │  о скидке             │                       │                       │                       │
         │ <─────────────────────────────────────────────────────────────────────────────────────────── │
         │                       │                       │                       │                       │
┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐
│                 │     │                 │     │                 │     │                 │     │                 │
│  Клиент         │     │  API Gateway    │     │  Library        │     │  Catalog        │     │  Notification   │
│                 │     │                 │     │  Service        │     │  Service        │     │  Service        │
│                 │     │                 │     │                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘
```

### Описание процесса:

1-2. **Клиент** через **API Gateway** отправляет запрос на добавление игры в список желаемого
3. **Library Service** проверяет, нет ли уже этой игры в библиотеке пользователя
4. **Library Service** запрашивает информацию об игре у **Catalog Service**
5. **Catalog Service** возвращает информацию об игре (название, текущая цена и т.д.)
6. **Library Service** сохраняет игру в список желаемого пользователя
7-8. **Library Service** через **API Gateway** отправляет подтверждение добавления клиенту
9. **Catalog Service** отправляет событие об изменении цены игры в **Notification Service**
10. **Notification Service** запрашивает у **Library Service** список пользователей, у которых игра в списке желаемого
11. **Library Service** ищет пользователей с игрой в списке желаемого и настройкой уведомлений о скидках
12. **Library Service** отправляет список пользователей в **Notification Service**
13. **Notification Service** формирует и отправляет уведомления о скидке
14. **Клиент** получает уведомление о скидке на игру из списка желаемого

## 7. Проверка доступа к игре при запуске

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │     │                 │
│  Клиент         │     │  API Gateway    │     │  Library        │     │  Download       │
│  (Лаунчер)      │     │                 │     │  Service        │     │  Service        │
│                 │     │                 │     │                 │     │                 │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │                       │
         │                       │                       │                       │
         │  1. Запрос на         │                       │                       │
         │  запуск игры          │                       │                       │
         │ ─────────────────────>│                       │                       │
         │                       │                       │                       │
         │                       │  2. Проверка          │                       │
         │                       │  доступа к игре       │                       │
         │                       │ ─────────────────────>│                       │
         │                       │                       │                       │
         │                       │                       │  3. Проверка          │
         │                       │                       │  наличия игры         │
         │                       │                       │  в библиотеке         │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  4. Проверка          │
         │                       │                       │  семейного доступа    │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │                       │  5. Проверка          │
         │                       │                       │  подписки             │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │  6. Результат         │                       │
         │                       │  проверки доступа     │                       │
         │                       │ <───────────────────── │                       │
         │                       │                       │                       │
         │                       │  7. Запрос на         │                       │
         │                       │  получение ссылки     │                       │
         │                       │  для скачивания       │                       │
         │                       │ ─────────────────────────────────────────────>│
         │                       │                       │                       │
         │                       │  8. Ссылка для        │                       │
         │                       │  скачивания           │                       │
         │                       │ <─────────────────────────────────────────────│
         │                       │                       │                       │
         │  9. Разрешение на     │                       │                       │
         │  запуск и ссылка      │                       │                       │
         │  для скачивания       │                       │                       │
         │ <───────────────────── │                       │                       │
         │                       │                       │                       │
         │  10. Начало           │                       │                       │
         │  игровой сессии       │                       │                       │
         │ ─────────────────────>│                       │                       │
         │                       │                       │                       │
         │                       │  11. Регистрация      │                       │
         │                       │  игровой сессии       │                       │
         │                       │ ─────────────────────>│                       │
         │                       │                       │                       │
         │                       │                       │  12. Создание         │
         │                       │                       │  записи о сессии      │
         │                       │                       │ ─┐                    │
         │                       │                       │  │                    │
         │                       │                       │ <┘                    │
         │                       │                       │                       │
         │                       │  13. ID сессии        │                       │
         │                       │ <───────────────────── │                       │
         │                       │                       │                       │
         │  14. ID сессии        │                       │                       │
         │ <───────────────────── │                       │                       │
         │                       │                       │                       │
┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐     ┌────────┴────────┐
│                 │     │                 │     │                 │     │                 │
│  Клиент         │     │  API Gateway    │     │  Library        │     │  Download       │
│  (Лаунчер)      │     │                 │     │  Service        │     │  Service        │
│                 │     │                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘     └─────────────────┘
```

### Описание процесса:

1. **Клиент (Лаунчер)** отправляет запрос на запуск игры
2. **API Gateway** направляет запрос на проверку доступа к игре в **Library Service**
3. **Library Service** проверяет, есть ли игра в библиотеке пользователя
4. **Library Service** проверяет, доступна ли игра через семейный доступ
5. **Library Service** проверяет, доступна ли игра через активную подписку
6. **Library Service** возвращает результат проверки доступа через **API Gateway**
7. **API Gateway** запрашивает у **Download Service** ссылку для скачивания игры
8. **Download Service** возвращает ссылку для скачивания
9. **API Gateway** отправляет клиенту разрешение на запуск и ссылку для скачивания
10. **Клиент** отправляет запрос на начало игровой сессии
11. **API Gateway** направляет запрос на регистрацию игровой сессии в **Library Service**
12. **Library Service** создает запись о новой игровой сессии в БД
13-14. **Library Service** через **API Gateway** возвращает клиенту ID сессии

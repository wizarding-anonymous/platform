<!-- File: backend/services/auth-service/specification/Auth_Service_Detailed_Specification.md -->
# Детализированная Спецификация Микросервиса Аутентификации (Auth Service)

**Версия:** 2.0
**Дата последнего обновления:** 2023-10-27

**На основе документов:**
- Спецификация микросервиса Auth Service.md (v1.0) - *Устаревшая*
- (Дополнительный фаил) Стандарты API, форматов данных, событий и конфигурационных файлов.txt
- (Дополнительный фаил) Стандарты безопасности, мониторинга, логирования и трассировки.txt
- (Дополнительный фаил) Единый глоссарий терминов и определений для российского аналога Steam.txt
- (Дополнительный фаил) Единый реестр ролей пользователей и матрица доступа.txt
- (Дополнительный фаил) Аудит интеграций между микросервисами.txt
- (Дополнительный фаил) Список внешних интеграций российского аналога Steam.txt
- (Дополнительный фаил) Стандартизация технологического стека микросервисов.txt
- Спецификация микросервиса API Gateway.txt
- и другие релевантные спецификации микросервисов.

## Содержание документа

1.  [Обзор Сервиса Аутентификации (`auth_service_overview.md`)](auth_service_overview.md)
    *   Введение
    *   Назначение и Роль
    *   Ключевые Обязанности и Функциональности
    *   Высокоуровневая Архитектура
    *   Основные Технологии
2.  [REST API (`auth_api_rest.md`)](auth_api_rest.md)
    *   Общие Принципы
    *   Эндпоинты Регистрации и Входа
    *   Эндпоинты Верификации Email
    *   Эндпоинты Управления Паролем
    *   Эндпоинты Управления Двухфакторной Аутентификацией (2FA)
    *   Эндпоинты Управления Текущим Пользователем (`/me`)
    *   Эндпоинты Внешней Аутентификации (OAuth & Telegram)
    *   Эндпоинты Управления API Ключами
    *   Административные Эндпоинты
3.  [gRPC API (`auth_api_grpc.md`)](auth_api_grpc.md)
    *   Общие Принципы
    *   Определение Protobuf (`auth.v1.proto`)
    *   Детали RPC Методов (ValidateToken, CheckPermission, GetUserInfo, GetJWKS, HealthCheck)
4.  [Логика Сервиса и Рабочие Процессы (`auth_service_logic.md`)](auth_service_logic.md)
    *   Основные Рабочие Процессы Аутентификации Пользователей
        *   Регистрация Пользователя
        *   Подтверждение Email
        *   Вход Пользователя (Email/Имя пользователя и Пароль)
    *   Рабочие Процессы Двухфакторной Аутентификации (2FA)
        *   Включение 2FA (TOTP)
        *   Верификация и Активация 2FA (TOTP)
        *   Вход с 2FA
        *   Отключение 2FA
    *   Управление Токенами (JWT Access Token, Refresh Token)
    *   Внешняя Аутентификация (OAuth 2.0 / OIDC - Telegram, VK, Odnoklassniki)
    *   Управление API Ключами
    *   Role-Based Access Control (RBAC)
    *   Ведение Журнала Аудита
    *   Обнаружение Подозрительной Активности и Блокировка
5.  [Модель Данных и Схема Базы Данных (`auth_data_model.md`)](auth_data_model.md)
    *   Схема PostgreSQL (DDL для таблиц: users, roles, permissions, role_permissions, user_roles, sessions, refresh_tokens, external_accounts, mfa_secrets, mfa_backup_codes, api_keys, audit_logs, verification_codes)
    *   Структуры Данных Redis (кэш сессий, счетчики ограничения скорости, временные токены)
6.  [Потоковая Обработка Событий (Kafka) (`auth_event_streaming.md`)](auth_event_streaming.md)
    *   Используемая Система Сообщений (Kafka)
    *   Формат Событий (CloudEvents v1.0 JSON)
    *   Общие Атрибуты CloudEvents
    *   Публикуемые События (auth.user.registered, auth.user.email_verified, и т.д.)
    *   Потребляемые События (account.user.profile_updated, admin.user.block, и т.д.)
7.  [Безопасность и Соответствие Требованиям (`auth_security_compliance.md`)](auth_security_compliance.md)
    *   Основные Механизмы Безопасности (Хеширование Паролей - Argon2id, JWT - RS256, 2FA, API Ключи)
    *   Защита от Распространенных Атак (Brute-Force, Credential Stuffing, Session Hijacking, CSRF, XSS)
    *   Соответствие Требованиям и Приватность Данных (ФЗ-152)
    *   Ведение Журнала Аудита
    *   Безопасность Интеграций
    *   Регулярные Практики Безопасности (сканирование, тестирование)
8.  [Интеграции (`auth_integrations.md`)](auth_integrations.md)
    *   Общие Принципы Интеграции
    *   Интеграция с API Gateway
    *   Интеграция с Account Service
    *   Интеграция с Notification Service
    *   Интеграция с Admin Service
    *   Общий Паттерн Интеграции с Другими Микросервисами
9.  [Нефункциональные Требования](#9-нефункциональные-требования) (Детализированы в соответствующих разделах V2 спецификации)
    *   Производительность (FR-AUTH-001)
    *   Масштабируемость (FR-AUTH-002)
    *   Надежность (FR-AUTH-003)
    *   Безопасность (FR-AUTH-004)
    *   Сопровождаемость (FR-AUTH-005)
    *   Совместимость (FR-AUTH-006)
10. [Развертывание и Эксплуатация](#10-развертывание-и-эксплуатация)
    *   Технологический стек (см. `auth_service_overview.md` и "Стандартизация технологического стека")
    *   Инфраструктурные файлы (Dockerfile, Kubernetes манифесты - см. "Стандарты инфраструктурных файлов")
    *   CI/CD (см. "Стандарты инфраструктурных файлов")
    *   Мониторинг, Логирование, Трассировка (см. "Стандарты безопасности, мониторинга, логирования и трассировки")

## 1. Обзор Сервиса Аутентификации

См. [auth_service_overview.md](auth_service_overview.md)

## 2. REST API

См. [auth_api_rest.md](auth_api_rest.md)

## 3. gRPC API

См. [auth_api_grpc.md](auth_api_grpc.md)

## 4. Логика Сервиса и Рабочие Процессы

См. [auth_service_logic.md](auth_service_logic.md)

## 5. Модель Данных и Схема Базы Данных

См. [auth_data_model.md](auth_data_model.md)

## 6. Потоковая Обработка Событий (Kafka)

См. [auth_event_streaming.md](auth_event_streaming.md)

## 7. Безопасность и Соответствие Требованиям

См. [auth_security_compliance.md](auth_security_compliance.md)

## 8. Интеграции

См. [auth_integrations.md](auth_integrations.md)

## 9. Нефункциональные Требования

Нефункциональные требования к Auth Service перечислены в исходном документе `Auth_Service_Detailed_Specification.md` (версия 2.0) и включают:

*   **NFR-AUTH-001 (Производительность)**:
    *   Время ответа на запросы аутентификации (логин, проверка токена): P95 < 150 мс, P99 < 300 мс под нагрузкой 1000 RPS.
    *   Время генерации токена: P95 < 50 мс.
*   **NFR-AUTH-002 (Масштабируемость)**: Горизонтальное масштабирование для обработки не менее 5000 RPS.
*   **NFR-AUTH-003 (Надежность)**: Доступность сервиса: 99.98%. RTO < 5 минут, RPO < 1 минута.
*   **NFR-AUTH-004 (Безопасность)**:
    *   Хеширование паролей: Argon2id (time=1, memory=64MB, threads=4, keyLength=32, saltLength=16).
    *   JWT подпись: RS256 (с использованием RSA ключей 2048 бит).
    *   Срок жизни Access Token: 15 минут.
    *   Срок жизни Refresh Token: 30 дней, одноразовое использование с ротацией.
    *   Защита от OWASP Top 10.
    *   Соответствие ФЗ-152.
*   **NFR-AUTH-005 (Сопровождаемость)**: Покрытие кода тестами > 85%. Структурированное логирование.
*   **NFR-AUTH-006 (Совместимость)**: API совместимы с Flutter-клиентом и другими микросервисами платформы.

Детали реализации этих требований описаны в соответствующих разделах: `auth_security_compliance.md`, `auth_data_model.md` (для хранения), и общих стандартах платформы.

## 10. Развертывание и Эксплуатация

Развертывание и эксплуатация Auth Service должны соответствовать общим платформенным стандартам, изложенным в документах:
*   "[Стандартизация технологического стека микросервисов.txt]"
*   "[Стандарты инфраструктурных файлов для продакшен-развертывания.txt]"
*   "[Стандарты безопасности, мониторинга, логирования и трассировки.txt]"

Ключевые аспекты:
*   **Технологический стек**: Go, PostgreSQL, Redis, Kafka. Детали см. в [auth_service_overview.md](auth_service_overview.md).
*   **Инфраструктурные файлы**:
    *   `Dockerfile` для сборки сервиса.
    *   Helm-чарты для развертывания в Kubernetes, включающие `Deployment`, `Service`, `ConfigMap`, `Secret`, `HorizontalPodAutoscaler`.
*   **CI/CD**: Пайплайны для автоматической сборки, тестирования (unit, integration), сканирования безопасности, и развертывания в различные окружения.
*   **Мониторинг**: Сбор метрик через Prometheus, визуализация в Grafana, настройка алертов в AlertManager.
*   **Логирование**: Структурированное логирование (JSON), сбор через FluentBit/Loki или ELK.
*   **Трассировка**: Интеграция с OpenTelemetry и Jaeger/Tempo.

---
Этот документ (`Auth_Service_Detailed_Specification.md`) служит корневым документом спецификации, объединяя и ссылаясь на более детализированные файлы по каждому аспекту сервиса. Это обеспечивает как высокоуровневое понимание, так и возможность углубленного изучения конкретных деталей.

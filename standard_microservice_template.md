<!-- standard_microservice_template.md -->
# Спецификация Микросервиса: [Название Сервиса]

**Версия:** 1.0
**Дата последнего обновления:** [YYYY-MM-DD]

## 1. Обзор Сервиса (Overview)

### 1.1. Назначение и Роль
*   Краткое описание назначения сервиса.
*   Его роль в общей архитектуре платформы.
*   Основные бизнес-задачи, которые решает сервис.
*   Разработка сервиса должна вестись в соответствии с `CODING_STANDARDS.md`.

### 1.2. Ключевые Функциональности
*   Список основных функций, предоставляемых сервисом.

### 1.3. Основные Технологии
*   Язык программирования: Go (версия 1.21+)
*   REST Framework: Echo (github.com/labstack/echo/v4)
*   gRPC Framework: google.golang.org/grpc
*   База данных: PostgreSQL (версия 15+)
*   Кэширование: Redis (версия 7.0+)
*   Брокер сообщений: Apache Kafka (версия 3.x+)
*   Управление конфигурацией: Viper (github.com/spf13/viper)
*   Логирование: Zap (go.uber.org/zap)
*   Валидация: go-playground/validator/v10
*   ORM/DB Driver: GORM (gorm.io/gorm) с драйвером gorm.io/driver/postgres
*   Трассировка и метрики: OpenTelemetry, Prometheus client
*   Выбор сторонних библиотек и пакетов должен осуществляться согласно `PACKAGE_STANDARDIZATION.md`.

### 1.4. Термины и Определения (Glossary)
*   Ссылка на `project_glossary.md` для общих терминов
*   Специфичные для сервиса термины (если есть)

## 2. Внутренняя Архитектура (Internal Architecture)

### 2.1. Общее Описание
*   Сервис следует принципам чистой многослойной архитектуры для обеспечения разделения ответственности, тестируемости и сопровождаемости.
*   Основные слои: Presentation Layer (API), Application Layer (Use Cases), Domain Layer (Business Logic), Infrastructure Layer (External Systems).

### 2.2. Слои Сервиса

#### 2.2.1. Presentation Layer (Слой Представления)
*   **Ответственность:** Обработка входящих запросов (HTTP, gRPC), валидация, преобразование данных (DTO), вызов Application Layer.
*   **Ключевые компоненты:**
    *   HTTP Handlers/Controllers: Обработчики REST API эндпоинтов
    *   gRPC Service Implementations: Реализация gRPC методов
    *   WebSocket Handlers (если применимо): Обработка WebSocket соединений
    *   DTOs (Data Transfer Objects): Структуры для входящих/исходящих данных
    *   Валидаторы: Проверка корректности входных данных
    *   Middleware: Аутентификация, логирование, обработка ошибок

#### 2.2.2. Application Layer (Прикладной Слой)
*   **Ответственность:** Координация бизнес-логики, реализация сценариев использования (use cases), взаимодействие с Domain Layer и Infrastructure Layer.
*   **Ключевые компоненты:**
    *   Use Case Services: Сервисы, реализующие конкретные сценарии использования
    *   Command/Query Handlers: Обработчики команд и запросов (если используется CQRS)
    *   Application Services: Сервисы координации между различными доменами
    *   Интерфейсы для Infrastructure Layer

#### 2.2.3. Domain Layer (Доменный Слой)
*   **Ответственность:** Бизнес-сущности, агрегаты, доменные события, бизнес-правила. Независим от других слоев.
*   **Ключевые компоненты:**
    *   Entities: Бизнес-сущности с уникальными идентификаторами
    *   Value Objects: Объекты-значения без идентификаторов
    *   Domain Services: Сервисы, содержащие бизнес-логику, не принадлежащую конкретной сущности
    *   Domain Events: События, происходящие в домене
    *   Repository Interfaces: Интерфейсы для работы с персистентностью

#### 2.2.4. Infrastructure Layer (Инфраструктурный Слой)
*   **Ответственность:** Реализация интерфейсов для взаимодействия с внешними системами.
*   **Ключевые компоненты:**
    *   Database Repositories: Реализация репозиториев для PostgreSQL
    *   Cache Implementations: Реализация кэширования через Redis
    *   Message Queue Producers/Consumers: Работа с Kafka
    *   External Service Clients: Клиенты для взаимодействия с другими микросервисами
    *   Адаптеры для файловых хранилищ: S3-совместимые хранилища

## 3. API Endpoints

### 3.1. REST API
*   **Базовый URL:** `/api/v1/[service-name]`
*   **Версионирование:** Использование версии в URL пути
*   **Формат данных:** JSON
*   **Аутентификация:** JWT Bearer Token (проверяется API Gateway)
*   **Стандартные заголовки:**
    *   `Content-Type: application/json`
    *   `Accept: application/json`
    *   `Authorization: Bearer <jwt_token>`
    *   `X-Request-ID: <uuid>`
    *   `X-User-ID: <user_id>` (добавляется API Gateway)
    *   `X-User-Roles: <roles>` (добавляется API Gateway)

#### 3.1.1. Примеры эндпоинтов
[Здесь должны быть описаны конкретные эндпоинты сервиса]

### 3.2. gRPC API
*   **Proto файлы:** Расположены в `proto/[service-name]/v1/`
*   **Именование:** Следует Google API Design Guide
*   **Аутентификация:** mTLS для межсервисного взаимодействия

#### 3.2.1. Примеры методов
[Здесь должны быть описаны конкретные gRPC методы]

### 3.3. WebSocket API (если применимо)
*   **Эндпоинт:** `/api/v1/[service-name]/ws`
*   **Аутентификация:** JWT через query параметр или заголовок при установке соединения
*   **Формат сообщений:** JSON

## 4. Модели Данных (Data Models)

### 4.1. Основные Сущности
[Описание основных сущностей сервиса]

### 4.2. Схема Базы Данных
[DDL для таблиц PostgreSQL]

## 5. Потоковая Обработка Событий (Event Streaming)

### 5.1. Публикуемые События (Produced Events)
*   **Формат:** CloudEvents JSON
*   **Naming Convention:** `com.platform.[service].[entity].[action].v1`
*   **Примеры событий:**
    *   `com.platform.[service].[entity].created.v1`
    *   `com.platform.[service].[entity].updated.v1`
    *   `com.platform.[service].[entity].deleted.v1`

### 5.2. Потребляемые События (Consumed Events)
[Список событий от других сервисов, на которые подписан данный сервис]

## 6. Интеграции (Integrations)

### 6.1. Внутренние Микросервисы
[Список микросервисов, с которыми взаимодействует данный сервис]

### 6.2. Внешние Системы
*   PostgreSQL: Основное хранилище данных
*   Redis: Кэширование и временные данные
*   Kafka: Асинхронный обмен сообщениями
*   S3-совместимое хранилище: Файлы (если применимо)

## 7. Конфигурация (Configuration)

### 7.1. Переменные Окружения
*   `SERVICE_PORT`: Порт сервиса (по умолчанию: 8080)
*   `DATABASE_URL`: PostgreSQL connection string
*   `REDIS_URL`: Redis connection string
*   `KAFKA_BROKERS`: Список Kafka брокеров
*   `JWT_PUBLIC_KEY`: Публичный ключ для валидации JWT
*   `LOG_LEVEL`: Уровень логирования (debug, info, warn, error)
*   `METRICS_PORT`: Порт для метрик Prometheus (по умолчанию: 9090)

### 7.2. Файлы Конфигурации
*   Расположение: `configs/config.yaml`
*   Формат: YAML
*   Управление через Viper с поддержкой переопределения через env

## 8. Обработка Ошибок (Error Handling)

### 8.1. Общие Принципы
*   Использование стандартного формата ошибок согласно `project_api_standards.md`
*   Логирование всех ошибок с trace_id
*   Graceful degradation при недоступности зависимостей

### 8.2. Коды Ошибок
*   400 - Bad Request: Некорректные входные данные
*   401 - Unauthorized: Отсутствует или невалидный токен
*   403 - Forbidden: Недостаточно прав
*   404 - Not Found: Ресурс не найден
*   409 - Conflict: Конфликт состояния
*   500 - Internal Server Error: Внутренняя ошибка
*   503 - Service Unavailable: Сервис временно недоступен

## 9. Безопасность (Security)

### 9.1. Аутентификация
*   JWT токены для REST API (валидация через Auth Service)
*   mTLS для gRPC межсервисного взаимодействия

### 9.2. Авторизация
*   RBAC на основе ролей из JWT
*   Проверка прав на уровне эндпоинтов
*   Row-level security где применимо

### 9.3. Защита Данных
*   TLS для всех внешних соединений
*   Шифрование чувствительных данных в БД
*   Соответствие ФЗ-152 "О персональных данных"

### 9.4. Управление Секретами
*   Использование Kubernetes Secrets
*   HashiCorp Vault для критичных секретов
*   Ротация ключей согласно политике безопасности

## 10. Развертывание (Deployment)

### 10.1. Инфраструктурные Файлы
*   **Dockerfile:** `backend/[service-name]/Dockerfile`
*   **Helm charts:** `deploy/charts/[service-name]/`
*   **Kubernetes манифесты:** Deployment, Service, ConfigMap, Secret, HPA

### 10.2. Зависимости при Развертывании
*   PostgreSQL (должен быть доступен)
*   Redis (должен быть доступен)
*   Kafka (должен быть доступен)
*   API Gateway (для внешнего доступа)

### 10.3. CI/CD
*   Автоматическая сборка при push в develop/main
*   Запуск тестов (unit, integration)
*   Сканирование на уязвимости
*   Автоматический деплой в dev окружение
*   Ручное подтверждение для staging/production

## 11. Мониторинг и Логирование (Logging and Monitoring)

### 11.1. Логирование
*   **Формат:** JSON структурированные логи
*   **Уровни:** debug, info, warn, error, fatal
*   **Обязательные поля:** timestamp, level, message, trace_id, service_name
*   **Интеграция:** ELK Stack (Elasticsearch, Logstash, Kibana)

### 11.2. Мониторинг
*   **Метрики Prometheus:**
    *   HTTP/gRPC запросы (rate, duration, errors)
    *   Бизнес-метрики специфичные для сервиса
    *   Использование ресурсов (CPU, memory, connections)
*   **Эндпоинт метрик:** `/metrics` (порт 9090)
*   **Дашборды:** Grafana

### 11.3. Трассировка
*   **Система:** Jaeger
*   **Интеграция:** OpenTelemetry
*   **Trace propagation:** W3C Trace Context

## 12. Нефункциональные Требования (NFRs)

*   **Производительность:**
    *   Время ответа API: p95 < 200ms, p99 < 500ms
    *   Пропускная способность: минимум 1000 RPS
*   **Надежность:**
    *   Доступность: 99.9% (три девятки)
    *   RTO: 15 минут
    *   RPO: 1 час
*   **Масштабируемость:**
    *   Горизонтальное масштабирование до 10 реплик
    *   Автоскейлинг по CPU/Memory
*   **Сопровождаемость:**
    *   Покрытие кода тестами: >80%
    *   Документация API: 100%
    *   Код-ревью обязательны

## 13. Приложения (Appendices)

*   Ссылки на дополнительную документацию
*   Примеры запросов/ответов
*   Диаграммы архитектуры
*   FAQ

---
*Этот шаблон является основой для документации микросервисов платформы. Каждый раздел должен быть адаптирован под специфику конкретного сервиса.*
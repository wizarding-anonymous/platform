# Спецификация Микросервиса: Social Service

**Версия:** 1.0
**Дата последнего обновления:** {{YYYY-MM-DD}} <!-- TODO: Update date -->

## 1. Обзор Сервиса (Overview)

### 1.1. Назначение и Роль
*   **Назначение документа:** Данный документ представляет собой полную спецификацию микросервиса Social Service.
*   **Роль в общей архитектуре платформы:** Social Service отвечает за все социальные взаимодействия на платформе, включая управление профилями пользователей, списки друзей, группы, чаты, ленты активности, отзывы, комментарии, форумы и другие социальные функции.
*   **Основные бизнес-задачи:** Способствование общению и взаимодействию между пользователями, создание активного сообщества.
*   (Источник: Спецификация Social Service, разделы 1.1, 1.2, 2.1)

### 1.2. Ключевые Функциональности
*   Управление профилями пользователей (расширенная информация, приватность, кастомизация, лента активности, черный список).
*   Управление друзьями (запросы, списки, статусы, поиск, рекомендации).
*   Управление группами (создание, членство, приватность, объявления, обсуждения).
*   Обмен сообщениями (личные и групповые чаты, статусы доставки/прочтения, история, уведомления).
*   Лента активности (события друзей и групп, лайки, комментарии, фильтрация).
*   Отзывы и комментарии (к играм и другому контенту, оценки, модерация).
*   Форумы и обсуждения (создание, управление, подписки, модерация).
*   Модерация пользовательского контента (инструменты, жалобы, автоматическая фильтрация).
*   (Источник: Спецификация Social Service, раздел 2.3)

### 1.3. Основные Технологии
*   **Язык программирования:** Go (предпочтительно) или Java/Kotlin, Python.
*   **Базы данных:** PostgreSQL (профили, группы, форумы, отзывы), Cassandra (чаты, ленты), Neo4j (граф друзей), Redis (кэш, статусы онлайн).
*   **Брокер сообщений:** Kafka или RabbitMQ.
*   **WebSocket:** Для чатов и обновлений в реальном времени (например, Gorilla WebSocket, Socket.IO).
*   **Инфраструктура:** Docker, Kubernetes, Prometheus, Grafana, ELK/Loki, OpenTelemetry/Jaeger.
*   (Источник: Спецификация Social Service, разделы 3.1.2, 3.3, 8)

### 1.4. Термины и Определения (Glossary)
*   **Лента активности:** Хронологический список событий друзей и групп.
*   **Социальный граф:** Структура связей между пользователями (дружба).
*   **Группа:** Объединение пользователей по интересам.
*   **Отзыв:** Мнение пользователя о продукте.
*   (Полный глоссарий см. в Спецификации Social Service, раздел 9)

## 2. Внутренняя Архитектура (Internal Architecture)

### 2.1. Общее Описание
*   Social Service использует многослойную архитектуру, ориентированную на обработку большого количества запросов на чтение и запись, поддержку реального времени.
*   Применяются подходы CQRS и Event Sourcing (для чатов).
*   Компоненты включают управление профилями, друзьями, группами, чатами, лентой, отзывами/комментариями, форумами, модерацией.
*   (Источник: Спецификация Social Service, разделы 3.1, 3.2)

### 2.2. Слои Сервиса
(На основе Спецификации Social Service, раздел 3.1.1)

#### 2.2.1. Presentation Layer (Слой Представления / Транспортный слой)
*   Ответственность: Обработка входящих REST, gRPC и WebSocket запросов.
*   Ключевые компоненты/модули: REST контроллеры, gRPC серверы, WebSocket хендлеры.

#### 2.2.2. Application Layer (Прикладной Слой / Сервисный слой)
*   Ответственность: Реализация бизнес-логики для каждой социальной функции. Обработка команд (запись) и запросов (чтение).
*   Ключевые компоненты/модули: Сервисы для профилей, друзей, групп, чатов, ленты, отзывов, форумов (с разделением на Command/Query handlers).

#### 2.2.3. Domain Layer (Доменный Слой)
*   Ответственность: Бизнес-сущности (UserProfile, Friendship, Group, ChatMessage, FeedItem, Review, ForumPost) и их правила.
*   Ключевые компоненты/модули: Entities, Value Objects, Domain Services, Repository Interfaces.

#### 2.2.4. Infrastructure Layer (Инфраструктурный Слой)
*   Ответственность: Взаимодействие с PostgreSQL, Cassandra, Neo4j, Redis, Kafka/RabbitMQ. Управление WebSocket соединениями. Интеграция с Notification Service.
*   Ключевые компоненты/модули: Repositories (PostgreSQL, Cassandra, Neo4j, Redis), Event producers/consumers, WebSocket management, клиенты для других сервисов.

*   (Подробную структуру проекта см. в Спецификации Social Service, раздел 3.1.2)

## 3. API Endpoints

### 3.1. REST API
*   **Аутентификация:** JWT (через Auth Service).
*   **Основные эндпоинты:**
    *   Профили: `GET /users/{userId}/profile`, `PUT /users/me/profile`.
    *   Друзья: `GET /users/me/friends`, `POST /users/me/friends/requests`, `PUT /users/me/friends/requests/{requestId}`.
    *   Группы: `GET /groups`, `POST /groups`, `GET /groups/{groupId}`.
    *   Лента: `GET /feed`, `POST /feed/{itemId}/like`.
    *   Отзывы: `GET /games/{gameId}/reviews`, `POST /games/{gameId}/reviews`.
*   (Более полный список см. в Спецификации Social Service, раздел 5.2).

### 3.2. gRPC API
*   Используется для внутреннего взаимодействия.
*   **Примеры методов:** `CheckFriendship(userId1, userId2)`, `GetUserProfileSummary(userId)`.
*   (Детали см. в Спецификации Social Service, раздел 5.3).

### 3.3. WebSocket API
*   Используется для чатов и обновлений в реальном времени.
*   **События от сервера:** `new_message`, `message_read`, `user_status_update`, `feed_update`.
*   **Сообщения от клиента:** `send_message`, `mark_message_read`.
*   (Детали см. в Спецификации Social Service, раздел 5.4).

## 4. Модели Данных (Data Models)

### 4.1. Основные Сущности
*   **UserProfile**: Расширенный профиль пользователя.
*   **Friendship**: Связь дружбы между пользователями.
*   **Group**: Группа пользователей.
*   **GroupMember**: Членство в группе.
*   **ChatMessage**: Сообщение в чате.
*   **FeedItem**: Элемент ленты активности.
*   **Review**: Отзыв на игру.
*   **Comment**: Комментарий.
*   **Forum**: Форум.
*   **ForumTopic**: Тема на форуме.
*   **ForumPost**: Сообщение на форуме.
*   (Детали см. в Спецификации Social Service, раздел 5.1).

### 4.2. Схема Базы Данных
*   **PostgreSQL**: Профили, группы, форумы, отзывы, данные модерации.
*   **Cassandra**: Сообщения чатов, ленты активности (для высокой нагрузки на запись/чтение).
*   **Neo4j**: Социальный граф (друзья).
*   **Redis**: Кэш, статусы онлайн, WebSocket соединения.
*   TODO: Предоставить DDL для каждой из используемых БД или ссылки на них. Исходная спецификация не содержит DDL.

## 5. Потоковая Обработка Событий (Event Streaming)

### 5.1. Публикуемые События (Produced Events)
*   **Система сообщений:** Kafka или RabbitMQ.
*   **Формат событий:** CloudEvents JSON (предположительно).
*   **Основные публикуемые события:** `user.profile.updated`, `friend.request.sent`, `friend.request.accepted`, `group.created`, `chat.message.sent`, `review.submitted`, `comment.posted`, `moderation.required`.
*   (Детали см. в Спецификации Social Service, раздел 5.5).

### 5.2. Потребляемые События (Consumed Events)
*   `account.user.created`: От Account Service, для создания социального профиля.
*   `library.achievement.unlocked`: От Library Service, для добавления в ленту активности.
*   `library.game.purchased`: От Library/Payment Service, для добавления в ленту.
*   `catalog.game.new_review_possible`: От Catalog Service, когда пользователь может оставить отзыв.
*   TODO: Детализировать другие потребляемые события.

## 6. Интеграции (Integrations)

### 6.1. Внутренние Микросервисы
*   **Account Service**: Получение/обновление основной информации профиля.
*   **Auth Service**: Аутентификация/авторизация.
*   **Library Service**: Данные об играх, достижениях для профилей и лент.
*   **Catalog Service**: Метаданные игр для отзывов, обсуждений.
*   **Notification Service**: Отправка уведомлений (новые сообщения, запросы в друзья).
*   **Admin Service**: Модерация контента.
*   **Analytics Service**: Сбор данных о социальной активности.
*   (Детали см. в Спецификации Social Service, разделы 1.3 и 6).

### 6.2. Внешние Системы
*   Information not found in existing documentation.

## 7. Конфигурация (Configuration)

### 7.1. Переменные Окружения
*   `SOCIAL_SERVICE_HTTP_PORT`, `SOCIAL_SERVICE_GRPC_PORT`, `SOCIAL_SERVICE_WS_PORT`.
*   DSN для PostgreSQL, Cassandra, Neo4j.
*   `REDIS_ADDR`.
*   `KAFKA_BROKERS` / `RABBITMQ_URL`.
*   Адреса других микросервисов.
*   `LOG_LEVEL`.
*   Лимиты для чатов, лент, и т.д.
*   TODO: Сформировать полный список.

### 7.2. Файлы Конфигурации (если применимо)
*   TODO: Детализировать структуру, если используется.

## 8. Обработка Ошибок (Error Handling)

### 8.1. Общие Принципы
*   Стандартные коды HTTP/gRPC/WebSocket.
*   Подробное логирование.
*   Механизмы retry для межсервисных вызовов.

### 8.2. Распространенные Коды Ошибок
*   `PROFILE_NOT_FOUND`
*   `FRIEND_REQUEST_ALREADY_SENT`
*   `USER_ALREADY_IN_GROUP`
*   `MESSAGE_VALIDATION_FAILED`
*   `CONTENT_MODERATION_FAILED`

## 9. Безопасность (Security)

### 9.1. Аутентификация
*   JWT (через Auth Service) для всех API.

### 9.2. Авторизация
*   RBAC. Проверка прав на создание/редактирование/удаление контента, управление группами, приватность профиля.

### 9.3. Защита Данных
*   Соблюдение настроек приватности пользователя.
*   Шифрование личных сообщений (TODO: уточнить необходимость end-to-end).
*   Защита от спама и вредоносного контента (автоматическая и ручная модерация).

### 9.4. Управление Секретами
*   Kubernetes Secrets или Vault.
*   (Детали см. в Спецификации Social Service, раздел 7 - Безопасность).

## 10. Развертывание (Deployment)

### 10.1. Инфраструктурные Файлы
*   **Dockerfile.**
*   **Kubernetes манифесты/Helm-чарты.**

### 10.2. Зависимости при Развертывании
*   PostgreSQL, Cassandra, Neo4j, Redis, Kafka/RabbitMQ.
*   Account, Auth, Library, Catalog, Notification, Admin Services.

### 10.3. CI/CD
*   Автоматическая сборка, тестирование, развертывание.
*   (Детали см. в Спецификации Social Service, раздел 8).

## 11. Мониторинг и Логирование (Logging and Monitoring)

### 11.1. Логирование
*   Структурированные JSON логи.
*   Интеграция с ELK/Loki.

### 11.2. Мониторинг
*   Prometheus, Grafana.
*   Метрики: количество активных пользователей, сообщений в чатах, постов в ленте, созданных групп, ошибок API, задержки.

### 11.3. Трассировка
*   OpenTelemetry/Jaeger для отслеживания запросов.
*   (Детали см. в Спецификации Social Service, раздел 8).

## 12. Нефункциональные Требования (NFRs)
*   **Производительность:** API чтения P95 < 150мс; API записи P95 < 100мс; доставка сообщений в чатах < 1 сек.
*   **Масштабируемость:** Горизонтальная. Поддержка миллионов активных пользователей.
*   **Надежность:** Доступность 99.95%. Гарантированная доставка сообщений.
*   **Безопасность:** Защита ПД, приватность, защита от спама.
*   **Согласованность данных:** Eventual consistency для лент и счетчиков, strong для остального.
*   (Детали см. в Спецификации Social Service, раздел 2.4).

## 13. Приложения (Appendices) (Опционально)
*   TODO: Детальные схемы DDL для Cassandra/Neo4j, примеры API запросов/ответов, форматы событий.

---
*Этот шаблон является отправной точкой и может быть адаптирован под конкретные нужды проекта и сервиса.*

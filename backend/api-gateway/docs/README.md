# Спецификация Компонента: API Gateway

**Версия:** 1.0
**Дата последнего обновления:** 2023-10-28

## 1. Обзор Компонента (Overview)

### 1.1. Назначение и Роль
*   API Gateway является критически важным инфраструктурным компонентом, служащим единой точкой входа для всех внешних клиентских запросов к платформе "Российский Аналог Steam".
*   Его основная роль - предоставить унифицированный и безопасный фасад для различных бэкенд-микросервисов. Он обрабатывает общие сквозные задачи, такие как маршрутизация запросов, аутентификация и авторизация, ограничение скорости (rate limiting) и терминирование SSL/TLS.
*   Основные бизнес-задачи: Упрощение клиентской разработки, повышение безопасности и управляемости платформы, централизация управления доступом к API.

### 1.2. Ключевые Функциональности
*   **Маршрутизация запросов:** Динамическая маршрутизация входящих клиентских запросов (HTTP, HTTPS, WebSocket) к соответствующим бэкенд-микросервисам на основе пути, хоста, метода или заголовков. Поддержка перезаписи пути.
*   **Аутентификация и Авторизация:** Интеграция с Auth Service для валидации учетных данных клиентов (в основном JWT, также API ключи). Может выполнять первичные проверки авторизации и внедрять контекст пользователя (ID, роли) в запросы, перенаправляемые внутренним сервисам.
*   **Ограничение скорости (Rate Limiting):** Защита бэкенд-сервисов от перегрузки путем применения лимитов на частоту запросов от отдельных клиентов.
*   **Терминирование SSL/TLS:** Обработка HTTPS запросов, их расшифровка и перенаправление (обычно по HTTP или mTLS) внутренним сервисам.
*   **Управление CORS:** Централизованное применение политик Cross-Origin Resource Sharing.
*   **Обеспечение безопасности:** Слой защиты от распространенных веб-атак, интеграция с Web Application Firewall (WAF). Применение стандартных заголовков безопасности.
*   **Трансформация запросов/ответов (опционально):** Модификация заголовков или, в редких случаях, тела запросов и ответов.
*   **Обнаружение сервисов (Service Discovery):** Интеграция с Kubernetes для динамического обнаружения и маршрутизации к работоспособным экземплярам сервисов.
*   **Мониторинг и Логирование:** Сбор метрик, логов и трейсов для всего входящего трафика.
*   **Проксирование WebSocket:** Поддержка проксирования WebSocket соединений к сервисам (например, Notification Service, Social Service).

### 1.3. Основные Технологии
*   **Рекомендуемые решения:** Kong Gateway или Tyk Gateway (согласно `project_technology_stack.md`).
*   **Оркестрация:** Kubernetes (версия 1.21+).
*   **Модель конфигурации:** Kubernetes Gateway API CRDs (предпочтительно) или специфичные CRD для Kong/Tyk. Управление конфигурацией через GitOps.
*   **Обнаружение сервисов:** Kubernetes Services.
*   **Ingress Control:** Обычно работает совместно с Ingress Controller (Nginx Ingress, Traefik).
*   (Ссылки на `project_technology_stack.md`, `project_glossary.md`)

### 1.4. Термины и Определения (Glossary)
*   См. `project_glossary.md`.
*   **CRD (Custom Resource Definition):** Расширение API Kubernetes.
*   **Ingress Controller:** Компонент Kubernetes, управляющий внешним доступом к сервисам в кластере.

## 2. Внутренняя Архитектура (Internal Architecture)

### 2.1. Общее Описание
*   API Gateway не является традиционным микросервисом с собственной сложной бизнес-логикой или базой данных. Его архитектура определяется выбранным решением (Kong, Tyk) и его интеграцией в Kubernetes.
*   Основная "логика" заключается в конфигурации маршрутов, плагинов и политик.
*   [TODO: Добавить диаграмму, показывающую место API Gateway в общей архитектуре и его взаимодействие с Auth Service, Service Discovery (K8s) и бэкенд-сервисами.]

### 2.2. Слои Сервиса (применительно к конфигурации и управлению)

#### 2.2.1. Presentation Layer (Слой Представления - Конфигурационный API/CRD)
*   Ответственность: Определяет, как администраторы или системы CI/CD конфигурируют поведение Gateway.
*   Ключевые компоненты/модули: Kubernetes Gateway API CRDs (`Gateway`, `HTTPRoute`, `TCPRoute`, etc.) или CRD выбранного вендора (KongIngress, TykAPIDefinition).

#### 2.2.2. Application Layer (Слой Применения Политик - ядро Gateway)
*   Ответственность: Применение сконфигурированных политик к трафику (маршрутизация, аутентификация, rate limiting, и т.д.). Это внутренняя логика самого продукта API Gateway.
*   Ключевые компоненты/модули: Механизмы обработки запросов, система плагинов (в Kong/Tyk).

#### 2.2.3. Domain Layer (Доменный Слой - отсутствует в традиционном понимании)
*   API Gateway оперирует понятиями "маршрут", "сервис", "потребитель", "плагин", которые являются его "доменом". Эти концепции отражены в его конфигурационных моделях.

#### 2.2.4. Infrastructure Layer (Инфраструктурный Слой - интеграции Gateway)
*   Ответственность: Взаимодействие с Kubernetes API (для service discovery, чтения CRD), Auth Service (для валидации токенов), системами мониторинга/логирования.
*   Ключевые компоненты/модули: Клиенты Kubernetes, HTTP/gRPC клиенты для Auth Service, экспортеры метрик/логов/трейсов.

## 3. API Endpoints (Конфигурируемые маршруты)

API Gateway сам по себе не определяет бизнес-эндпоинты, а **маршрутизирует** запросы к эндпоинтам, определенным в бэкенд-микросервисах.
*   См. документацию каждого микросервиса для деталей их API.
*   См. `project_api_standards.md` для общих стандартов API, которые API Gateway помогает обеспечивать.

**Примеры конфигурации маршрутов (концептуально, используя Kubernetes Gateway API):**
```yaml
# kind: HTTPRoute
# metadata:
#   name: auth-service-route
# spec:
#   parentRefs:
#   - name: main-gateway
#   hostnames: ["api.gameplatform.ru"]
#   rules:
#   - matches:
#     - path:
#         type: PathPrefix
#         value: /api/v1/auth
#     backendRefs:
#     - name: auth-service
#       port: 80
# ---
# kind: HTTPRoute
# metadata:
#   name: account-service-route
# spec:
#   parentRefs:
#   - name: main-gateway
#   hostnames: ["api.gameplatform.ru"]
#   rules:
#   - matches:
#     - path:
#         type: PathPrefix
#         value: /api/v1/users # Пример маршрутизации /users к Account Service
#     filters: # Пример применения политики JWT аутентификации
#     - type: RequestHeaderModifier # Это упрощенный пример, реальная JWT валидация сложнее
#       requestHeaderModifier:
#         add:
#         - name: X-Authenticated-By
#           value: "jwt-plugin"
#     backendRefs:
#     - name: account-service
#       port: 80
```
*   [TODO: Добавить более реалистичные примеры конфигурации для выбранного Gateway решения (Kong/Tyk) или Gateway API CRDs, включая плагины для JWT, rate limiting, CORS.]

## 4. Модели Данных (Data Models - Конфигурационные)

API Gateway не хранит бизнес-данные. Его "модели данных" - это структуры его конфигурации:
*   **Маршруты (Routes):** Определения правил сопоставления запросов.
*   **Сервисы (Services):** Определения вышестоящих (upstream) бэкенд-сервисов.
*   **Потребители (Consumers):** (Если используется) Определения клиентов API, к которым могут применяться специфичные политики.
*   **Плагины (Plugins):** Конфигурации для расширения функциональности (например, JWT-валидация, rate-limiting, CORS).
*   Эти модели определяются CRD Kubernetes или собственным форматом конфигурации API Gateway.

## 5. Потоковая Обработка Событий (Event Streaming)

API Gateway обычно не участвует напрямую в потоковой обработке бизнес-событий через Kafka, но он может:
*   Генерировать собственные операционные события/логи (например, логи доступа, ошибки маршрутизации) которые могут отправляться в систему логирования/мониторинга и далее в Kafka для анализа.
*   Проксировать WebSocket соединения, которые используются для потоковой передачи данных между клиентами и бэкенд-сервисами.

## 6. Интеграции (Integrations)

### 6.1. Внутренние Микросервисы
*   **Auth Service:**
    *   Тип интеграции: HTTP/gRPC вызовы.
    *   Назначение: Валидация JWT токенов, проверка API ключей. API Gateway может кэшировать публичные ключи (JWKS) от Auth Service.
    *   Контракт: Эндпоинт Auth Service для валидации токена или получения JWKS.
*   **Все бэкенд-микросервисы (Account, Catalog, Library, etc.):**
    *   Тип интеграции: HTTP/gRPC/WebSocket проксирование.
    *   Назначение: Перенаправление клиентских запросов к соответствующим сервисам.
    *   Контракт: API этих сервисов. API Gateway добавляет заголовки (`X-User-ID`, `X-User-Roles`) после успешной аутентификации.
*   **Kubernetes API (Service Discovery):**
    *   Тип интеграции: Внутренняя интеграция выбранного Gateway решения с K8s.
    *   Назначение: Обнаружение эндпоинтов (IP-адресов и портов) бэкенд-сервисов.

### 6.2. Внешние Системы
*   **Клиентские приложения (веб, мобильные, десктопные):** Являются основными потребителями API через Gateway.
*   **WAF (Web Application Firewall) (опционально):** Gateway может находиться за WAF или интегрироваться с ним.
*   **Системы Мониторинга/Логирования/Трассировки (Prometheus, ELK/Loki, Jaeger):** Экспорт данных.

## 7. Конфигурация (Configuration)

### 7.1. Переменные Окружения (для самого Gateway)
*   Зависят от выбранного решения (Kong, Tyk). Обычно включают адреса для подключения к Kubernetes API, конфигурационной БД (если есть у Gateway, например, PostgreSQL у Kong), кластеру логирования/мониторинга.
*   Пример для Kong: `KONG_DATABASE=postgres`, `KONG_PG_HOST=kong-db`, `KONG_PROXY_LISTEN=0.0.0.0:8000`.
*   [TODO: Указать ключевые переменные окружения для выбранного решения Gateway].

### 7.2. Файлы Конфигурации (Declarative Configuration)
*   Основная конфигурация маршрутов, сервисов, плагинов осуществляется декларативно через YAML файлы (CRDs), хранящиеся в Git и применяемые через CI/CD (GitOps).
*   Примеры файлов см. в `deploy/api-gateway/` (предполагаемое расположение).
*   (Ссылка на `project_deployment_standards.md` для общих принципов GitOps).

## 8. Обработка Ошибок (Error Handling)

### 8.1. Общие Принципы
*   API Gateway должен возвращать стандартизированные коды ошибок HTTP согласно `project_api_standards.md`.
*   Ошибки от бэкенд-сервисов проксируются клиенту (возможно, с маскировкой деталей внутренних ошибок).
*   Собственные ошибки Gateway (например, ошибка маршрутизации, сбой плагина аутентификации) также должны быть стандартизированы.

### 8.2. Распространенные Коды Ошибок (генерируемые Gateway)
*   **`400 Bad Request`**: Некорректный запрос к Gateway.
*   **`401 Unauthorized`**: Ошибка плагина аутентификации (невалидный токен, отсутствующий токен).
*   **`403 Forbidden`**: Доступ запрещен на уровне Gateway (например, по IP, или плагином авторизации).
*   **`404 Not Found`**: Маршрут не найден для запрошенного пути/хоста.
*   **`429 Too Many Requests`**: Сработал Rate Limiting.
*   **`502 Bad Gateway`**: Бэкенд-сервис вернул некорректный ответ или недоступен.
*   **`503 Service Unavailable`**: Бэкенд-сервис недоступен (например, сработал Circuit Breaker) или сам Gateway перегружен.
*   **`504 Gateway Timeout`**: Бэкенд-сервис не ответил вовремя.

## 9. Безопасность (Security)

### 9.1. Аутентификация
*   Централизованная проверка JWT токенов / API ключей через интеграцию с Auth Service.

### 9.2. Авторизация
*   Может выполнять грубую авторизацию на основе ролей из токена (например, доступ к `/admin/*` только для роли `admin`). Детальная авторизация остается за бэкенд-сервисами.

### 9.3. Защита Данных
*   Терминирование SSL/TLS.
*   Применение заголовков безопасности (HSTS, CSP, X-Frame-Options и т.д.).
*   Скрытие внутренней сетевой топологии.
*   (Ссылка на `project_security_standards.md`)

### 9.4. Управление Секретами
*   Секреты, используемые Gateway (например, для mTLS с бэкендами, ключи для плагинов), управляются через Kubernetes Secrets.

## 10. Развертывание (Deployment)

### 10.1. Инфраструктурные Файлы
*   Helm-чарты или Kubernetes манифесты для развертывания выбранного Gateway (Kong/Tyk).
*   Конфигурационные YAML файлы для CRD (маршруты, плагины).
*   (Ссылка на `project_deployment_standards.md`)

### 10.2. Зависимости при Развертывании
*   Kubernetes кластер.
*   Auth Service (для валидации токенов).
*   Service Discovery (встроенное в Kubernetes).

### 10.3. CI/CD
*   Пайплайны для применения конфигураций Gateway (маршруты, плагины) из Git в кластер (GitOps).
*   Обновление версий самого Gateway.

## 11. Мониторинг и Логирование (Logging and Monitoring)

### 11.1. Логирование
*   Формат: Зависит от Gateway (например, Nginx access log format для Kong). Должен быть настроен на JSON или другой структурированный формат.
*   Ключевые события: Логи доступа (каждый запрос), ошибки маршрутизации, ошибки плагинов.
*   Интеграция: ELK/Loki.
*   (Ссылка на `project_observability_standards.md`)

### 11.2. Мониторинг
*   Метрики (Prometheus):
    *   Количество запросов (total, per route, per service).
    *   Задержка запросов (latency - upstream, request, Kong/Tyk latency).
    *   Коды ответов HTTP (количество 2xx, 3xx, 4xx, 5xx).
    *   Состояние бэкенд-сервисов (health checks).
    *   Использование ресурсов Gateway.
*   Дашборды (Grafana): Обзор трафика, производительность API, ошибки.
*   Алерты (AlertManager): Высокий % ошибок 5xx, большая задержка, недоступность upstream сервисов.
*   (Ссылка на `project_observability_standards.md`)

### 11.3. Трассировка
*   Интеграция: OpenTelemetry, Jaeger. Gateway должен участвовать в создании/продолжении трейсов, передавая контекст бэкенд-сервисам.
*   (Ссылка на `project_observability_standards.md`)

## 12. Нефункциональные Требования (NFRs)
*   **Производительность**: Минимальная дополнительная задержка (P99 < 10-20 мс). Высокая пропускная способность (тысячи RPS).
*   **Масштабируемость**: Горизонтальное масштабирование экземпляров Gateway.
*   **Надежность**: Высокая доступность (>99.99%). Отказоустойчивость.
*   **Безопасность**: Надежная защита от внешних угроз, безопасная обработка учетных данных.
*   [TODO: Уточнить конкретные цифры NFR]

## 13. Приложения (Appendices) (Опционально)
*   [TODO: Примеры полной конфигурации для ключевых маршрутов и плагинов.]

---
*Этот документ является отправной точкой и должен регулярно обновляться по мере развития конфигурации API Gateway.*

# Спецификация Микросервиса: Admin Service

**Версия:** 1.0
**Дата последнего обновления:** 2023-10-28

## 1. Обзор Сервиса (Overview)

### 1.1. Назначение и Роль
*   Admin Service является центральным компонентом платформы "Российский Аналог Steam", предоставляющим инструменты и интерфейсы для администраторов платформы и сотрудников службы поддержки.
*   Его основная роль - управление и надзор за различными аспектами платформы, включая модерацию контента, управление пользователями, операции технической поддержки, мониторинг безопасности, конфигурацию общесистемных настроек, административную аналитику и управление маркетинговыми кампаниями.
*   Основные бизнес-задачи: обеспечение операционного контроля, поддержка пользователей, модерация контента, управление системными параметрами.

### 1.2. Ключевые Функциональности
*   **Управление модерацией контента:** Управление рабочими процессами модерации пользовательского и разработческого контента (игры, отзывы, комментарии, профили). Поддержка автоматизированных и ручных процессов.
*   **Управление пользователями платформы:** Поиск, просмотр, управление статусами пользователей (активация, блокировка), управление ролями.
*   **Управление административными пользователями:** Управление учетными записями и разрешениями сотрудников.
*   **Техническая поддержка:** Система управления тикетами поддержки (категоризация, назначение, ответы), база знаний.
*   **Мониторинг безопасности:** Инструменты для выявления подозрительной активности, анализа платежей, управления IP-блокировками, аудита действий администраторов.
*   **Управление настройками платформы:** Конфигурация глобальных и региональных параметров, операционных лимитов.
*   **Административная аналитика:** Дашборды и отчеты по метрикам платформы (продажи, активность пользователей, эффективность модерации).
*   **Управление маркетинговыми кампаниями:** Создание и управление промо-акциями, скидками, специальными предложениями.

### 1.3. Основные Технологии
*   **Язык программирования:** Go (предпочтительно, в соответствии с `project_technology_stack.md`)
*   **REST Framework:** Echo (согласно `project_technology_stack.md`)
*   **gRPC Framework:** google.golang.org/grpc (для возможного внутреннего использования или API для других админ-тулов)
*   **База данных:** PostgreSQL (для структурированных данных: админ-пользователи, тикеты, настройки), MongoDB (для логов аудита, сложных данных модерации).
*   **Поисковый движок:** Elasticsearch (для поиска по логам, тикетам).
*   **Кэширование:** Redis.
*   **Брокер сообщений:** Kafka (для асинхронных задач, например, генерация отчетов, массовые операции).
*   (Ссылки на `project_technology_stack.md`, `project_glossary.md`)

### 1.4. Термины и Определения (Glossary)
*   См. `project_glossary.md`.
*   **Модерация (Moderation):** Процесс проверки и управления контентом.
*   **Тикет поддержки (Support Ticket):** Запрос пользователя в службу поддержки.
*   **База знаний (Knowledge Base):** Сборник статей для решения проблем.

## 2. Внутренняя Архитектура (Internal Architecture)

### 2.1. Общее Описание
*   Сервис может быть реализован как модульный монолит или набор тесно связанных микро-модулей, придерживаясь принципов чистой архитектуры.
*   Основные модули: Модерация, Управление пользователями, Поддержка, Безопасность, Настройки, Аналитика, Маркетинг.
*   [Диаграмма верхнеуровневой архитектуры Admin Service будет добавлена в будущих версиях документации.]

### 2.2. Слои Сервиса

#### 2.2.1. Presentation Layer (Слой Представления)
*   Ответственность: Обработка входящих HTTP (REST) запросов от административной панели. Валидация DTO.
*   Ключевые компоненты/модули:
    *   HTTP Handlers (Echo): Эндпоинты для всех административных функций.
    *   DTOs: Структуры для передачи данных.
    *   Валидаторы.

#### 2.2.2. Application Layer (Прикладной Слой)
*   Ответственность: Координация бизнес-логики для каждого административного модуля.
*   Ключевые компоненты/модули:
    *   Use Case Services: `ModerationService`, `UserManagementService`, `SupportTicketService`, `PlatformSettingsService`, etc.
    *   Интерфейсы для репозиториев и клиентов других сервисов.

#### 2.2.3. Domain Layer (Доменный Слой)
*   Ответственность: Бизнес-сущности и правила.
*   Ключевые компоненты/модули:
    *   Entities: `AdminUser`, `ModerationQueue`, `ModerationItem`, `ModerationDecision`, `SupportTicket`, `KnowledgeBaseArticle`, `SystemSetting`, `PlatformUserView` (агрегированные данные о пользователе).
    *   Domain Events: `ContentModeratedEvent`, `UserStatusChangedByAdminEvent`, `TicketResolvedEvent`.

#### 2.2.4. Infrastructure Layer (Инфраструктурный Слой)
*   Ответственность: Взаимодействие с PostgreSQL, MongoDB, Elasticsearch, Redis, Kafka. Клиенты для других микросервисов.
*   Ключевые компоненты/модули:
    *   PostgreSQL/MongoDB Repositories.
    *   Elasticsearch Client.
    *   Redis Cache.
    *   Kafka Producers/Consumers.
    *   gRPC/REST клиенты для Account Service, Catalog Service, Payment Service и др.

## 3. API Endpoints

### 3.1. REST API
*   **Базовый URL (через API Gateway):** `/api/v1/admin`
*   **Аутентификация:** JWT Bearer Token (проверяется API Gateway, UserID администратора и его роли передаются в заголовках).
*   **Авторизация:** На основе ролей администратора (см. `project_roles_and_permissions.md`).
*   (Общие принципы см. `project_api_standards.md`)

#### 3.1.1. Ресурс: Управление Пользователями Платформы
*   **`GET /platform-users`**
    *   Описание: Поиск и получение списка пользователей платформы.
    *   Query параметры: `search_query`, `status`, `role`, `page`, `per_page`, `sort_by`.
    *   Пример ответа: `{ "data": [ { "user_id": "...", "username": "...", "email": "...", "status": "..." } ], "meta": { ... } }`
    *   Требуемые права доступа: `admin`, `support` (с ограничениями).
*   **`GET /platform-users/{user_id}`**
    *   Описание: Получение детальной информации о пользователе платформы (включая связанные данные из других сервисов).
    *   Требуемые права доступа: `admin`, `support`.
*   **`PUT /platform-users/{user_id}/status`**
    *   Описание: Изменение статуса пользователя (например, `block`, `unblock`, `verify_manually`).
    *   Тело запроса: `{ "data": { "type": "userStatus", "attributes": { "status": "blocked", "reason": "Нарушение правил" } } }`
    *   Требуемые права доступа: `admin`.
*   **`PUT /platform-users/{user_id}/roles`**
    *   Описание: Изменение ролей пользователя.
    *   Тело запроса: `{ "data": { "type": "userRoles", "attributes": { "roles": ["user", "moderator_trainee"] } } }`
    *   Требуемые права доступа: `admin`.
*   [Эндпоинты для просмотра истории действий пользователя, сессий и других связанных данных будут детализированы в последующих версиях.]

#### 3.1.2. Ресурс: Модерация Контента
*   **`GET /moderation/queues`**
    *   Описание: Получение списка очередей модерации (например, "Отзывы на игры", "Новые игры", "Жалобы на пользователей").
    *   Требуемые права доступа: `moderator`, `admin`.
*   **`GET /moderation/queues/{queue_name}/items`**
    *   Описание: Получение элементов из конкретной очереди модерации.
    *   Query параметры: `page`, `per_page`, `filter_status`.
    *   Требуемые права доступа: `moderator`, `admin`.
*   **`GET /moderation/items/{item_id}`**
    *   Описание: Получение конкретного элемента на модерацию.
    *   Требуемые права доступа: `moderator`, `admin`.
*   **`POST /moderation/items/{item_id}/decisions`**
    *   Описание: Принятие решения по элементу модерации (approve, reject, escalate).
    *   Тело запроса: `{ "data": { "type": "moderationDecision", "attributes": { "decision": "approved", "comment": "Соответствует правилам" } } }`
    *   Требуемые права доступа: `moderator`, `admin`.
*   [Эндпоинты для управления правилами модерации и просмотра истории модерации будут детализированы в последующих версиях.]

#### 3.1.3. Ресурс: Техническая Поддержка
*   **`GET /support/tickets`**
    *   Описание: Получение списка тикетов поддержки.
    *   Query параметры: `status`, `assignee_id`, `priority`, `user_id`, `search_query`, `page`, `per_page`.
    *   Требуемые права доступа: `support`, `admin`.
*   **`POST /support/tickets`**
    *   Описание: Создание тикета от имени пользователя (например, если обращение пришло по другому каналу).
    *   Требуемые права доступа: `support`, `admin`.
*   **`GET /support/tickets/{ticket_id}`**
    *   Описание: Получение информации о конкретном тикете.
    *   Требуемые права доступа: `support`, `admin`.
*   **`POST /support/tickets/{ticket_id}/responses`**
    *   Описание: Добавление ответа в тикет.
    *   Требуемые права доступа: `support`, `admin`.
*   **`PUT /support/tickets/{ticket_id}/status`**
    *   Описание: Изменение статуса тикета (open, pending, resolved, closed).
    *   Требуемые права доступа: `support`, `admin`.
*   **`GET /support/knowledge-base`**
    *   Описание: Поиск и получение статей из базы знаний.
    *   Требуемые права доступа: `support`, `admin`.
*   **`POST /support/knowledge-base`**
    *   Описание: Создание новой статьи в базе знаний.
    *   Требуемые права доступа: `admin`, `support_lead`.
*   [Эндпоинты для управления категориями тикетов, назначения ответственных и шаблонов ответов будут детализированы в последующих версиях.]

#### 3.1.4. Ресурс: Настройки Платформы
*   **`GET /platform-settings`**
    *   Описание: Получение текущих настроек платформы.
    *   Требуемые права доступа: `admin`.
*   **`PUT /platform-settings`**
    *   Описание: Обновление настроек платформы.
    *   Тело запроса: `{ "data": { "type": "platformSettings", "attributes": { "maintenance_mode": false, "global_message": "..." } } }`
    *   Требуемые права доступа: `admin`.
*   [Детальная структура настроек платформы и их возможные группы будут определены и описаны в последующих версиях документа.]

#### 3.1.5. Ресурс: Управление Администраторами
*   **`GET /admin-users`**
    *   Описание: Список административных пользователей.
    *   Требуемые права доступа: `admin` (супер-администратор).
*   **`POST /admin-users`**
    *   Описание: Создание нового административного пользователя.
    *   Требуемые права доступа: `admin` (супер-администратор).
*   [Эндпоинты для управления ролями и правами администраторов будут детализированы в последующих версиях.]

### 3.2. gRPC API
*   [Возможность и спецификация gRPC эндпоинтов для Admin Service будут рассмотрены и, при необходимости, добавлены в будущих версиях.]

### 3.3. WebSocket API (если применимо)
*   [Возможность и спецификация WebSocket API для Admin Service (например, для real-time дашбордов) будут рассмотрены и, при необходимости, добавлены в будущих версиях.]

## 4. Модели Данных (Data Models)

### 4.1. Основные Сущности
*   **AdminUser**: Администратор (ID, UserID из Auth, роли админа).
*   **ModerationItem**: Элемент на модерации (ID, content_type, content_id, status, assigned_moderator_id).
*   **ModerationDecision**: Решение по модерации.
*   **SupportTicket**: Тикет поддержки.
*   **SupportTicketResponse**: Ответ в тикете.
*   **KnowledgeBaseArticle**: Статья базы знаний.
*   **PlatformSetting**: Параметр настройки платформы (ключ, значение, описание).
*   **AuditLogAdmin**: Лог действий администраторов.
*   [Детальные поля для каждой сущности будут определены и описаны в последующих версиях документа или в соответствующих разделах моделей данных.]

### 4.2. Схема Базы Данных
*   **PostgreSQL**:
    ```sql
    -- Таблица: admin_users (пример)
    CREATE TABLE admin_users (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        auth_user_id UUID NOT NULL UNIQUE, -- Ссылка на пользователя в Auth Service
        roles JSONB NOT NULL DEFAULT '[]'::jsonb, -- Список админских ролей
        is_active BOOLEAN NOT NULL DEFAULT TRUE,
        created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );

    -- Таблица: moderation_items (пример)
    CREATE TABLE moderation_items (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        item_type VARCHAR(100) NOT NULL, -- 'game_review', 'user_profile', 'game_submission'
        item_id VARCHAR(255) NOT NULL, -- ID сущности в другом сервисе
        status VARCHAR(50) NOT NULL DEFAULT 'pending', -- 'pending', 'approved', 'rejected', 'escalated'
        reason TEXT,
        moderator_id UUID REFERENCES admin_users(id),
        created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );
    CREATE INDEX idx_moderation_items_status_type ON moderation_items(status, item_type);

    -- Таблица: support_tickets (пример)
    CREATE TABLE support_tickets (
        id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
        user_id UUID, -- ID пользователя платформы
        title VARCHAR(255) NOT NULL,
        description TEXT NOT NULL,
        status VARCHAR(50) NOT NULL DEFAULT 'open', -- 'open', 'pending', 'resolved', 'closed'
        priority VARCHAR(50) DEFAULT 'medium',
        assignee_admin_id UUID REFERENCES admin_users(id),
        category VARCHAR(100),
        created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
    );
    -- Другие таблицы: platform_settings, audit_log_admin и т.д.
    ```
*   **MongoDB**: Для хранения деталей элементов модерации (если они сложные и неструктурированные), расширенных логов.
*   **Elasticsearch**: Индексы для поиска по тикетам, статьям базы знаний, логам.
*   [Mermaid ERD и более детальные DDL для Admin Service будут добавлены в будущих версиях документации.]

## 5. Потоковая Обработка Событий (Event Streaming)

### 5.1. Публикуемые События (Produced Events)
*   **Система сообщений:** Kafka.
*   **Формат событий:** CloudEvents JSON.
*   **Основные топики:** `admin.events`.

*   **`admin.content.moderated.v1`**
    *   Описание: Контент прошел модерацию (одобрен/отклонен).
    *   Структура Payload: `{ "item_id": "...", "item_type": "...", "decision": "approved/rejected", "moderator_id": "...", "timestamp": "..." }`
    *   Потребители: Catalog Service, Social Service, Developer Service, Notification Service.
*   **`admin.user.status.changed.v1`**
    *   Описание: Статус пользователя изменен администратором.
    *   Структура Payload: `{ "user_id": "...", "new_status": "blocked/active", "admin_id": "...", "reason": "...", "timestamp": "..." }`
    *   Потребители: Auth Service, Account Service, Notification Service.
*   **`admin.platform.setting.updated.v1`**
    *   Описание: Изменена настройка платформы.
    *   Структура Payload: `{ "setting_key": "...", "old_value": "...", "new_value": "...", "admin_id": "...", "timestamp": "..." }`
    *   Потребители: Различные сервисы, которым важна эта настройка.
*   [Другие релевантные публикуемые события будут определены и добавлены по мере развития функционала.]

### 5.2. Потребляемые События (Consumed Events)
*   **`user.complaint.submitted.v1`** (от Social Service или других)
    *   Описание: Пользователь подал жалобу на контент или другого пользователя.
    *   Логика обработки: Создать новый `ModerationItem` в очереди.
*   **`developer.game.submitted.v1`** (от Developer Service)
    *   Описание: Разработчик отправил игру/обновление на модерацию.
    *   Логика обработки: Создать новый `ModerationItem` в очереди "Game Submissions".
*   **`payment.fraud.detected.v1`** (от Payment Service или Analytics Service)
    *   Описание: Обнаружена подозрительная финансовая активность.
    *   Логика обработки: Создать инцидент безопасности или задачу для администратора.
*   [Другие релевантные потребляемые события будут определены и добавлены по мере развития интеграционных сценариев.]

## 6. Интеграции (Integrations)

### 6.1. Внутренние Микросервисы
*   **Account Service:** Для управления данными пользователей платформы (просмотр, изменение статуса, ролей).
*   **Auth Service:** Для управления административными пользователями и их правами; для получения информации о сессиях пользователей.
*   **Catalog Service:** Для модерации игрового контента, управления видимостью игр.
*   **Developer Service:** Для обработки заявок на публикацию игр от разработчиков.
*   **Social Service:** Для модерации пользовательского контента (отзывы, комментарии, сообщения).
*   **Payment Service:** Для обработки запросов на возврат средств, анализа транзакций, управления промо-акциями.
*   **Analytics Service:** Для получения данных для административных отчетов и дашбордов; для отправки событий о действиях админов.
*   **Notification Service:** Для отправки системных уведомлений, уведомлений пользователям по результатам модерации или решения тикетов.
*   **Download Service:** Для управления доступностью игровых файлов (например, после модерации).
*   **Library Service:** Для управления библиотеками пользователей в исключительных случаях.

### 6.2. Внешние Системы
*   [Интеграции Admin Service с внешними системами (например, анти-чит, анализ контента) будут определены и описаны в последующих версиях, если потребуется.]

## 7. Конфигурация (Configuration)

### 7.1. Переменные Окружения
*   `ADMIN_HTTP_PORT`
*   `POSTGRES_DSN_ADMIN`
*   `MONGODB_URI_ADMIN`
*   `ELASTICSEARCH_URLS_ADMIN`
*   `REDIS_ADDR_ADMIN`
*   `KAFKA_BROKERS`
*   `KAFKA_TOPIC_ADMIN_EVENTS`
*   `AUTH_SERVICE_GRPC_ADDR`
*   `ACCOUNT_SERVICE_GRPC_ADDR` (или REST API)
*   ... адреса других сервисов
*   `LOG_LEVEL`
*   `DEFAULT_MODERATION_QUEUE_SIZE`
*   `SUPPORT_TICKET_SLA_HOURS_HIGH_PRIORITY`
*   `OTEL_EXPORTER_JAEGER_ENDPOINT`
*   [Список переменных окружения будет дополняться по мере необходимости и детализации конфигурации сервиса.]

### 7.2. Файлы Конфигурации (если применимо)
*   `configs/admin_config.yaml`: Может содержать правила модерации, настройки по умолчанию для различных модулей.

## 8. Обработка Ошибок (Error Handling)

### 8.1. Общие Принципы
*   Стандартные форматы ошибок REST API.
*   Подробное логирование для аудита и отладки.

### 8.2. Распространенные Коды Ошибок
*   **`USER_NOT_FOUND`**
*   **`ITEM_NOT_IN_MODERATION_QUEUE`**
*   **`INVALID_MODERATION_DECISION`**
*   **`TICKET_ALREADY_CLOSED`**
*   **`SETTING_VALIDATION_FAILED`**
*   (В дополнение к стандартным HTTP ошибкам)

## 9. Безопасность (Security)

### 9.1. Аутентификация
*   JWT для доступа к Admin API, проверка ролей администратора.

### 9.2. Авторизация
*   Гранулярная RBAC для администраторов (супер-админ, модератор контента, специалист поддержки, финансовый администратор и т.д.).
*   (Ссылка на `project_roles_and_permissions.md`)

### 9.3. Защита Данных
*   Защита чувствительных данных пользователей и платформы, к которым имеют доступ администраторы.
*   Шифрование при передаче и хранении (где применимо).
*   (Ссылка на `project_security_standards.md`)

### 9.4. Управление Секретами
*   Использование Kubernetes Secrets или Vault.

### 9.5. Аудит Действий
*   Все действия администраторов должны подробно логироваться в специальный аудит-лог (`AuditLogAdmin`).

## 10. Развертывание (Deployment)

### 10.1. Инфраструктурные Файлы
*   Dockerfile.
*   Helm-чарты/Kubernetes манифесты.
*   (Ссылка на `project_deployment_standards.md`)

### 10.2. Зависимости при Развертывании
*   PostgreSQL, MongoDB, Elasticsearch, Redis, Kafka.
*   Практически все остальные микросервисы платформы для выполнения своих функций.

### 10.3. CI/CD
*   Стандартный пайплайн.
*   (Ссылка на `project_deployment_standards.md`)

## 11. Мониторинг и Логирование (Logging and Monitoring)

### 11.1. Логирование
*   Формат: JSON.
*   Ключевые события: Действия администраторов, решения по модерации, изменения статусов тикетов, ошибки.
*   Интеграция: ELK/Loki.
*   (Ссылка на `project_observability_standards.md`)

### 11.2. Мониторинг
*   Метрики (Prometheus):
    *   Количество элементов в очередях модерации.
    *   Среднее время принятия решения по модерации.
    *   Количество открытых/закрытых тикетов поддержки.
    *   Активность администраторов.
    *   Ошибки API.
*   Дашборды (Grafana).
*   Алерты (AlertManager): Переполнение очередей модерации, большое количество нерешенных тикетов, ошибки сервиса.
*   (Ссылка на `project_observability_standards.md`)

### 11.3. Трассировка
*   Интеграция: OpenTelemetry, Jaeger.
*   (Ссылка на `project_observability_standards.md`)

## 12. Нефункциональные Требования (NFRs)
*   **Производительность**: Быстрый отклик интерфейсов админ-панели (P95 < 500мс для большинства операций). Способность обрабатывать большие объемы данных для аналитики и модерации.
*   **Надежность**: Высокая доступность, так как от этого зависит управление платформой.
*   **Безопасность**: Критически важна, так как сервис имеет доступ ко многим аспектам платформы.
*   **Масштабируемость**: Должен масштабироваться для обработки растущего объема контента и количества администраторов/модераторов.
*   [Конкретные нефункциональные требования (NFR) для Admin Service будут определены и добавлены на последующих этапах проектирования.]

## 13. Приложения (Appendices) (Опционально)
*   [Детальные JSON схемы для API, примеры конфигураций и другие приложения будут добавлены в последующих версиях документации или в отдельных специализированных документах.]

---
*Этот документ является отправной точкой и должен регулярно обновляться по мере развития сервиса.*

## 14. Связанные Рабочие Процессы (Related Workflows)
*   [Developer Submits a New Game for Moderation](../../../project_workflows/game_submission_flow.md)

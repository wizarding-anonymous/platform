# Спецификация Микросервиса: Admin Service

**Версия:** 1.0
**Дата последнего обновления:** 2025-05-24

## 1. Обзор Сервиса (Overview)

### 1.1. Назначение и Роль
*   **Назначение документа:** Данный документ представляет собой полную спецификацию микросервиса Admin Service. Он описывает требования, архитектуру, бизнес-логику, API, интеграции и нефункциональные требования.
*   **Роль в общей архитектуре платформы:** Admin Service является ключевым компонентом платформы, обеспечивающим административные функции для сотрудников компании. Это центральный узел административного контроля.
*   **Основные бизнес-задачи:** Модерация контента, управление пользователями, техническая поддержка, мониторинг безопасности, управление системными настройками, генерация отчетов, управление маркетинговыми акциями.

### 1.2. Ключевые Функциональности
*   **Модерация контента:** Игры, отзывы, комментарии, сообщения, профили. Автоматическая и ручная модерация.
*   **Управление пользователями:** Поиск, управление статусами, ролями, верификацией, объединение аккаунтов.
*   **Техническая поддержка:** Система тикетов, чат поддержки, база знаний, шаблоны ответов, эскалация.
*   **Мониторинг безопасности:** Выявление подозрительной активности, анализ платежей, мониторинг попыток взлома, управление IP-блокировками, аудит действий администраторов.
*   **Управление настройками платформы:** Глобальные и региональные параметры, лимиты, уведомления, баннеры, технические работы.
*   **Административная аналитика:** Дашборды, отчеты (продажи, пользователи, контент, модерация, поддержка), экспорт данных.
*   **Маркетинговые кампании:** Создание акций, управление баннерами, промокоды, спецпредложения, уведомления.

### 1.3. Основные Технологии
*   **Язык программирования:** Go / Python / Java / Node.js (будет согласован).
*   **Фреймворк:** Gin (Go), Django/Flask (Python), Spring Boot (Java), Express (Node.js).
*   **Базы данных:** PostgreSQL (реляционные данные), MongoDB (сложные структуры, логи).
*   **Кэширование:** Redis.
*   **Очереди сообщений:** Kafka или RabbitMQ.
*   **Поисковый движок:** Elasticsearch.
*   **Инфраструктура:** Docker, Kubernetes.

### 1.4. Термины и Определения (Glossary)
*   Для специфичных терминов см. "Единый глоссарий терминов и определений для российского аналога Steam.txt".
*   Основные понятия, такие как "Модерация", "Тикет поддержки", "Маркетинговая кампания", определяются в контексте соответствующих разделов.

## 2. Внутренняя Архитектура (Internal Architecture)

### 2.1. Общее Описание
*   Admin Service будет реализован как модульный монолит или набор тесно связанных микросервисов.
*   Внутренняя архитектура будет следовать принципам чистой архитектуры или слоистой архитектуры.
*   Основные компоненты включают API Gateway (внутренний или общий), и модули по основным функциям (Модерация, Управление пользователями, Тех. поддержка, Безопасность, Настройки, Аналитика, Маркетинг), а также веб-интерфейс (Административная панель).

### 2.2. Слои Сервиса
(Предполагаемая структура на основе общих принципов)

#### 2.2.1. Presentation Layer (Слой Представления)
*   Ответственность: Обработка входящих HTTP запросов от административной панели, валидация, преобразование DTO.
*   Ключевые компоненты/модули:
    *   HTTP Handlers/Controllers: Для каждого модуля (модерации, управления пользователями и т.д.).
    *   DTOs: Для запросов и ответов API.
    *   Валидаторы: Для проверки входных данных.

#### 2.2.2. Application Layer (Прикладной Слой / Слой Сценариев Использования)
*   Ответственность: Координация бизнес-логики для выполнения административных задач, взаимодействие с Domain Layer и Infrastructure Layer.
*   Ключевые компоненты/модули:
    *   Use Case Services: Например, `ModerateContentService`, `ManageUserService`, `CreateMarketingCampaignService`.
    *   Интерфейсы для репозиториев и клиентов других сервисов.

#### 2.2.3. Domain Layer (Доменный Слой)
*   Ответственность: Бизнес-сущности (например, `ModerationItem`, `SupportTicket`, `SystemSetting`, `AdminUser`), бизнес-правила для административных операций.
*   Ключевые компоненты/модули:
    *   Entities: `AdminUser`, `ModerationQueue`, `ModerationItem`, `ModerationDecision`, `SupportTicket`, `SupportMessage`, `KnowledgeBaseArticle`, `SystemSetting`, `SecurityIncident`, `BlockedIP`, `MarketingCampaign`, `Banner`, `PromoCode`, `AdminActionLog`.
    *   Интерфейсы репозиториев.

#### 2.2.4. Infrastructure Layer (Инфраструктурный Слой)
*   Ответственность: Реализация интерфейсов для взаимодействия с PostgreSQL, MongoDB, Redis, Kafka/RabbitMQ, Elasticsearch, и другими микросервисами платформы.
*   Ключевые компоненты/модули:
    *   Database Repositories: Для PostgreSQL и MongoDB.
    *   Cache Implementations: Для Redis.
    *   Message Queue Producers/Consumers.
    *   Elasticsearch Client.
    *   REST/gRPC Clients: Для взаимодействия с Account Service, Auth Service, Catalog Service и т.д.

## 3. API Endpoints

### 3.1. REST API
*   **Префикс**: `/api/v1/admin`
*   **Аутентификация**: JWT-токены (валидируются через Auth Service).
*   **Авторизация**: На основе роли и прав доступа административного пользователя.

#### 3.1.1. Ресурс: Административные пользователи (`/users`)
*   `GET /users`: Получение списка административных пользователей.
*   `POST /users`: Создание нового административного пользователя.
*   `GET /users/{admin_id}`: Получение информации о конкретном административном пользователе.
*   `PUT /users/{admin_id}`: Обновление информации.
*   `DELETE /users/{admin_id}`: Удаление.
*   `PUT /users/{admin_id}/permissions`: Обновление прав доступа.

#### 3.1.2. Ресурс: Модерация (`/moderation`)
*   `GET /moderation/queues`: Получение списка очередей модерации.
*   `GET /moderation/queues/{queue_id}/items`: Получение элементов в очереди.
*   `PUT /moderation/items/{item_id}/assign`: Назначение элемента модератору.
*   `PUT /moderation/items/{item_id}/decision`: Принятие решения (approve, reject).

#### 3.1.3. Ресурс: Управление пользователями платформы (`/platform-users`)
*   `GET /platform-users`: Поиск пользователей платформы.
*   `PUT /platform-users/{user_id}/status`: Изменение статуса (блок/разблок).
*   `PUT /platform-users/{user_id}/role`: Изменение роли.

#### 3.1.4. Ресурс: Техническая поддержка (`/support`)
*   `GET /support/tickets`: Список тикетов.
*   `POST /support/tickets/{ticket_id}/messages`: Добавление сообщения в тикет.
*   `GET /support/knowledge`: Статьи базы знаний.
*   `POST /support/knowledge`: Создание статьи.

#### 3.1.5. Ресурс: Безопасность (`/security`)
*   `GET /security/incidents`: Список инцидентов.
*   `POST /security/blocked-ips`: Блокировка IP.
*   `GET /security/audit-log`: Журнал аудита.

#### 3.1.6. Ресурс: Настройки платформы (`/settings`)
*   `GET /settings`: Получение настроек.
*   `PUT /settings/{setting_id}`: Обновление настройки.

#### 3.1.7. Ресурс: Аналитика (`/analytics`)
*   `GET /analytics/dashboard`: Данные для дашборда.
*   `POST /analytics/reports/{report_type}`: Генерация отчета.

#### 3.1.8. Ресурс: Маркетинг (`/marketing`)
*   `GET /marketing/campaigns`: Список кампаний.
*   `POST /marketing/campaigns`: Создание кампании.
*   `GET /marketing/banners`: Список баннеров.
*   `POST /marketing/banners`: Создание баннера.
*   `GET /marketing/promo-codes`: Список промокодов.
*   `POST /marketing/promo-codes`: Создание промокода.

*   (Более полный список эндпоинтов см. в разделе 5.2 исходной спецификации Admin Service).

### 3.2. gRPC API
*   Information not found in existing documentation. (Может использоваться для внутренней коммуникации между модулями Admin Service, если он реализован как набор микросервисов, или для взаимодействия с другими сервисами, но не описан как основной API).

### 3.3. WebSocket API (если применимо)
*   Information not found in existing documentation. (Может использоваться для real-time обновлений в админ-панели, например, для очередей модерации или новых тикетов поддержки).

## 4. Модели Данных (Data Models)

### 4.1. Основные Сущности
*   **AdminUser**: Административный пользователь (ID, UserID из Account Service, роль, права).
*   **ModerationQueue**: Очередь модерации (ID, название, тип контента).
*   **ModerationItem**: Элемент на модерацию (ID, ID контента, тип, данные, статус, назначенный модератор).
*   **ModerationDecision**: Решение по модерации (ID, ID элемента, админ, решение, причина).
*   **SupportTicket**: Тикет поддержки (ID, UserID, тема, категория, статус, назначенный агент).
*   **SupportMessage**: Сообщение в тикете.
*   **KnowledgeBaseArticle**: Статья в базе знаний.
*   **SystemSetting**: Системная настройка (ID, категория, ключ, значение).
*   **SecurityIncident**: Инцидент безопасности.
*   **BlockedIP**: Заблокированный IP-адрес.
*   **MarketingCampaign**: Маркетинговая кампания.
*   **Banner**: Рекламный/информационный баннер.
*   **PromoCode**: Промокод.
*   **AdminActionLog**: Журнал действий администраторов.
*   (Более детальное описание таблиц PostgreSQL см. в разделе 5.1 исходной спецификации Admin Service).

### 4.2. Схема Базы Данных
*   Используются PostgreSQL и MongoDB.
*   DDL для PostgreSQL (из раздела 5.1 исходной спецификации Admin Service):
    ```sql
    -- Административные пользователи
    CREATE TABLE admin_users ( admin_id UUID PRIMARY KEY ..., user_id UUID NOT NULL ...);
    -- Очереди модерации
    CREATE TABLE moderation_queues ( queue_id UUID PRIMARY KEY ... );
    -- Элементы в очередях модерации
    CREATE TABLE moderation_items ( item_id UUID PRIMARY KEY ... );
    -- Решения модерации
    CREATE TABLE moderation_decisions ( decision_id UUID PRIMARY KEY ... );
    -- Тикеты поддержки
    CREATE TABLE support_tickets ( ticket_id UUID PRIMARY KEY ... );
    -- ... и другие таблицы ...
    ```
*   MongoDB используется для детальных логов, снимков состояния, сложных структур аналитики.
*   Elasticsearch для индексации и поиска.
*   (Полный список таблиц и их полей см. в разделе 5.1 исходной спецификации Admin Service).

## 5. Потоковая Обработка Событий (Event Streaming)

### 5.1. Публикуемые События (Produced Events)
*   **Система сообщений**: Kafka или RabbitMQ.
*   **События, которые Admin Service может публиковать:**
    *   `admin.content.moderated`: (результат модерации игры, отзыва и т.д.) -> Catalog Service, Social Service, Developer Service.
    *   `admin.user.status.changed`: (пользователь заблокирован/разблокирован) -> Account Service, Notification Service.
    *   `admin.support.ticket.replied`: (ответ в тикете поддержки) -> Notification Service.
    *   `admin.support.ticket.status.changed`: (статус тикета изменен) -> Notification Service.
    *   `admin.system.setting.changed`: (изменена системная настройка) -> Соответствующие сервисы.
    *   `admin.marketing.campaign.status.changed`: (статус маркетинговой кампании изменен) -> Catalog Service, Notification Service.
        *   `Структура Payload (пример):`
            ```json
            {
              "campaign_id": "uuid_marketing_campaign",
              "new_status": "active" | "completed" | "cancelled",
              "admin_id": "uuid_admin_user",
              "changed_at": "ISO8601_timestamp"
            }
            ```
    *   `admin.security.action.taken`: (предпринято действие по безопасности, например, блокировка IP).
        *   `Структура Payload (пример):`
            ```json
            {
              "action_type": "ip_block" | "user_suspension_security",
              "target_id": "ip_address_or_user_id",
              "reason": "Подозрительная активность, связанная с попытками подбора пароля.",
              "admin_id": "uuid_admin_user",
              "action_at": "ISO8601_timestamp"
            }
            ```

### 5.2. Потребляемые События (Consumed Events)
*   **События, которые Admin Service может потреблять:**
    *   `developer.game.submitted.for.moderation.v1`: от Developer Service.
        *   `Структура Payload (пример):`
            ```json
            {
              "game_id": "uuid",
              "developer_id": "uuid",
              "game_title": "Новая Супер Игра",
              "version": "1.0.0",
              "submitted_at": "ISO8601_timestamp"
            }
            ```
        *   `Логика обработки:` Создание нового `ModerationItem` в очереди модерации игр. Установка статуса "pending".
    *   `user.content.reported.v1`: от Social Service/Catalog Service (жалоба на контент).
        *   `Структура Payload (пример):`
            ```json
            {
              "report_id": "uuid",
              "reporter_user_id": "uuid",
              "content_id": "uuid",
              "content_type": "review" | "comment" | "user_profile",
              "reason": "Спам/Оскорбления/Недопустимый контент",
              "report_details": "Текст жалобы от пользователя...",
              "reported_at": "ISO8601_timestamp"
            }
            ```
        *   `Логика обработки:` Создание `ModerationItem` в очереди жалоб. Привязка к контенту. Уведомление модераторов.
    *   `payment.transaction.suspicious.v1`: от Payment Service.
        *   `Структура Payload (пример):`
            ```json
            {
              "transaction_id": "uuid",
              "user_id": "uuid",
              "amount": 1999.00,
              "currency": "RUB",
              "reason_code": "HIGH_RISK_SCORE",
              "details": { "payment_method": "card_xxxx" },
              "detected_at": "ISO8601_timestamp"
            }
            ```
        *   `Логика обработки:` Создание `SecurityIncident`. Уведомление службы безопасности. Возможно, временная блокировка связанных аккаунтов.
    *   `system.health.issue.v1`: от системы мониторинга.
        *   `Структура Payload (пример):`
            ```json
            {
              "service_name": "catalog-service",
              "issue_type": "HIGH_ERROR_RATE",
              "severity": "critical",
              "description": "Error rate for /api/v1/games exceeded 5%",
              "metrics_snapshot": { "error_rate": "5.2%", "latency_p99": "1500ms" },
              "detected_at": "ISO8601_timestamp"
            }
            ```
        *   `Логика обработки:` Создание тикета для DevOps/SRE. Уведомление администраторов. Логирование инцидента.

## 6. Интеграции (Integrations)

### 6.1. Внутренние Микросервисы
Admin Service интегрируется со всеми основными микросервисами платформы:
*   **Account Service**: Управление аккаунтами, ролями, статусами.
*   **Auth Service**: Аутентификация/авторизация администраторов.
*   **Catalog Service**: Модерация игр, управление контентом, ценами.
*   **Developer Service**: Получение игр на модерацию, отправка результатов.
*   **Social Service**: Модерация социального контента.
*   **Payment Service**: Обработка возвратов, мониторинг транзакций, промокоды.
*   **Analytics Service**: Получение данных для отчетов.
*   **Notification Service**: Отправка уведомлений.
*   **Download Service**: Управление доступностью контента.
*   **Library Service**: Управление библиотеками пользователей (в особых случаях).
*   (Детали см. в разделе 1.3 и 6 исходной спецификации Admin Service).

### 6.2. Внешние Системы
*   На данный момент внешние интеграции не определены. Этот раздел будет дополнен при необходимости.

## 7. Конфигурация (Configuration)

### 7.1. Переменные Окружения
*   `ADMIN_SERVICE_PORT`: Порт сервиса.
*   `POSTGRES_DSN`: Строка подключения к PostgreSQL.
*   `MONGO_DSN`: Строка подключения к MongoDB.
*   `REDIS_ADDR`: Адрес Redis.
*   `KAFKA_BROKERS` / `RABBITMQ_URL`: Адреса брокеров сообщений.
*   `ELASTICSEARCH_URL`: Адрес Elasticsearch.
*   `AUTH_SERVICE_URL`: Адрес Auth Service.
*   `ACCOUNT_SERVICE_URL`: Адрес Account Service.
*   ... (адреса других интегрируемых сервисов).
*   `LOG_LEVEL`.

### 7.2. Файлы Конфигурации (если применимо)
*   Конфигурация сервиса осуществляется преимущественно через переменные окружения. Файлы конфигурации на данный момент не используются или их структура не детализирована. При необходимости могут быть введены YAML-файлы для сложных настроек модулей или динамически изменяемых параметров, например:
    ```yaml
    # Пример возможной структуры feature_flags.yaml
    feature_flags:
      new_moderation_ui_enabled: true
      ai_content_analysis_active: false

    module_settings:
      support_ticket:
        default_priority: "medium"
        sla_response_hours: 24
    ```

## 8. Обработка Ошибок (Error Handling)

### 8.1. Общие Принципы
*   Единообразная и информативная обработка ошибок.
*   Возвращение корректных HTTP статусов и сообщений об ошибках.
*   Логирование всех ошибок.

### 8.2. Распространенные Коды Ошибок
*   **400 Bad Request**: Некорректные входные данные.
*   **401 Unauthorized**: Ошибка аутентификации администратора.
*   **403 Forbidden**: Недостаточно прав у администратора для выполнения операции.
*   **404 Not Found**: Запрашиваемый ресурс не найден (например, пользователь, игра, тикет).
*   **500 Internal Server Error**: Внутренняя ошибка сервера Admin Service.
*   **502 Bad Gateway**: Ошибка при взаимодействии с другим микросервисом.
*   **503 Service Unavailable**: Зависимый сервис недоступен.

## 9. Безопасность (Security)

### 9.1. Аутентификация
*   Строгая аутентификация административных пользователей через Auth Service.
*   Рекомендуется многофакторная аутентификация для всех администраторов.

### 9.2. Авторизация
*   Детальная система прав доступа на основе ролей (RBAC) с принципом наименьших привилегий.
*   Права проверяются для каждого действия в Admin Service.

### 9.3. Защита Данных
*   Шифрование всех конфиденциальных данных при хранении и передаче.
*   HTTPS для всех коммуникаций с административной панелью и между сервисами.
*   Защита от CSRF, XSS, SQL-инъекций.

### 9.4. Управление Секретами
*   Использование Kubernetes Secrets или HashiCorp Vault.
*   **Аудит действий**: Детальное логирование всех административных действий (см. разделы "Модели Данных" и "Мониторинг и Логирование").
*   **Доступ к панели**: Ограничение доступа к административной панели по IP-адресам или через VPN.
*   **Сессии**: Автоматическое завершение сессий после неактивности, возможность принудительного завершения.
*   (Детали см. в разделе 7.1 исходной спецификации Admin Service).

## 10. Развертывание (Deployment)

### 10.1. Инфраструктурные Файлы
*   **Dockerfile**: Стандартный Dockerfile для выбранного технологического стека.
*   **Helm-чарты/Kubernetes манифесты**: Для управления развертыванием.

### 10.2. Зависимости при Развертывании
*   PostgreSQL, MongoDB, Redis, Kafka/RabbitMQ, Elasticsearch.
*   Все микросервисы платформы, с которыми интегрируется Admin Service.

### 10.3. CI/CD
*   Автоматическая сборка, тестирование и развертывание.
*   (Детали см. в разделе 8.2 исходной спецификации Admin Service).

## 11. Мониторинг и Логирование (Logging and Monitoring)

### 11.1. Логирование
*   **Формат**: Структурированные логи (JSON).
*   **События**: Запросы, ошибки, важные бизнес-события, административные действия.
*   **Интеграция**: ELK Stack / Loki.

### 11.2. Мониторинг
*   **Метрики**: Prometheus. Время отклика, количество ошибок, использование ресурсов, глубина очередей.
*   **Дашборды**: Grafana.
*   **Алертинг**: Настроены для критических ситуаций.

### 11.3. Трассировка
*   Интеграция с системой распределенной трассировки (например, Jaeger/OpenTelemetry) будет реализована согласно общепроектным стандартам. Контекст трассировки (trace ID, span ID) будет передаваться между сервисами и включаться в логи.

## 12. Нефункциональные Требования (NFRs)
*   **Безопасность**: Высокий уровень защиты.
*   **Производительность**: Быстрый отклик интерфейса.
*   **Масштабируемость**: Горизонтальное масштабирование.
*   **Надежность**: Доступность не менее 99.9%.
*   **Удобство использования**: Интуитивно понятный интерфейс.
*   **Аудит**: Полное логирование всех административных действий.
*   (Детали см. в разделе 2.4 исходной спецификации Admin Service).

## 13. Приложения (Appendices) (Опционально)
*   Детальные схемы данных (DDL для PostgreSQL, схемы для MongoDB), полные примеры API запросов/ответов и форматы событий будут добавлены по мере финализации дизайна и реализации соответствующих модулей.

---
*Этот шаблон является отправной точкой и может быть адаптирован под конкретные нужды проекта и сервиса.*

# Спецификация Микросервиса: Download Service

**Версия:** 1.0
**Дата последнего обновления:** {{YYYY-MM-DD}} <!-- TODO: Update date -->

## 1. Обзор Сервиса (Overview)

### 1.1. Назначение и Роль
*   **Назначение документа:** Данный документ представляет собой полную спецификацию микросервиса Download Service.
*   **Роль в общей архитектуре платформы:** Download Service является критически важным компонентом, отвечающим за загрузку, обновление и установку игр на устройства пользователей. Обеспечивает надежную и эффективную доставку игрового контента.
*   **Основные бизнес-задачи:** Управление загрузкой, обновлением и установкой игр, оптимизация использования сетевых ресурсов, обеспечение целостности и безопасности файлов, предоставление информации о статусе загрузок.

### 1.2. Ключевые Функциональности
*   **Управление загрузками игр:** Инициация, приостановка, возобновление, отмена, управление очередью, параллельные загрузки.
*   **Управление обновлениями игр:** Проверка наличия, автоматическое/ручное обновление, дельта-обновления, откат.
*   **Управление клиентским приложением:** Обновление клиента платформы, поддержка различных каналов обновлений.
*   **Проверка целостности:** Верификация файлов по хеш-суммам, автоматическое исправление.
*   **Мониторинг и статистика:** Отслеживание прогресса, скорости загрузки, производительности CDN, использования ресурсов.
*   (Источник: Спецификация Download Service, раздел 2.3)

### 1.3. Основные Технологии
*   **Язык программирования:** Go.
*   **API:** gRPC (межсервисное), REST (клиентское), WebSocket (real-time прогресс).
*   **Базы данных:** PostgreSQL (метаданные загрузок), Redis (кэширование, очереди).
*   **Хранилище файлов:** MinIO или S3-совместимое (для временных файлов, если требуется).
*   **Инфраструктура:** Docker, Kubernetes, Prometheus, Jaeger, ELK/Loki.
*   (Источник: Спецификация Download Service, раздел 8.1)

### 1.4. Термины и Определения (Glossary)
*   **CDN (Content Delivery Network):** Сеть доставки контента.
*   **Дельта-обновление:** Обновление, содержащее только изменения между версиями.
*   **Хеш-сумма:** Уникальная строка для проверки целостности файла.
*   **Circuit Breaker:** Паттерн для предотвращения каскадных отказов.
*   **mTLS (mutual TLS):** Взаимная TLS-аутентификация.
*   (Полный глоссарий см. в Спецификации Download Service, раздел 9)

## 2. Внутренняя Архитектура (Internal Architecture)

### 2.1. Общее Описание
*   Download Service построен на многослойной архитектуре, обеспечивающей разделение ответственности и масштабируемость.
*   Ключевые компоненты включают управление загрузками, обновлениями, проверку целостности, взаимодействие с CDN и управление очередями.
*   (Источник: Спецификация Download Service, раздел 3.1)

### 2.2. Слои Сервиса
(На основе раздела 3.1.1 исходной спецификации)

#### 2.2.1. Presentation Layer (Слой Представления / Транспортный слой)
*   Ответственность: Обработка входящих запросов от клиентского приложения (REST, WebSocket) и других микросервисов (gRPC).
*   Ключевые компоненты/модули:
    *   REST API Handlers (Gin или Echo).
    *   gRPC Service Implementations.
    *   WebSocket Handlers (для отслеживания прогресса).

#### 2.2.2. Application Layer (Прикладной Слой / Сервисный слой)
*   Ответственность: Реализация бизнес-логики управления загрузками, обновлениями, проверкой целостности. Оркестрация взаимодействия компонентов.
*   Ключевые компоненты/модули:
    *   Сервисы: `DownloadServiceLogic`, `UpdateServiceLogic`, `VerificationServiceLogic`, `ClientUpdateServiceLogic`.
    *   (Компоненты из раздела 3.2 исходной спецификации: Download Manager, Update Manager, Integrity Checker, Delta Processor).

#### 2.2.3. Domain Layer (Доменный Слой)
*   Ответственность: Бизнес-сущности (Download, Update, FileMetadata), правила валидации.
*   Ключевые компоненты/модули:
    *   Entities: `Download`, `DownloadItem`, `Update`, `UpdateItem`, `FileMetadata`, `VerificationResult`, `VerificationIssue`.
    *   Enums: `DownloadStatus`, `ItemStatus`, `UpdateType`, `VerificationStatus`.

#### 2.2.4. Infrastructure Layer (Инфраструктурный Слой)
*   Ответственность: Взаимодействие с PostgreSQL, Redis, CDN. Управление очередями. Мониторинг, логирование, трассировка.
*   Ключевые компоненты/модули:
    *   PostgreSQL Repositories, Redis Repositories.
    *   CDN Client.
    *   Queue Manager (может использовать Redis или другую систему очередей).
    *   Модули для хеширования, обработки дельта-патчей.
    *   Клиенты для взаимодействия с Catalog, Library, Auth, Account Services.

*   (Структуру проекта см. в Спецификации Download Service, раздел 3.1.2)

## 3. API Endpoints

### 3.1. REST API (для клиентского приложения)
*   **Префикс:** `/api/v1/downloads` (пример)
*   **Аутентификация:** JWT (через Auth Service).
*   **Основные группы эндпоинтов:**
    *   Управление загрузками: `POST /`, `GET /`, `GET /{download_id}`, `PATCH /{download_id}` (статус), `PATCH /{download_id}/priority`.
    *   Управление обновлениями: `GET /updates/check`, `POST /updates/apply`, `GET /updates/history`.
    *   Проверка целостности: `POST /verification`, `GET /verification/{verification_id}`, `POST /verification/{verification_id}/fix`.
    *   Настройки загрузки: `GET /settings`, `PATCH /settings`, `POST /settings/bandwidth-schedule`.
*   (Детали см. в Спецификации Download Service, раздел 5.3).

### 3.2. gRPC API (для межсервисного взаимодействия)
*   **Сервисы:** `DownloadService`, `UpdateService`, `VerificationService`, `SettingsService`.
*   **Основные методы:** `InitiateDownload`, `GetDownloadStatus`, `CheckForUpdates`, `VerifyGameFiles`, `SyncGameInstallStatus`.
*   (Детали см. в Спецификации Download Service, раздел 5.4).

### 3.3. WebSocket API
*   **Эндпоинт:** `/api/v1/ws/downloads`
*   **Назначение:** Получение обновлений о прогрессе загрузок в реальном времени.
*   (Детали см. в Спецификации Download Service, раздел 5.3.5).

## 4. Модели Данных (Data Models)

### 4.1. Основные Сущности
*   **Download**: Информация о загрузке (ID, UserID, GameID, Status, Progress, Speed, Size).
*   **DownloadItem**: Элемент загрузки/файл (ID, FileID, FileName, Path, Size, Hash, Status).
*   **Update**: Информация об обновлении (ID, GameID, FromVersion, ToVersion, Type, Size).
*   **FileMetadata**: Метаданные файла (ID, GameID, FileName, Path, Size, Hash, Version, CDNLocations).
*   **VerificationResult**: Результат проверки целостности.
*   (Go структуры см. в Спецификации Download Service, раздел 5.1.1).

### 4.2. Схема Базы Данных
*   **PostgreSQL**: Хранит метаданные загрузок, обновлений, файлов, историю, статистику CDN, результаты верификации, настройки.
    ```sql
    -- Пример таблицы downloads (сокращенно)
    CREATE TABLE downloads (id VARCHAR PRIMARY KEY, user_id VARCHAR, game_id VARCHAR, status VARCHAR, progress REAL ...);
    -- Пример таблицы file_metadata (сокращенно)
    CREATE TABLE file_metadata (id VARCHAR PRIMARY KEY, game_id VARCHAR, file_name VARCHAR, file_path VARCHAR, file_size BIGINT, file_hash VARCHAR ...);
    ```
*   **Redis**: Хранит очереди загрузок, статусы текущих загрузок, кэш метаданных, временные токены CDN.
*   (Основные таблицы и структуры Redis см. в Спецификации Download Service, разделы 3.3.1, 3.3.2, 5.2).

## 5. Потоковая Обработка Событий (Event Streaming)

### 5.1. Публикуемые События (Produced Events)
*   `download.started`: Начало загрузки.
*   `download.progress`: Обновление прогресса загрузки (может идти через WebSocket).
*   `download.completed`: Завершение загрузки.
*   `download.failed`: Ошибка загрузки.
*   `update.available`: Доступно обновление.
*   `update.completed`: Обновление завершено.
*   `verification.completed`: Проверка целостности завершена.
*   TODO: Детализировать систему сообщений (Kafka/RabbitMQ), топики и структуру Payload. Исходная спецификация не детализирует это.

### 5.2. Потребляемые События (Consumed Events)
*   `catalog.game.version.published`: От Catalog Service, информация о новой версии игры, доступной для скачивания.
*   `library.game.install.requested`: От Library Service, запрос на начало загрузки игры.
*   TODO: Детализировать другие возможные потребляемые события.

## 6. Интеграции (Integrations)

### 6.1. Внутренние Микросервисы
*   **Catalog Service**: Получение метаданных игр, информации о версиях, обновлениях, хешах файлов (gRPC).
*   **Library Service**: Проверка прав доступа, обновление статуса установки игры (gRPC).
*   **Auth Service**: Аутентификация/авторизация пользователей (gRPC).
*   **Account Service**: Получение/обновление настроек загрузки пользователя (gRPC).
*   (Детали и обработка ошибок см. в Спецификации Download Service, раздел 6).

### 6.2. Внешние Системы
*   **CDN (Content Delivery Network)**: Загрузка файлов игр и обновлений (HTTPS).
*   (Детали и обработка ошибок см. в Спецификации Download Service, раздел 6.5).

## 7. Конфигурация (Configuration)

### 7.1. Переменные Окружения
*   `DOWNLOAD_SERVICE_HTTP_PORT`, `DOWNLOAD_SERVICE_GRPC_PORT`, `DOWNLOAD_SERVICE_WS_PORT`.
*   `POSTGRES_DSN`.
*   `REDIS_ADDR`.
*   `CDN_BASE_URL_PRIMARY`, `CDN_BASE_URL_SECONDARY`.
*   Адреса gRPC других сервисов (Catalog, Library, Auth, Account).
*   `LOG_LEVEL`.
*   `MAX_PARALLEL_DOWNLOADS_PER_USER`, `GLOBAL_BANDWIDTH_LIMIT`.
*   TODO: Сформировать полный список.

### 7.2. Файлы Конфигурации (если применимо)
*   Может использоваться для настроек CDN провайдеров, стратегий балансировки.
*   TODO: Детализировать структуру, если используется.

## 8. Обработка Ошибок (Error Handling)

### 8.1. Общие Принципы
*   Использование Circuit Breaker и Retry с экспоненциальной задержкой при взаимодействии с другими сервисами.
*   Fallback на кэшированные данные или альтернативные CDN.
*   Подробное логирование ошибок.

### 8.2. Распространенные Коды Ошибок
*   Для REST API: Стандартные HTTP коды (400, 401, 403, 404, 500, 503).
*   Для gRPC: Стандартные коды gRPC.
*   Внутренние ошибки: `CDN_UNAVAILABLE`, `FILE_HASH_MISMATCH`, `INSUFFICIENT_DISK_SPACE`.

## 9. Безопасность (Security)

### 9.1. Аутентификация
*   Все запросы к API требуют JWT аутентификации (через Auth Service).
*   mTLS для межсервисного gRPC взаимодействия.

### 9.2. Авторизация
*   Проверка прав доступа к игре через Library Service перед началом загрузки.

### 9.3. Защита Данных
*   TLS 1.3 для всех внешних коммуникаций.
*   Проверка хеш-сумм всех загруженных файлов.
*   Цифровая подпись критических файлов (например, исполняемых файлов обновлений).

### 9.4. Управление Секретами
*   Ключи доступа к CDN, пароли к БД через Kubernetes Secrets или Vault.
*   **Защита от атак:** Защита CDN от DDoS, Rate limiting на API, защита от подмены контента.
*   (Детали см. в Спецификации Download Service, раздел 7.1).

## 10. Развертывание (Deployment)

### 10.1. Инфраструктурные Файлы
*   **Dockerfile:** Стандартный Dockerfile для Go приложения.
*   **Kubernetes манифесты/Helm-чарты.**

### 10.2. Зависимости при Развертывании
*   PostgreSQL, Redis.
*   Catalog Service, Library Service, Auth Service, Account Service.
*   Доступ к CDN.

### 10.3. CI/CD
*   Автоматическая сборка, тестирование, развертывание.
*   (Детали см. в Спецификации Download Service, раздел 8).

## 11. Мониторинг и Логирование (Logging and Monitoring)

### 11.1. Логирование
*   Структурированные логи (JSON).
*   Централизованный сбор (ELK/Loki).
*   Логирование прогресса загрузок, ошибок, событий безопасности.

### 11.2. Мониторинг
*   Prometheus, Grafana.
*   Метрики: скорость загрузки, количество активных загрузок, ошибки, использование CDN, производительность проверки целостности.

### 11.3. Трассировка
*   Интеграция с Jaeger/OpenTelemetry для отслеживания запросов через CDN и внутренние компоненты.

## 12. Нефункциональные Требования (NFRs)
*   **Производительность:** Высокая пропускная способность, минимизация задержек.
*   **Масштабируемость:** Горизонтальное масштабирование, балансировка нагрузки CDN.
*   **Надежность:** Устойчивость к сетевым сбоям, автоматическое восстановление, отказоустойчивость CDN.
*   **Безопасность:** Защита от несанкционированного доступа и подмены контента.
*   (Детали см. в Спецификации Download Service, раздел 2.4).

## 13. Приложения (Appendices) (Опционально)
*   TODO: Детальные схемы DDL, примеры API запросов/ответов.

---
*Этот шаблон является отправной точкой и может быть адаптирован под конкретные нужды проекта и сервиса.*

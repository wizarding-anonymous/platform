# Структура Баз Данных Проекта

## 1. Введение

Данный документ предназначен для описания общей структуры баз данных, используемых в проекте "Российский Аналог Платформы Steam". Он должен предоставлять высокоуровневый обзор моделей данных каждого микросервиса и, по возможности, общую схему взаимодействия данных на уровне платформы.

**Цели документа:**

*   Дать общее представление о данных, которыми оперирует каждый микросервис.
*   Описать ключевые сущности и их связи на уровне отдельных сервисов.
*   Если существуют общие модели данных или разделяемые базы данных (не рекомендуется в чистой микросервисной архитектуре, но возможно для некоторых случаев), описать их здесь.
*   Служить отправной точкой для разработчиков при изучении моделей данных конкретных сервисов.

## 2. Общие Принципы Проектирования Баз Данных

*   **Децентрализация данных:** Каждый микросервис владеет своими данными и своей схемой базы данных. Прямой доступ к базе данных другого сервиса запрещен; взаимодействие осуществляется только через API.
*   **Выбор СУБД:** Тип СУБД (SQL, NoSQL, графовая и т.д.) выбирается исходя из специфических требований каждого микросервиса (например, PostgreSQL для транзакционных данных, Elasticsearch для поиска, Cassandra для сценариев с высокой нагрузкой на запись).
*   **Миграции схемы:** Для реляционных баз данных используются инструменты управления миграциями схемы (например, golang-migrate, Flyway, Alembic).
*   **Резервное копирование и восстановление:** Для каждой базы данных должны быть настроены процедуры регулярного резервного копирования и протестированы сценарии восстановления.
*   **Безопасность:** Доступ к базам данных должен быть строго ограничен. Учетные данные для доступа должны храниться в секретах.

## 3. Структура Баз Данных по Микросервисам

Этот раздел должен содержать ссылки на документацию по структуре БД каждого микросервиса или краткое описание их моделей данных.

### 3.1. Auth Service
*   **СУБД:** PostgreSQL, Redis.
*   **Основные сущности:** Пользователи (учетные данные), Роли, Разрешения, Сессии, Refresh-токены, API-ключи, Коды верификации, Аудит лог.
*   **Ссылка на детальную документацию:** `services/auth-service/docs/README.md#4-модели-данных-data-models`

### 3.2. Account Service
*   **СУБД:** PostgreSQL, Redis.
*   **Основные сущности:** Аккаунты пользователей (профильная информация), Контактная информация, Настройки пользователя, Аватары.
*   **Ссылка на детальную документацию:** `services/account-service/docs/README.md#4-модели-данных-data-models`

### 3.3. Catalog Service
*   **СУБД:** PostgreSQL, Elasticsearch, Redis.
*   **Основные сущности:** Продукты (Игры, DLC, ПО, Комплекты), Жанры, Теги, Категории, Цены, Медиа-контент, Метаданные достижений.
*   **Ссылка на детальную документацию:** `services/catalog-service/docs/README.md#4-модели-данных-data-models`

### 3.4. Library Service
*   **СУБД:** PostgreSQL, Redis, S3-совместимое хранилище.
*   **Основные сущности:** Записи библиотеки пользователя, Игровое время, Достижения пользователя, Списки желаемого, Метаданные сохранений игр.
*   **Ссылка на детальную документацию:** `services/library-service/docs/README.md#4-модели-данных-data-models`

### 3.5. Payment Service
*   **СУБД:** PostgreSQL, Redis.
*   **Основные сущности:** Транзакции, Платежные методы, Фискальные чеки, Балансы разработчиков, Промокоды, Подарочные сертификаты, Выплаты.
*   **Ссылка на детальную документацию:** `services/payment-service/docs/README.md#4-модели-данных-data-models`

### 3.6. Download Service
*   **СУБД:** PostgreSQL, Redis.
*   **Основные сущности:** Задачи на загрузку, Элементы загрузки, Информация об обновлениях, Метаданные файлов.
*   **Ссылка на детальную документацию:** `services/download-service/docs/README.md#4-модели-данных-data-models`

### 3.7. Social Service
*   **СУБД:** PostgreSQL, Cassandra, Neo4j, Redis.
*   **Основные сущности:** Профили пользователей (социальная часть), Друзья, Группы, Сообщения чатов, Записи ленты активности, Отзывы, Комментарии.
*   **Ссылка на детальную документацию:** `services/social-service/docs/README.md#4-модели-данных-data-models`

### 3.8. Notification Service
*   **СУБД:** PostgreSQL или ClickHouse (для статистики), Redis.
*   **Основные сущности:** Шаблоны уведомлений, Отправленные уведомления, Пользовательские предпочтения, Маркетинговые кампании, Токены устройств.
*   **Ссылка на детальную документацию:** `services/notification-service/docs/README.md#4-модели-данных-data-models`

### 3.9. Developer Service
*   **СУБД:** PostgreSQL, S3-совместимое хранилище.
*   **Основные сущности:** Аккаунты разработчиков, Игры разработчика, Версии игр (билды), Метаданные игр, Ценовая информация, Запросы на выплаты, API-ключи.
*   **Ссылка на детальную документацию:** `services/developer-service/docs/README.md#4-модели-данных-data-models`

### 3.10. Admin Service
*   **СУБД:** PostgreSQL, MongoDB.
*   **Основные сущности:** Административные пользователи, Очереди модерации, Решения по модерации, Тикеты поддержки, Статьи базы знаний, Системные настройки, Маркетинговые кампании.
*   **Ссылка на детальную документацию:** `services/admin-service/docs/README.md#4-модели-данных-data-models`

### 3.11. Analytics Service
*   **СУБД:** ClickHouse, PostgreSQL (метаданные).
*   **Основные сущности:** События, Метрики, Отчеты, Сегменты, ML Модели, Прогнозы.
*   **Ссылка на детальную документацию:** `services/analytics-service/docs/README.md#4-модели-данных-data-models`

### 3.12. API Gateway
*   **СУБД:** Может использовать собственную БД (например, PostgreSQL или Redis) для хранения конфигурации маршрутов, плагинов, потребителей, если это не управляется исключительно через CRD Kubernetes.
*   **Основные сущности:** Маршруты, Сервисы, Потребители, Плагины.
*   **Ссылка на детальную документацию:** `services/api-gateway/docs/README.md#4-модели-данных-data-models`

## 4. Общая Схема Данных Платформы (ERD)

<!-- TODO: Вставить общую логическую ERD диаграмму, показывающую ключевые сущности платформы и их основные связи. Это может быть упрощенная диаграмма, так как детальные схемы находятся в документации каждого сервиса. -->
```mermaid
erDiagram
    USER ||--o{ ACCOUNT_PROFILE : has
    USER ||--o{ LIBRARY_ITEM : owns
    USER ||--o{ PAYMENT_TRANSACTION : initiates
    USER ||--o{ FRIENDSHIP : has
    USER ||--o{ CHAT_MESSAGE : sends
    USER ||--o{ REVIEW : writes
    USER ||--o{ SUPPORT_TICKET : creates
    USER ||--o{ NOTIFICATION_PREFERENCE : sets

    DEVELOPER_ACCOUNT ||--o{ GAME_PROJECT : manages
    GAME_PROJECT ||--o{ GAME_VERSION : has
    GAME_PROJECT ||--o{ CATALOG_PRODUCT : listed_as

    CATALOG_PRODUCT ||--o{ LIBRARY_ITEM : "is an instance of"
    CATALOG_PRODUCT ||--o{ GAME_PRICE : has
    CATALOG_PRODUCT ||--o{ REVIEW : "is for"
    CATALOG_PRODUCT ||--o{ ACHIEVEMENT_METADATA : defines

    PAYMENT_TRANSACTION ||--o{ FISCAL_RECEIPT : results_in
    PAYMENT_TRANSACTION ||--o{ LIBRARY_ITEM : "grants access to"

    GAME_VERSION ||--o{ DOWNLOAD_FILE : consists_of

    NOTIFICATION ||--o{ USER : "targets"

    ADMIN_USER ||--o{ MODERATION_ACTION : performs
    MODERATION_ACTION ||--o{ REVIEW : "applies to"
    MODERATION_ACTION ||--o{ CATALOG_PRODUCT : "applies to"

    ANALYTICS_EVENT ||--o{ USER : "relates to"
    ANALYTICS_EVENT ||--o{ CATALOG_PRODUCT : "relates to"

    API_GATEWAY_ROUTE --> MICROSERVICE_API
```
*(Примечание: Это очень упрощенная диаграмма для иллюстрации. Реальная диаграмма будет значительно сложнее и потребует детальной проработки).*

## 5. Вопросы Синхронизации и Консистентности Данных

<!-- TODO: Описать подходы к обеспечению консистентности данных между микросервисами (например, Eventual Consistency, Saga Pattern, двухфазный коммит, если где-то необходим). -->
*   В большинстве случаев используется **Eventual Consistency**. Сервисы публикуют события об изменениях своих данных, а другие сервисы подписываются на эти события и асинхронно обновляют свои локальные копии или представления данных.
*   Для критически важных операций, требующих строгой консистентности (например, списание средств и предоставление доступа к игре), могут использоваться более сложные паттерны координации, либо ответственность за атомарность возлагается на один сервис, который затем уведомляет другие.

---
*Этот документ должен регулярно обновляться по мере развития моделей данных микросервисов.*

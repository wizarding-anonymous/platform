<!-- project_roles_and_permissions.md -->
# Единый реестр ролей пользователей и матрица доступа

**Версия:** 1.0
**Дата последнего обновления:** 2024-07-16

## Введение

Данный документ определяет единый реестр ролей пользователей и матрицу доступа к ресурсам и операциям для российского аналога платформы Steam. Цель документа — стандартизировать управление доступом во всех микросервисах, устранить противоречия в правах и обеспечить согласованность системы безопасности.

## Единый реестр ролей пользователей

### Основные роли

1.  **user (Пользователь)**
    *   **Описание**: Стандартный пользователь платформы. Может покупать игры, управлять своей библиотекой, общаться с другими пользователями, оставлять отзывы.
    *   **Наследование**: Базовая роль.

2.  **developer (Разработчик)**
    *   **Описание**: Пользователь, имеющий право публиковать и управлять своими играми на платформе. Имеет доступ к Developer Service.
    *   **Наследование**: Наследует права `user`.

3.  **publisher (Издатель)**
    *   **Описание**: Организация или пользователь с расширенными правами по управлению несколькими играми (своими или других разработчиков). Имеет доступ к Developer Service с расширенными возможностями.
    *   **Наследование**: Наследует права `developer`.

4.  **moderator (Модератор)**
    *   **Описание**: Пользователь с правами модерации пользовательского контента (отзывы, комментарии, форумы, профили).
    *   **Наследование**: Наследует права `user`.

5.  **support (Сотрудник поддержки)**
    *   **Описание**: Сотрудник службы поддержки пользователей. Имеет доступ к информации о пользователях, транзакциях, может обрабатывать запросы на возврат средств, решать проблемы пользователей.
    *   **Наследование**: Наследует права `user`.

6.  **admin (Администратор)**
    *   **Описание**: Администратор платформы с полным доступом ко всем функциям управления системой, пользователями, контентом и настройками.
    *   **Наследование**: Наследует права `support` и `moderator`.
*   **Примечание**: В Admin Service могут существовать более гранулярные административные роли (например, `superuser`, `content_moderation_lead`, `support_lead`, `finance_admin`), которые являются специализациями этой общей роли `admin` или предоставляют специфический набор разрешений.

### Дополнительные роли, специфичные для контекста

1.  **developer_owner (Владелец команды разработки)**
    *   **Описание**: Пользователь, который создал и управляет аккаунтом разработчика/издателя в Developer Service. Имеет полные права в рамках своего Developer Account.
    *   **Наследование**: Наследует права `developer`.
2.  **developer_team_member (Член команды разработки)**
    *   **Описание**: Пользователь, добавленный в команду разработчика с определенными правами на управление продуктами и финансами в Developer Service (например, `game_editor`, `finance_manager` в команде).
    *   **Наследование**: Наследует права `developer` (базовые для доступа к порталу).

### Системные роли

1.  **system (Система)**
    *   **Описание**: Внутренняя роль для межсервисного взаимодействия, когда действие выполняется не от имени пользователя, а самой системой (например, фоновые задачи, обработка событий).
    *   **Наследование**: Не наследует права пользователей.

2.  **anonymous (Анонимный пользователь)**
    *   **Описание**: Пользователь, не прошедший аутентификацию. Имеет доступ только к публичным ресурсам (просмотр каталога, страниц игр).
    *   **Наследование**: Не наследует права пользователей.

### Иерархия ролей (Основная)

*   admin
        *   support
        *   moderator
*   publisher
    *   developer_owner
        *   developer_team_member (с различными внутренними правами)
            *   developer (базовая роль для доступа к Developer Portal)
*   user
*   anonymous
*   system

## Матрица доступа к ресурсам и операциям

В таблице ниже представлена матрица доступа, где:
- **R** - Read (Чтение)
- **C** - Create (Создание)
- **U** - Update (Обновление)
- **D** - Delete (Удаление)
- **M** - Manage (Полное управление, включая C, U, D и специфические действия)
- **X** - Execute (Выполнение специфической операции)
- **-** - Доступ запрещен

| Ресурс / Операция                                  | Микросервис      | anonymous | user | developer | publisher | moderator | support | admin | system |
|----------------------------------------------------|------------------|-----------|------|-----------|-----------|-----------|---------|-------|--------|
| **Пользователи (Users)**                           |                  |           |      |           |           |           |         |       |        |
| Просмотр своего профиля                            | Account          | -         | R    | R         | R         | R         | R       | R     | -      |
| Редактирование своего профиля                      | Account          | -         | U    | U         | U         | U         | U       | U     | -      |
| Просмотр чужого профиля (публичные данные)           | Account/Social   | R         | R    | R         | R         | R         | R       | R     | -      |
| Просмотр чужого профиля (приватные данные)          | Account/Admin    | -         | -    | -         | -         | -         | R       | R     | -      |
| Поиск пользователей                                | Account/Social   | -         | R    | R         | R         | R         | R       | R     | -      |
| Управление пользователями (блокировка, удаление)   | Account/Admin    | -         | -    | -         | -         | -         | U       | M     | -      |
| Регистрация                                        | Auth             | C         | -    | -         | -         | -         | -       | -     | -      |
| Аутентификация                                     | Auth             | X         | X    | X         | X         | X         | X       | X     | -      |
| Управление сессиями (своими)                       | Auth             | -         | D    | D         | D         | D         | D       | D     | -      |
| Управление сессиями (чужими)                      | Auth/Admin       | -         | -    | -         | -         | -         | D       | M     | -      |
| **Игры (Games/Products)**                          |                  |           |      |           |           |           |         |       |        |
| Просмотр каталога игр                              | Catalog          | R         | R    | R         | R         | R         | R       | R     | -      |
| Просмотр страницы игры                             | Catalog          | R         | R    | R         | R         | R         | R       | R     | -      |
| Поиск игр                                          | Catalog          | R         | R    | R         | R         | R         | R       | R     | -      |
| Создание/Подача своей игры на модерацию            | Developer        | -         | -    | C         | C         | -         | -       | C     | -      |
| Редактирование своей игры (до/после публикации)    | Developer/Catalog| -         | -    | U         | U         | -         | -       | U     | -      |
| Удаление своей игры (в зависимости от статуса)       | Developer/Catalog| -         | -    | D         | D         | -         | -       | D     | -      |
| Управление чужими играми (модерация, публикация)   | Catalog/Admin    | -         | -    | -         | -         | U         | -       | M     | -      |
| Управление категориями/тегами/жанрами              | Catalog/Admin    | -         | -    | -         | -         | -         | -       | M     | -      |
| Загрузка файлов игры (своей)                       | Developer/Download| -        | -    | C         | C         | -         | -       | C     | -      |
| Управление версиями игры (своей)                   | Developer        | -         | -    | M         | M         | -         | -       | M     | -      |
| Загрузка файлов игры (пользователем)               | Download         | -         | X    | X         | X         | X         | X       | X     | -      |
| **Библиотека (Library)**                           |                  |           |      |           |           |           |         |       |        |
| Просмотр своей библиотеки                          | Library          | -         | R    | R         | R         | R         | R       | R     | -      |
| Добавление игры в библиотеку (через покупку)       | Library/Payment  | -         | C    | C         | C         | C         | C       | C     | -      |
| Установка/Удаление игры из библиотеки (инициация)  | Library          | -         | X    | X         | X         | X         | X       | X     | -      |
| Просмотр библиотеки другого пользователя (админ)     | Library/Admin    | -         | -    | -         | -         | -         | R       | R     | R (gRPC) |
| **Платежи (Payments)**                             |                  |           |      |           |           |           |         |       |        |
| Просмотр своих транзакций                          | Payment          | -         | R    | R         | R         | R         | R       | R     | -      |
| Пополнение своего баланса (если есть)              | Payment          | -         | C    | C         | C         | C         | C       | C     | -      |
| Совершение покупки                                 | Payment          | -         | C    | C         | C         | C         | C       | C     | -      |
| Запрос возврата средств (своих покупок)            | Payment          | -         | C    | C         | C         | C         | C       | C     | -      |
| Обработка возврата средств (административная)      | Payment/Admin    | -         | -    | -         | -         | -         | X       | M     | -      |
| Просмотр чужих транзакций (админ/поддержка)        | Payment          | -         | -    | -         | -         | -         | R       | R     | -      |
| Управление платежными методами (своими)             | Payment          | -         | M    | M         | M         | M         | M       | M     | -      |
| Управление промокодами/скидками (админ)            | Payment/Admin    | -         | -    | -         | -         | -         | -       | M     | -      |
| **Социальные функции (Social)**                    |                  |           |      |           |           |           |         |       |        |
| Отправка/Принятие запросов в друзья                | Social           | -         | X    | X         | X         | X         | X       | X     | -      |
| Просмотр списка друзей                             | Social           | -         | R    | R         | R         | R         | R       | R     | -      |
| Отправка личных сообщений                          | Social           | -         | C    | C         | C         | C         | C       | C     | -      |
| Создание/Управление своими группами                | Social           | -         | M    | M         | M         | M         | M       | M     | -      |
| Вступление/Выход из публичных групп                | Social           | -         | X    | X         | X         | X         | X       | X     | -      |
| Публикация отзывов/комментариев (к своим играм/контенту)| Social      | -         | C    | C         | C         | C         | C       | C     | -      |
| Модерация отзывов/комментариев/форумов             | Social/Admin     | -         | -    | -         | -         | M         | -       | M     | -      |
| Просмотр форумов                                   | Social           | R         | R    | R         | R         | R         | R       | R     | -      |
| Создание тем/сообщений на форуме                   | Social           | -         | C    | C         | C         | C         | C       | C     | -      |
| **Уведомления (Notifications)**                    |                  |           |      |           |           |           |         |       |        |
| Получение своих уведомлений                        | Notification     | -         | R    | R         | R         | R         | R       | R     | -      |
| Управление своими настройками уведомлений          | Account          | -         | U    | U         | U         | U         | U       | U     | -      |
| Отправка системных/маркетинговых уведомлений       | Notification/Admin| -        | -    | -         | -         | -         | -       | C     | C      |
| **Аналитика (Analytics)**                          |                  |           |      |           |           |           |         |       |        |
| Просмотр своей статистики (разработчик)            | Analytics/Developer| -        | -    | R         | R         | -         | -       | R     | -      |
| Просмотр общей статистики платформы (админ)        | Analytics/Admin  | -         | -    | -         | -         | -         | -       | R     | -      |
| **Администрирование (Admin)**                      |                  |           |      |           |           |           |         |       |        |
| Управление ролями пользователей (админ)            | Auth/Admin       | -         | -    | -         | -         | -         | -       | M     | -      |
| Управление глобальными настройками платформы (админ)| Admin            | -         | -    | -         | -         | -         | -       | M     | -      |
| Просмотр системных логов (админ)                   | Admin            | -         | -    | -         | -         | -         | -       | R     | -      |

**Примечания:**
- Данная матрица является базовой и может быть дополнена более гранулярными разрешениями по мере детализации функциональности каждого сервиса.
- Доступ к ресурсам часто подразумевает доступ к связанным операциям (например, чтение игры включает чтение ее метаданных, управление игрой включает управление ее версиями).
- Роль `system` используется для внутренних операций и не должна назначаться пользователям.
- Роль `admin` имеет максимальные права, но ее использование должно быть ограничено и тщательно аудироваться.
- "Свои" ресурсы означают ресурсы, напрямую принадлежащие или созданные пользователем (например, его профиль, его игры, его отзывы).
- Для ролей `developer` и `publisher` доступ к управлению играми и финансами обычно ограничен теми продуктами и финансовыми данными, которые непосредственно связаны с их аккаунтом разработчика/издателя.

## Принципы управления доступом

1.  **Централизованное управление ролями**: Роли и их базовые разрешения определяются централизованно (например, в Auth Service или Admin Service).
2.  **Децентрализованная проверка прав**: Каждый микросервис отвечает за проверку прав доступа к своим ресурсам на основе информации о роли пользователя, полученной от API Gateway или из токена.
3.  **Принцип наименьших привилегий**: Каждая роль должна иметь только те права, которые необходимы для выполнения ее функций.
4.  **Аудит доступа**: Все операции, связанные с изменением прав доступа и критически важными действиями, должны логироваться для аудита.
5.  **Гибкость**: Система должна позволять администраторам (роль `admin`) создавать кастомные роли и настраивать их разрешения при необходимости (хотя базовые роли должны покрывать 99% случаев).
6.  **Передача информации о ролях**: API Gateway должен извлекать роли пользователя из токена (валидированного через Auth Service) и передавать их внутренним сервисам через безопасные заголовки (например, `X-User-Roles`).

## Заключение

Единый реестр ролей и матрица доступа обеспечивают стандартизированный и согласованный подход к управлению правами пользователей на платформе. Это повышает безопасность, упрощает разработку и поддержку микросервисов. Важно поддерживать эти документы в актуальном состоянии и строго следовать определенным принципам управления доступом при дальнейшей разработке.

# Стандарты Наблюдаемости (Мониторинг, Логирование, Трассировка)

## 1. Введение

Данный документ определяет единые стандарты мониторинга, логирования и трассировки для российского аналога платформы Steam. Цель документа — обеспечить согласованный подход к обеспечению наблюдаемости всех микросервисов платформы, что является критически важным для отладки, анализа производительности и обеспечения отказоустойчивости.

## 2. Стандарты Мониторинга

### 2.1. Инструменты мониторинга
*   **Основной стек**:
    *   Сбор метрик: Prometheus.
    *   Визуализация: Grafana.
    *   Алертинг: Alertmanager.
    *   Хранение долгосрочных метрик: VictoriaMetrics или ClickHouse.
*   **Интеграция с Go**:
    *   Библиотека: `github.com/prometheus/client_golang`.
    *   Экспозиция метрик: HTTP-эндпоинт `/metrics` на отдельном порту (по умолчанию 9090).
    *   Формат метрик: Prometheus Text Format.
*   **Интеграция с PostgreSQL**:
    *   Экспортер: `postgres_exporter`.
    *   Стандартный набор метрик PostgreSQL (connections, transactions, locks, etc.).
    *   Кастомные метрики для специфичных запросов.

### 2.2. Типы метрик

#### 2.2.1. Системные метрики
*   **CPU**: использование, нагрузка.
*   **Память**: использование, swap.
*   **Диск**: использование, IOPS, latency.
*   **Сеть**: трафик, ошибки, latency.
*   **Экспортер**: node_exporter.

#### 2.2.2. Метрики приложения
*   **Счетчики (Counters)**:
    *   `http_requests_total{method="GET", path="/api/v1/games", status="200"}` - общее количество HTTP-запросов.
    *   `db_queries_total{operation="select", table="games"}` - общее количество запросов к БД.
    *   `errors_total{service="catalog", severity="error"}` - общее количество ошибок.
*   **Гистограммы (Histograms)**:
    *   `http_request_duration_seconds{method="GET", path="/api/v1/games"}` - время обработки HTTP-запросов.
    *   `db_query_duration_seconds{operation="select", table="games"}` - время выполнения запросов к БД.
*   **Датчики (Gauges)**:
    *   `active_sessions{service="auth"}` - количество активных сессий.
    *   `queue_size{service="notification", queue="email"}` - размер очереди.
    *   `connection_pool_size{service="catalog", db="postgres"}` - размер пула соединений.

#### 2.2.3. Бизнес-метрики
*   **Пользователи**: `active_users_total`, `new_users_total`.
*   **Игры**: `game_purchases_total{game_id="..."}`, `game_downloads_total{game_id="..."}`.
*   **Платежи**: `payment_amount_total{currency="RUB", status="success"}`, `payment_count_total{payment_method="card", status="success"}`.

### 2.3. Дашборды и алерты

#### 2.3.1. Стандартные дашборды (Grafana)
*   **Системный дашборд**: Общее состояние системы (CPU, память, диск, сеть).
*   **Дашборд микросервиса**: Метрики конкретного микросервиса (запросы, ошибки, latency).
*   **Дашборд базы данных**: Метрики PostgreSQL.
*   **Бизнес-дашборд**: Ключевые бизнес-метрики.

#### 2.3.2. Алерты (Alertmanager)
*   **Критические алерты** (немедленная реакция):
    *   Высокая нагрузка на CPU (>90% в течение 5 минут).
    *   Нехватка памяти (<10% свободной).
    *   Высокий процент ошибок (>5% запросов).
    *   Недоступность сервиса (>30 секунд).
*   **Предупреждающие алерты** (внимание в рабочее время):
    *   Повышенная нагрузка на CPU (>70% в течение 15 минут).
    *   Увеличение времени отклика (>500ms для 95% запросов).
    *   Увеличение количества ошибок (>1% запросов).
*   **Каналы оповещения**: SMS, телефон, мессенджер (Telegram) для критических; Email, мессенджер для предупреждающих.

## 3. Стандарты Логирования

### 3.1. Инструменты логирования
*   **Основной стек**:
    *   Сбор логов: Fluent Bit / Fluentd.
    *   Хранение и анализ: Elasticsearch или ClickHouse.
    *   Визуализация: Kibana или Grafana.
*   **Интеграция с Go**:
    *   Библиотека: `github.com/uber-go/zap` или `github.com/sirupsen/logrus`.
    *   Формат логов: JSON.
    *   Уровни логирования: DEBUG, INFO, WARN, ERROR, FATAL.
*   **Интеграция с PostgreSQL**:
    *   Логирование запросов >100ms.
    *   Логирование всех ошибок.
    *   Формат: JSON или CSV.

### 3.2. Структура логов

#### 3.2.1. Обязательные поля (JSON)
*   `timestamp`: Время события (RFC3339, e.g., `2023-01-01T12:00:00Z`).
*   `level`: Уровень логирования (`debug`, `info`, `warn`, `error`, `fatal`).
*   `service`: Название микросервиса.
*   `instance`: Идентификатор экземпляра (pod name, container id).
*   `message`: Текстовое сообщение.
*   `trace_id`: Идентификатор трассировки.
*   `span_id`: Идентификатор спана.

#### 3.2.2. Дополнительные поля для HTTP-запросов
*   `http.method`, `http.path`, `http.status_code`, `http.user_agent`, `http.request_id`, `http.remote_ip`, `http.duration_ms`.

#### 3.2.3. Дополнительные поля для ошибок
*   `error.message`, `error.stack` (только для DEBUG), `error.code`, `error.context`.

#### 3.2.4. Дополнительные поля для бизнес-событий
*   `user.id`, `user.roles`, `entity.type`, `entity.id`, `action`.

#### 3.2.5. Пример структуры лога
```json
{
  "timestamp": "2023-01-01T12:00:00Z",
  "level": "info",
  "service": "catalog-service",
  "instance": "catalog-service-5d8d9f7b68-2jz9l",
  "message": "Успешная обработка запроса на получение игры",
  "trace_id": "0af7651916cd43dd8448eb211c80319c",
  "span_id": "b7ad6b7169203331",
  "http": {
    "method": "GET",
    "path": "/api/v1/games/123",
    "status_code": 200,
    "duration_ms": 45
  },
  "user": { "id": "user-123" },
  "entity": { "type": "game", "id": "game-123" }
}
```

### 3.3. Политика хранения логов
*   **Оперативные логи**: 7 дней в полном объеме.
*   **Архивные логи**: 90 дней в агрегированном виде.
*   **Логи безопасности**: 1 год.
*   **Логи аудита**: 3 года.

## 4. Стандарты Трассировки

### 4.1. Инструменты трассировки
*   **Основной стек**:
    *   Сбор и визуализация: Jaeger или Zipkin.
    *   Протокол: OpenTelemetry.
*   **Интеграция с Go**:
    *   Библиотека: `go.opentelemetry.io/otel`.
    *   Автоматическая инструментация: для HTTP, gRPC, SQL.
*   **Интеграция с PostgreSQL**:
    *   Библиотека: `github.com/uptrace/opentelemetry-go-extra/otelgorm`.

### 4.2. Структура трассировки
*   **Trace**: Полная трассировка запроса через все сервисы.
*   **Span**: Отдельная операция в рамках трассировки.
*   **SpanContext**: Контекст, передаваемый между сервисами.

#### 4.2.1. Обязательные атрибуты спана
*   `service.name`: Название микросервиса.
*   `service.version`: Версия микросервиса.
*   `operation.name`: Название операции.

#### 4.2.2. Дополнительные атрибуты
*   Для HTTP-запросов: `http.method`, `http.url`, `http.status_code`, `http.user_agent`.
*   Для DB-запросов: `db.system`, `db.name`, `db.statement`, `db.operation`.

### 4.3. Пример инструментации кода
*   (См. пример в исходном документе "Стандарты безопасности, мониторинга, логирования и трассировки.txt", раздел "Стандарты трассировки" -> "Пример инструментации кода"). Код демонстрирует создание спанов с атрибутами для HTTP хендлера и вызова БД.

### 4.4. Политика сэмплирования
*   **Разработка**: 100% запросов.
*   **Тестирование**: 50% запросов.
*   **Продакшен**: 10% запросов по умолчанию, 100% для ошибок.
*   **Специальные случаи**: 100% для критичных операций (платежи, аутентификация).

## 5. Интеграция Компонентов Наблюдаемости

### 5.1. Взаимосвязь логирования и трассировки
*   **Связующие поля**: `trace_id` и `span_id` в каждом логе.
*   **Корреляция**: Возможность перехода от лога к трассировке и обратно.
*   **Библиотека для Go**: `go.opentelemetry.io/otel/exporters/stdout/stdouttrace` (для примера, обычно экспорт в Jaeger/Zipkin).

### 5.2. Взаимосвязь мониторинга и трассировки
*   **Exemplars**: Связь метрик (Prometheus) с трассировками.
*   **Библиотека для Go**: `go.opentelemetry.io/otel/exporters/prometheus`.

### 5.3. Взаимосвязь безопасности и логирования
*   **Аудит**: Логирование всех событий безопасности (см. Стандарты Безопасности).
*   **Алерты**: Генерация алертов на основе логов безопасности.
*   **SIEM**: Интеграция логов с системой управления информационной безопасностью.

### 5.4. Централизованное управление
*   **Конфигурация**: Централизованное управление конфигурацией через ConfigMap в Kubernetes.
*   **Обновление**: Возможность обновления конфигурации без перезапуска сервисов.
*   **Мониторинг компонентов**: Отдельные дашборды для мониторинга систем логирования, трассировки.

---
*Разделы "Стандарты мониторинга", "Стандарты логирования", "Стандарты трассировки" и "Интеграция компонентов" извлечены и адаптированы из документа "(Дополнительный фаил) Стандарты безопасности, мониторинга, логирования и трассировки.txt".*
*Этот документ должен регулярно обновляться и дополняться.*
